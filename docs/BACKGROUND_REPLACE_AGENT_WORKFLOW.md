# ğŸ¬ AI èƒŒæ™¯æ›¿æ¢ Agent Workflow è®¾è®¡æ–‡æ¡£

> **æ ¸å¿ƒç›®æ ‡**: é«˜è¿˜åŸåº¦çš„è§†é¢‘èƒŒæ™¯æ›¿æ¢ï¼Œè®©è§‚ä¼—å®Œå…¨çœ‹ä¸å‡ºæ˜¯ AI ç”Ÿæˆçš„

## 1. æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           Background Replace Agent Workflow                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Stage 1 â”‚â”€â”€â”€â–¶â”‚  Stage 2 â”‚â”€â”€â”€â–¶â”‚  Stage 3 â”‚â”€â”€â”€â–¶â”‚  Stage 4 â”‚â”€â”€â”€â–¶â”‚  Stage 5 â”‚  â”‚
â”‚  â”‚ è§†é¢‘åˆ†æ â”‚    â”‚ å‰æ™¯åˆ†ç¦» â”‚    â”‚ èƒŒæ™¯ç”Ÿæˆ â”‚    â”‚ æ™ºèƒ½åˆæˆ â”‚    â”‚ è´¨é‡å¢å¼º â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚       â”‚               â”‚               â”‚               â”‚               â”‚         â”‚
â”‚       â–¼               â–¼               â–¼               â–¼               â–¼         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ åœºæ™¯ç†è§£ â”‚    â”‚ äººç‰©æŠ åƒ â”‚    â”‚ å›¾ç”Ÿè§†é¢‘ â”‚    â”‚ å…‰å½±åŒ¹é… â”‚    â”‚ æ—¶åºä¸€è‡´ â”‚  â”‚
â”‚  â”‚ å…‰çº¿åˆ†æ â”‚    â”‚ Alphaæå–â”‚    â”‚ è¿åŠ¨åŒ¹é… â”‚    â”‚ è¾¹ç¼˜èåˆ â”‚    â”‚ é—ªçƒä¿®å¤ â”‚  â”‚
â”‚  â”‚ è¿åŠ¨æ£€æµ‹ â”‚    â”‚ è¾¹ç¼˜ä¼˜åŒ– â”‚    â”‚ é€è§†åŒ¹é… â”‚    â”‚ é˜´å½±ç”Ÿæˆ â”‚    â”‚ è¶…åˆ†è¾¨ç‡ â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2. äº”é˜¶æ®µè¯¦ç»†è®¾è®¡

### Stage 1: è§†é¢‘æ™ºèƒ½åˆ†æ (Video Intelligence)

**ç›®æ ‡**: æ·±åº¦ç†è§£åŸè§†é¢‘çš„æ‰€æœ‰ç‰¹å¾ï¼Œä¸ºåç»­å¤„ç†æä¾›ç²¾ç¡®å‚æ•°

```python
class VideoAnalysisAgent:
    """
    è§†é¢‘åˆ†æ Agent
    è¾“å‡º: å®Œæ•´çš„è§†é¢‘ç‰¹å¾æŠ¥å‘Šï¼ŒæŒ‡å¯¼åç»­æ‰€æœ‰é˜¶æ®µ
    """
    
    async def analyze(self, video_url: str, clip_info: ClipInfo) -> VideoAnalysisReport:
        # 1. åœºæ™¯æ£€æµ‹
        scene_info = await self._detect_scene()
        
        # 2. å…‰çº¿åˆ†æ
        lighting_info = await self._analyze_lighting()
        
        # 3. æ‘„åƒæœºè¿åŠ¨åˆ†æ
        camera_motion = await self._analyze_camera_motion()
        
        # 4. ä¸»ä½“æ£€æµ‹ä¸è¿½è¸ª
        subject_tracking = await self._track_subject()
        
        # 5. æ·±åº¦ä¼°è®¡
        depth_map = await self._estimate_depth()
        
        return VideoAnalysisReport(
            scene=scene_info,
            lighting=lighting_info,
            camera_motion=camera_motion,
            subject_tracking=subject_tracking,
            depth_map=depth_map,
        )
```

**åˆ†æç»´åº¦**:

| ç»´åº¦ | åˆ†æå†…å®¹ | è¾“å‡º |
|------|---------|------|
| åœºæ™¯ç†è§£ | å®¤å†…/å®¤å¤–ã€åœºæ™¯ç±»å‹ã€ç¯å¢ƒç‰¹å¾ | `SceneInfo` |
| å…‰çº¿åˆ†æ | ä¸»å…‰æºæ–¹å‘ã€è‰²æ¸©ã€å¯¹æ¯”åº¦ã€é˜´å½±æ–¹å‘ | `LightingInfo` |
| æ‘„åƒæœºè¿åŠ¨ | å¹³ç§»/æ¨æ‹‰/æ—‹è½¬ã€è¿åŠ¨æ›²çº¿ã€ç¨³å®šæ€§ | `CameraMotion` |
| ä¸»ä½“è¿½è¸ª | äººç‰©è¾¹ç•Œæ¡†ã€å…³é”®ç‚¹ã€è¿åŠ¨è½¨è¿¹ | `SubjectTracking` |
| æ·±åº¦ä¼°è®¡ | å‰æ™¯/èƒŒæ™¯åˆ†ç¦»é¢ã€ç›¸å¯¹æ·±åº¦å›¾ | `DepthMap` |

---

### Stage 2: é«˜ç²¾åº¦å‰æ™¯åˆ†ç¦» (Foreground Separation)

**ç›®æ ‡**: åƒç´ çº§ç²¾ç¡®æå–äººç‰©ï¼ŒåŒ…æ‹¬å¤´å‘ä¸ã€åŠé€æ˜åŒºåŸŸ

```python
class ForegroundSeparationAgent:
    """
    å‰æ™¯åˆ†ç¦» Agent
    æ ¸å¿ƒæŠ€æœ¯: SAM2 + Matting + Temporal Consistency
    """
    
    async def separate(
        self, 
        video_url: str,
        analysis: VideoAnalysisReport
    ) -> ForegroundResult:
        # 1. é€å¸§äººç‰©åˆ†å‰² (SAM2)
        masks = await self._segment_person_all_frames()
        
        # 2. é«˜è´¨é‡ Alpha Matting (å¤´å‘ã€è¾¹ç¼˜)
        alpha_mattes = await self._refine_alpha_matting(masks)
        
        # 3. æ—¶åºä¸€è‡´æ€§ä¼˜åŒ–
        consistent_mattes = await self._ensure_temporal_consistency(alpha_mattes)
        
        # 4. è¾¹ç¼˜ä¼˜åŒ– (å»é™¤ç»¿è¾¹ã€å…‰æ™•)
        final_mattes = await self._optimize_edges(consistent_mattes)
        
        return ForegroundResult(
            foreground_frames=foreground_frames,
            alpha_mattes=final_mattes,
            edge_maps=edge_maps,
        )
```

**å…³é”®æŠ€æœ¯**:

| æŠ€æœ¯ | ä½œç”¨ | API/æ¨¡å‹ |
|------|------|---------|
| SAM2 | å®ä¾‹åˆ†å‰²ï¼Œæå–äººç‰©è½®å»“ | Meta SAM2 / GroundingDINO |
| Video Matting | å¤„ç†å¤´å‘ã€åŠé€æ˜åŒºåŸŸ | RobustVideoMatting / Rembg |
| Temporal Propagation | å¸§é—´ä¸€è‡´æ€§ï¼Œé¿å…é—ªçƒ | å…‰æµä¼ æ’­ + æ—¶åºå¹³æ»‘ |
| Edge Refinement | è¾¹ç¼˜å»å™ªã€ç¾½åŒ– | Guided Filter / Trimap |

**è¾“å‡ºè´¨é‡æ ‡å‡†**:
- Alpha ç²¾åº¦: 256 çº§ç°åº¦ï¼Œäºšåƒç´ è¾¹ç¼˜
- å¤´å‘ç»†èŠ‚: ä¿ç•™ 95% ä»¥ä¸Šå‘ä¸
- æ—¶åºç¨³å®š: ç›¸é‚»å¸§ alpha å·®å¼‚ < 2%

---

### Stage 3: èƒŒæ™¯è§†é¢‘ç”Ÿæˆ (Background Video Generation)

**ç›®æ ‡**: å°†ç”¨æˆ·ç¡®è®¤çš„é™æ€èƒŒæ™¯è½¬æ¢ä¸ºä¸åŸè§†é¢‘æ—¶é•¿ã€è¿åŠ¨åŒ¹é…çš„åŠ¨æ€è§†é¢‘

```python
class BackgroundVideoAgent:
    """
    èƒŒæ™¯è§†é¢‘ç”Ÿæˆ Agent
    æ ¸å¿ƒ: ä¿æŒæ—¶ç©ºä¸€è‡´æ€§çš„å›¾ç”Ÿè§†é¢‘
    """
    
    async def generate(
        self,
        background_image: str,      # ç”¨æˆ·ç¡®è®¤çš„èƒŒæ™¯å›¾
        analysis: VideoAnalysisReport,
        target_duration: float,     # ç›®æ ‡æ—¶é•¿ï¼ˆç§’ï¼‰
    ) -> BackgroundVideoResult:
        
        # 1. åˆ†æéœ€è¦çš„æ‘„åƒæœºè¿åŠ¨
        camera_motion = self._plan_camera_motion(analysis.camera_motion)
        
        # 2. ç”ŸæˆèƒŒæ™¯è§†é¢‘ï¼ˆåˆ†æ®µç”Ÿæˆ + æ‹¼æ¥ï¼‰
        segments = []
        for segment in self._plan_segments(target_duration):
            video_segment = await self._generate_segment(
                image=background_image,
                motion=camera_motion,
                duration=segment.duration,
                seed=segment.seed,  # ä¿æŒä¸€è‡´æ€§
            )
            segments.append(video_segment)
        
        # 3. æ— ç¼æ‹¼æ¥
        background_video = await self._seamless_stitch(segments)
        
        # 4. æ—¶é•¿ç²¾ç¡®åŒ¹é…ï¼ˆå˜é€Ÿ/è¡¥å¸§ï¼‰
        final_video = await self._match_duration(
            video=background_video,
            target_duration=target_duration,
            target_fps=analysis.fps
        )
        
        return BackgroundVideoResult(
            video_url=final_video,
            duration=target_duration,
            motion_data=camera_motion,
        )
```

**å›¾ç”Ÿè§†é¢‘ç­–ç•¥**:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    èƒŒæ™¯è§†é¢‘ç”Ÿæˆç­–ç•¥                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  æƒ…å†µ 1: é™æ€èƒŒæ™¯ (æ— æ‘„åƒæœºè¿åŠ¨)                                 â”‚
â”‚  â”œâ”€ ç­–ç•¥: æ·»åŠ å¾®å¦™çš„ç¯å¢ƒåŠ¨æ•ˆï¼ˆäº‘é£˜åŠ¨ã€å…‰å½±å˜åŒ–ã€æ ‘å¶æ‘‡æ›³ï¼‰        â”‚
â”‚  â””â”€ å·¥å…·: Kling image2video + subtle motion prompt              â”‚
â”‚                                                                 â”‚
â”‚  æƒ…å†µ 2: åŠ¨æ€èƒŒæ™¯ (æœ‰æ‘„åƒæœºè¿åŠ¨)                                 â”‚
â”‚  â”œâ”€ ç­–ç•¥: åŒ¹é…åŸå§‹è¿åŠ¨æ›²çº¿ç”ŸæˆèƒŒæ™¯è¿åŠ¨                           â”‚
â”‚  â”œâ”€ åˆ†æ: æå–åŸè§†é¢‘çš„è¿åŠ¨å‘é‡                                   â”‚
â”‚  â””â”€ å·¥å…·: Kling image2video + camera motion matching            â”‚
â”‚                                                                 â”‚
â”‚  æƒ…å†µ 3: é•¿è§†é¢‘ (>10ç§’)                                         â”‚
â”‚  â”œâ”€ ç­–ç•¥: åˆ†æ®µç”Ÿæˆ + æ— ç¼æ‹¼æ¥                                    â”‚
â”‚  â”œâ”€ æ¯æ®µ: 5ç§’ï¼Œé‡å  0.5ç§’ç”¨äºèåˆ                                â”‚
â”‚  â””â”€ å·¥å…·: å¤šæ¬¡ API è°ƒç”¨ + temporal blending                     â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### Stage 4: æ™ºèƒ½åˆæˆ (Intelligent Compositing)

**ç›®æ ‡**: å°†å‰æ™¯äººç‰©ä¸æ–°èƒŒæ™¯å®Œç¾èåˆï¼Œå®ç°å…‰å½±åŒ¹é…ã€è‡ªç„¶è¿‡æ¸¡

```python
class IntelligentCompositingAgent:
    """
    æ™ºèƒ½åˆæˆ Agent
    æ ¸å¿ƒ: å…‰å½±ä¸€è‡´æ€§ + è¾¹ç¼˜èåˆ + é˜´å½±ç”Ÿæˆ
    """
    
    async def composite(
        self,
        foreground: ForegroundResult,
        background: BackgroundVideoResult,
        analysis: VideoAnalysisReport,
    ) -> CompositeResult:
        
        # 1. å…‰çº¿è°ƒå’Œ (Relighting)
        relit_foreground = await self._relight_foreground(
            foreground=foreground,
            target_lighting=self._analyze_bg_lighting(background),
        )
        
        # 2. é¢œè‰²åŒ¹é… (Color Grading)
        color_matched = await self._match_color_grade(
            foreground=relit_foreground,
            background=background,
        )
        
        # 3. é˜´å½±ç”Ÿæˆ (Shadow Generation)
        shadows = await self._generate_shadows(
            foreground=color_matched,
            lighting=analysis.lighting,
        )
        
        # 4. è¾¹ç¼˜èåˆ (Edge Blending)
        blended = await self._blend_edges(
            foreground=color_matched,
            background=background,
            alpha=foreground.alpha_mattes,
            blend_width=3,  # 3åƒç´ ç¾½åŒ–
        )
        
        # 5. æœ€ç»ˆåˆæˆ
        composite = await self._final_composite(
            layers=[background, shadows, blended],
        )
        
        return CompositeResult(video_url=composite)
```

**åˆæˆæŠ€æœ¯è¯¦è§£**:

#### 4.1 å…‰çº¿è°ƒå’Œ (Relighting)

```python
async def _relight_foreground(self, foreground, target_lighting):
    """
    æ ¹æ®æ–°èƒŒæ™¯çš„å…‰çº¿æ¡ä»¶ï¼Œè°ƒæ•´å‰æ™¯äººç‰©çš„å…‰å½±
    
    æŠ€æœ¯: 
    - ç¯å¢ƒå…‰ä¼°è®¡ (Ambient Occlusion)
    - å…‰æºæ–¹å‘è°ƒæ•´ (Spherical Harmonics)
    - é«˜å…‰/é˜´å½±é‡æ˜ å°„
    """
    # åˆ†æç›®æ ‡å…‰çº¿
    light_direction = target_lighting.direction  # å¦‚: å·¦ä¸Š 45Â°
    light_color = target_lighting.color_temperature  # å¦‚: 5500K
    light_intensity = target_lighting.intensity  # å¦‚: 0.8
    
    # ä½¿ç”¨ AI è¿›è¡Œ relighting
    relit = await self.relight_model.process(
        image=foreground,
        target_direction=light_direction,
        target_color=light_color,
    )
    
    return relit
```

#### 4.2 é¢œè‰²åŒ¹é… (Color Matching)

```python
async def _match_color_grade(self, foreground, background):
    """
    ä½¿å‰æ™¯çš„è‰²è°ƒä¸èƒŒæ™¯åè°ƒä¸€è‡´
    
    æŠ€æœ¯:
    - ç›´æ–¹å›¾åŒ¹é…
    - è‰²å½©è¿ç§» (Color Transfer)
    - LUT åº”ç”¨
    """
    # æå–èƒŒæ™¯çš„è‰²å½©åˆ†å¸ƒ
    bg_histogram = self._extract_color_histogram(background)
    bg_dominant_colors = self._get_dominant_colors(background)
    
    # å¾®è°ƒå‰æ™¯è‰²å½©
    matched = self._apply_color_transfer(
        source=foreground,
        target_histogram=bg_histogram,
        strength=0.3,  # 30% å¼ºåº¦ï¼Œä¿æŒè‡ªç„¶
    )
    
    return matched
```

#### 4.3 é˜´å½±ç”Ÿæˆ (Shadow Generation)

```python
async def _generate_shadows(self, foreground, lighting):
    """
    ä¸ºå‰æ™¯äººç‰©ç”Ÿæˆè‡ªç„¶çš„æŠ•å½±é˜´å½±
    
    å…³é”®: é˜´å½±æ–¹å‘ã€æŸ”å’Œåº¦ã€é€æ˜åº¦å¿…é¡»ä¸å…‰æºåŒ¹é…
    """
    # è®¡ç®—é˜´å½±å‚æ•°
    shadow_direction = self._calculate_shadow_direction(lighting.direction)
    shadow_softness = self._calculate_shadow_softness(lighting.type)  # ç¡¬å…‰/æŸ”å…‰
    shadow_opacity = 0.3  # 30% é€æ˜åº¦ï¼Œè‡ªç„¶ä¸çªå…€
    
    # ç”Ÿæˆé˜´å½±å±‚
    shadow_layer = await self.shadow_generator.generate(
        silhouette=foreground.alpha_mattes,
        direction=shadow_direction,
        blur=shadow_softness,
        opacity=shadow_opacity,
    )
    
    return shadow_layer
```

#### 4.4 è¾¹ç¼˜èåˆ (Edge Blending)

```python
async def _blend_edges(self, foreground, background, alpha, blend_width=3):
    """
    å¤„ç†å‰æ™¯è¾¹ç¼˜ï¼Œæ¶ˆé™¤ç¡¬åˆ‡è¾¹ã€ç»¿è¾¹ã€å…‰æ™•
    
    æŠ€æœ¯:
    - Alpha é¢„ä¹˜ (Premultiplied Alpha)
    - è¾¹ç¼˜ç¾½åŒ– (Edge Feathering)  
    - é¢œè‰²æº¢å‡ºæŠ‘åˆ¶ (Spill Suppression)
    """
    # 1. å¤„ç†é¢œè‰²æº¢å‡ºï¼ˆå¦‚æœåŸèƒŒæ™¯æ˜¯ç»¿å¹•ï¼‰
    despilled = self._remove_color_spill(foreground, spill_color="green")
    
    # 2. Alpha é¢„ä¹˜ï¼Œé¿å…è¾¹ç¼˜å‘ç™½
    premultiplied = self._premultiply_alpha(despilled, alpha)
    
    # 3. è¾¹ç¼˜ç¾½åŒ–
    feathered_alpha = self._feather_edge(alpha, radius=blend_width)
    
    # 4. æœ€ç»ˆåˆæˆ
    result = background * (1 - feathered_alpha) + premultiplied
    
    return result
```

---

### Stage 5: è´¨é‡å¢å¼º (Quality Enhancement)

**ç›®æ ‡**: æ¶ˆé™¤ AI ç—•è¿¹ï¼Œè¾¾åˆ°ä¸“ä¸šçº§è¾“å‡ºè´¨é‡

```python
class QualityEnhancementAgent:
    """
    è´¨é‡å¢å¼º Agent
    æœ€åé˜²çº¿: ç¡®ä¿æ—  AI ç—•è¿¹
    """
    
    async def enhance(
        self,
        composite: CompositeResult,
        analysis: VideoAnalysisReport,
    ) -> FinalResult:
        
        # 1. æ—¶åºä¸€è‡´æ€§æ£€æŸ¥ä¸ä¿®å¤
        temporal_fixed = await self._fix_temporal_issues(composite)
        
        # 2. é—ªçƒæ£€æµ‹ä¸ä¿®å¤
        deflickered = await self._deflicker(temporal_fixed)
        
        # 3. AI ç—•è¿¹æ£€æµ‹ä¸ä¿®å¤
        artifact_fixed = await self._fix_ai_artifacts(deflickered)
        
        # 4. è¶…åˆ†è¾¨ç‡å¢å¼ºï¼ˆå¯é€‰ï¼‰
        if analysis.resolution < 1080:
            enhanced = await self._upscale(artifact_fixed, target_resolution=1080)
        else:
            enhanced = artifact_fixed
        
        # 5. æœ€ç»ˆç¼–ç 
        final = await self._encode_final(
            video=enhanced,
            codec="h264",
            quality="high",
            fps=analysis.fps,
        )
        
        # 6. è´¨é‡éªŒè¯
        qa_result = await self._quality_assurance(final)
        
        return FinalResult(
            video_url=final,
            qa_report=qa_result,
        )
```

**è´¨é‡æ£€æŸ¥æ¸…å•**:

| æ£€æŸ¥é¡¹ | é˜ˆå€¼ | ä¿®å¤æ–¹æ³• |
|--------|------|---------|
| å¸§é—´é—ªçƒ | SSIM > 0.95 | æ—¶åºå¹³æ»‘æ»¤æ³¢ |
| è¾¹ç¼˜é”¯é½¿ | æ— å¯è§é”¯é½¿ | æŠ—é”¯é½¿æ»¤æ³¢ |
| é¢œè‰²æ–­å±‚ | æ¸å˜å¹³æ»‘ | è‰²å¸¦æ¶ˆé™¤ |
| Alpha æŠ–åŠ¨ | ç¨³å®šåº¦ > 98% | æ—¶åº alpha å¹³æ»‘ |
| å…‰å½±è·³å˜ | æ— çªå˜ | å…‰ç…§æ›²çº¿å¹³æ»‘ |

---

## 3. æ•°æ®æµè®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              å®Œæ•´æ•°æ®æµ                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚  è¾“å…¥                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ â€¢ clip_id: ç›®æ ‡è§†é¢‘ç‰‡æ®µ ID                                       â”‚           â”‚
â”‚  â”‚ â€¢ video_url: åŸå§‹è§†é¢‘ URL                                        â”‚           â”‚
â”‚  â”‚ â€¢ background_image: ç”¨æˆ·ç¡®è®¤çš„æ–°èƒŒæ™¯å›¾ç‰‡                          â”‚           â”‚
â”‚  â”‚ â€¢ prompt: ç”¨æˆ·æè¿°ï¼ˆå¯é€‰ï¼Œç”¨äºå¢å¼ºï¼‰                               â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  Stage 1: è§†é¢‘åˆ†æ                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ è¾“å‡º:                                                            â”‚           â”‚
â”‚  â”‚ â€¢ scene_info: {type: "indoor", environment: "office"}            â”‚           â”‚
â”‚  â”‚ â€¢ lighting: {direction: [0.5, 0.8, 0.3], temp: 5500K}            â”‚           â”‚
â”‚  â”‚ â€¢ camera_motion: {type: "static", shake: 0.02}                   â”‚           â”‚
â”‚  â”‚ â€¢ subject_bbox: [[x, y, w, h], ...] (æ¯å¸§)                       â”‚           â”‚
â”‚  â”‚ â€¢ depth_map: ç›¸å¯¹æ·±åº¦å›¾åºåˆ—                                       â”‚           â”‚
â”‚  â”‚ â€¢ fps: 30, duration: 5.2s, resolution: 1920x1080                 â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  Stage 2: å‰æ™¯åˆ†ç¦»                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ è¾“å‡º:                                                            â”‚           â”‚
â”‚  â”‚ â€¢ foreground_frames: RGBA åºåˆ—ï¼ˆå«é€æ˜é€šé“ï¼‰                      â”‚           â”‚
â”‚  â”‚ â€¢ alpha_mattes: é«˜ç²¾åº¦ alpha é€šé“åºåˆ—                            â”‚           â”‚
â”‚  â”‚ â€¢ edge_confidence: è¾¹ç¼˜ç½®ä¿¡åº¦å›¾                                   â”‚           â”‚
â”‚  â”‚ â€¢ hair_mattes: å¤´å‘åŒºåŸŸç²¾ç»† alpha                                 â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  Stage 3: èƒŒæ™¯ç”Ÿæˆ                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ è¾“å‡º:                                                            â”‚           â”‚
â”‚  â”‚ â€¢ background_video: ä¸åŸè§†é¢‘åŒæ—¶é•¿çš„èƒŒæ™¯è§†é¢‘                      â”‚           â”‚
â”‚  â”‚ â€¢ motion_vectors: è¿åŠ¨å‘é‡ï¼ˆç”¨äºåˆæˆæ—¶å¯¹é½ï¼‰                       â”‚           â”‚
â”‚  â”‚ â€¢ lighting_map: èƒŒæ™¯å…‰ç…§ä¿¡æ¯                                      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  Stage 4: æ™ºèƒ½åˆæˆ                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ è¾“å‡º:                                                            â”‚           â”‚
â”‚  â”‚ â€¢ composite_video: åˆæˆåçš„å®Œæ•´è§†é¢‘                               â”‚           â”‚
â”‚  â”‚ â€¢ blend_mask: èåˆåŒºåŸŸè’™ç‰ˆ                                        â”‚           â”‚
â”‚  â”‚ â€¢ shadow_layer: ç”Ÿæˆçš„é˜´å½±å±‚                                      â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  Stage 5: è´¨é‡å¢å¼º                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ è¾“å‡º:                                                            â”‚           â”‚
â”‚  â”‚ â€¢ final_video_url: æœ€ç»ˆè§†é¢‘ URL                                   â”‚           â”‚
â”‚  â”‚ â€¢ qa_report: {flicker_score: 0.98, edge_score: 0.95, ...}        â”‚           â”‚
â”‚  â”‚ â€¢ thumbnail: æ–°çš„ç¼©ç•¥å›¾                                           â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                    â”‚                                            â”‚
â”‚                                    â–¼                                            â”‚
â”‚  è¾“å‡º                                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ â€¢ æ›´æ–° clips è¡¨: asset_id, cached_url, thumbnail                 â”‚           â”‚
â”‚  â”‚ â€¢ è§¦å‘å‰ç«¯åˆ·æ–°                                                    â”‚           â”‚
â”‚  â”‚ â€¢ SSE é€šçŸ¥: task completed                                       â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. API/æ¨¡å‹é€‰å‹

### 4.1 å‰æ™¯åˆ†ç¦»æŠ€æœ¯æ ˆ

| åŠŸèƒ½ | é¦–é€‰æ–¹æ¡ˆ | å¤‡é€‰æ–¹æ¡ˆ | è¯´æ˜ |
|------|---------|---------|------|
| äººç‰©åˆ†å‰² | SAM2 (Meta) | GroundingDINO + SAM | è§†é¢‘çº§åˆ†å‰²ï¼Œæ—¶åºä¸€è‡´ |
| Alpha Matting | RobustVideoMatting | MODNet / BackgroundMattingV2 | ä¸“ä¸šçº§ matting |
| è¾¹ç¼˜ä¼˜åŒ– | Guided Filter | KNN Matting | ç²¾ç»†è¾¹ç¼˜å¤„ç† |

### 4.2 èƒŒæ™¯è§†é¢‘ç”Ÿæˆ

| åŠŸèƒ½ | é¦–é€‰æ–¹æ¡ˆ | å¤‡é€‰æ–¹æ¡ˆ | è¯´æ˜ |
|------|---------|---------|------|
| å›¾ç”Ÿè§†é¢‘ | Kling image2video | Runway Gen-3 / Pika | 5ç§’é«˜è´¨é‡è§†é¢‘ |
| è¿åŠ¨æ§åˆ¶ | Kling Motion Brush | AnimateDiff | æ§åˆ¶æ‘„åƒæœºè¿åŠ¨ |
| è§†é¢‘æ‹¼æ¥ | FFmpeg + äº¤å‰æ·¡å…¥æ·¡å‡º | è‡ªç ”æ—¶åºèåˆ | æ— ç¼æ‹¼æ¥ |

### 4.3 åˆæˆä¸å¢å¼º

| åŠŸèƒ½ | é¦–é€‰æ–¹æ¡ˆ | å¤‡é€‰æ–¹æ¡ˆ | è¯´æ˜ |
|------|---------|---------|------|
| Relighting | IC-Light | DiffusionLight | å…‰çº¿é‡æ‰“å…‰ |
| é¢œè‰²åŒ¹é… | Neural Color Transfer | ä¼ ç»Ÿç›´æ–¹å›¾åŒ¹é… | è‰²å½©åè°ƒ |
| å»é—ªçƒ | DeFlicker | RIFE + æ—¶åºå¹³æ»‘ | æ¶ˆé™¤å¸§é—´é—ªçƒ |
| è¶…åˆ†è¾¨ç‡ | Real-ESRGAN Video | BSRGAN | ç”»è´¨æå‡ |

---

## 5. ä»»åŠ¡è°ƒåº¦ä¸è¿›åº¦

### 5.1 ä»»åŠ¡çŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  created   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
      â”‚                                                              â”‚
      â–¼                                                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚ analyzing  â”‚â”€â”€â”€â–¶â”‚ separating â”‚â”€â”€â”€â–¶â”‚ generating â”‚â”€â”€â”€â–¶â”‚ compositingâ”‚â”‚
â”‚   (10%)    â”‚    â”‚   (30%)    â”‚    â”‚   (60%)    â”‚    â”‚    (80%)   â”‚â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                                                            â”‚        â”‚
                                                            â–¼        â”‚
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
                                     â”‚  completed â”‚â—€â”€â”€â”€â”‚  enhancing â”‚â”‚
                                     â”‚   (100%)   â”‚    â”‚    (95%)   â”‚â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
                                           â”‚                         â”‚
                                           â–¼                         â”‚
                                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
                                     â”‚   failed   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   (ä»»ä½•é˜¶æ®µå¤±è´¥)
```

### 5.2 è¿›åº¦æ±‡æŠ¥

```python
# SSE äº‹ä»¶æ ¼å¼
{
    "task_id": "bg-replace-xxxx",
    "event_type": "progress",
    "stage": "separating",
    "stage_progress": 65,      # å½“å‰é˜¶æ®µè¿›åº¦
    "overall_progress": 35,    # æ€»ä½“è¿›åº¦
    "message": "æ­£åœ¨æå–äººç‰©è¾¹ç¼˜...",
    "eta_seconds": 120,        # é¢„è®¡å‰©ä½™æ—¶é—´
}
```

---

## 6. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 6.1 å¹¶è¡Œå¤„ç†

```python
# é˜¶æ®µå†…å¹¶è¡Œ
async def _separate_frames_parallel(self, frames: List[Frame]) -> List[Alpha]:
    """å¹¶è¡Œå¤„ç†å¤šå¸§ï¼Œå……åˆ†åˆ©ç”¨ GPU"""
    batch_size = 8  # æ ¹æ®æ˜¾å­˜è°ƒæ•´
    results = []
    
    for batch in chunked(frames, batch_size):
        # æ‰¹é‡æ¨ç†
        batch_results = await self.model.batch_inference(batch)
        results.extend(batch_results)
    
    return results
```

### 6.2 ç¼“å­˜ç­–ç•¥

```python
# ä¸­é—´ç»“æœç¼“å­˜ï¼Œæ”¯æŒæ–­ç‚¹ç»­ä¼ 
@cached(ttl=3600)
async def get_analysis_result(self, video_hash: str) -> VideoAnalysisReport:
    """åˆ†æç»“æœç¼“å­˜ï¼Œç›¸åŒè§†é¢‘æ— éœ€é‡å¤åˆ†æ"""
    ...

# æ¨¡å‹é¢„çƒ­
await model_pool.warmup(["sam2", "rvm", "kling"])
```

### 6.3 èµ„æºç®¡ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GPU èµ„æºåˆ†é…                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Stage 1 (åˆ†æ):     1 GPU,  ~10 ç§’                              â”‚
â”‚ Stage 2 (åˆ†ç¦»):     2 GPU,  ~30 ç§’ (å¯å¹¶è¡Œ)                     â”‚
â”‚ Stage 3 (ç”Ÿæˆ):     API è°ƒç”¨, ~60-120 ç§’ (Kling)                â”‚
â”‚ Stage 4 (åˆæˆ):     1 GPU,  ~20 ç§’                              â”‚
â”‚ Stage 5 (å¢å¼º):     1 GPU,  ~15 ç§’                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ€»è®¡: çº¦ 2-4 åˆ†é’Ÿ (5ç§’è§†é¢‘)                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. è´¨é‡ä¿è¯

### 7.1 è‡ªåŠ¨è´¨é‡æ£€æµ‹

```python
class QualityChecker:
    """è‡ªåŠ¨è´¨é‡æ£€æµ‹å™¨"""
    
    def check(self, video: Video) -> QAReport:
        checks = [
            self._check_temporal_consistency(),  # æ—¶åºä¸€è‡´æ€§
            self._check_edge_quality(),          # è¾¹ç¼˜è´¨é‡
            self._check_color_consistency(),     # é¢œè‰²ä¸€è‡´æ€§
            self._check_lighting_match(),        # å…‰ç…§åŒ¹é…åº¦
            self._check_flicker(),               # é—ªçƒæ£€æµ‹
            self._check_artifacts(),             # AI ç—•è¿¹æ£€æµ‹
        ]
        
        return QAReport(
            overall_score=mean([c.score for c in checks]),
            details=checks,
            pass_threshold=0.85,  # 85åˆ†åŠæ ¼
        )
```

### 7.2 è´¨é‡ä¸è¾¾æ ‡æ—¶çš„å¤„ç†

```python
if qa_report.overall_score < 0.85:
    # å°è¯•è‡ªåŠ¨ä¿®å¤
    fixed_video = await self._auto_fix(video, qa_report.issues)
    
    # é‡æ–°æ£€æµ‹
    new_qa = self.checker.check(fixed_video)
    
    if new_qa.overall_score < 0.85:
        # ä»ä¸è¾¾æ ‡ï¼Œè¿”å›è­¦å‘Šä½†ä¸é˜»æ–­
        return FinalResult(
            video_url=fixed_video,
            warning="è§†é¢‘è´¨é‡å¯èƒ½å­˜åœ¨è½»å¾®ç‘•ç–µ",
            qa_report=new_qa,
        )
```

---

## 8. é”™è¯¯å¤„ç†ä¸æ¢å¤

```python
class BackgroundReplaceWorkflow:
    """ä¸»å·¥ä½œæµï¼ŒåŒ…å«å®Œæ•´çš„é”™è¯¯å¤„ç†"""
    
    async def execute(self, task: BackgroundReplaceTask) -> WorkflowResult:
        checkpoint = await self._load_checkpoint(task.id)
        
        try:
            # Stage 1: åˆ†æ
            if checkpoint.stage < 1:
                analysis = await self.analyze_agent.analyze(task.video_url)
                await self._save_checkpoint(task.id, 1, {"analysis": analysis})
            else:
                analysis = checkpoint.data["analysis"]
            
            # Stage 2: åˆ†ç¦»
            if checkpoint.stage < 2:
                foreground = await self.separation_agent.separate(task.video_url, analysis)
                await self._save_checkpoint(task.id, 2, {"foreground": foreground})
            else:
                foreground = checkpoint.data["foreground"]
            
            # ... åç»­é˜¶æ®µç±»ä¼¼
            
        except RetryableError as e:
            # å¯é‡è¯•é”™è¯¯
            await self._schedule_retry(task, delay=30)
            raise
            
        except NonRetryableError as e:
            # ä¸å¯é‡è¯•é”™è¯¯
            await self._mark_failed(task, str(e))
            raise
            
        finally:
            # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
            await self._cleanup_temp_files(task.id)
```

---

## 9. å®ç°è·¯çº¿å›¾

### Phase 1: MVP (2å‘¨)
- [x] åŸºç¡€å·¥ä½œæµæ¡†æ¶
- [ ] SAM2 äººç‰©åˆ†å‰²é›†æˆ
- [ ] Kling image2video è°ƒç”¨
- [ ] åŸºç¡€ Alpha åˆæˆ
- [ ] SSE è¿›åº¦æ¨é€

### Phase 2: è´¨é‡æå‡ (2å‘¨)
- [ ] RobustVideoMatting é›†æˆ
- [ ] è¾¹ç¼˜ç¾½åŒ–ä¼˜åŒ–
- [ ] å…‰çº¿è°ƒå’Œ (Relighting)
- [ ] é¢œè‰²åŒ¹é…
- [ ] é˜´å½±ç”Ÿæˆ

### Phase 3: é«˜çº§åŠŸèƒ½ (2å‘¨)
- [ ] æ‘„åƒæœºè¿åŠ¨åŒ¹é…
- [ ] é•¿è§†é¢‘åˆ†æ®µå¤„ç†
- [ ] å»é—ªçƒå¤„ç†
- [ ] è´¨é‡è‡ªåŠ¨æ£€æµ‹
- [ ] è¶…åˆ†è¾¨ç‡å¢å¼º

### Phase 4: ç”Ÿäº§ä¼˜åŒ– (1å‘¨)
- [ ] GPU èµ„æºæ± ç®¡ç†
- [ ] æ–­ç‚¹ç»­ä¼ 
- [ ] æ‰¹é‡å¤„ç†
- [ ] æˆæœ¬ä¼˜åŒ–

---

## 10. æŠ€æœ¯éš¾ç‚¹ä¸è§£å†³æ–¹æ¡ˆ

| éš¾ç‚¹ | æŒ‘æˆ˜ | è§£å†³æ–¹æ¡ˆ |
|------|------|---------|
| å¤´å‘è¾¹ç¼˜ | ç»†å¯†å‘ä¸éš¾ä»¥ç²¾ç¡®æå– | RobustVideoMatting + ä¸“ç”¨å‘ä¸ matting |
| è¿åŠ¨æ¨¡ç³Š | å¿«é€Ÿè¿åŠ¨å¯¼è‡´è¾¹ç¼˜æ¨¡ç³Š | è¿åŠ¨ä¼°è®¡ + è‡ªé€‚åº” matting |
| é€æ˜ç‰©ä½“ | çœ¼é•œã€é¥®æ–™ç“¶ç­‰ | å¤šå±‚ alpha + åå°„ä¼°è®¡ |
| å…‰å½±è·³å˜ | å¸§é—´å…‰ç…§ä¸ä¸€è‡´ | æ—¶åºå…‰ç…§å¹³æ»‘ + å…¨å±€ä¸€è‡´æ€§çº¦æŸ |
| é•¿è§†é¢‘ | API æ—¶é•¿é™åˆ¶ | åˆ†æ®µç”Ÿæˆ + æ— ç¼æ‹¼æ¥ |
| èƒŒæ™¯è¿åŠ¨ | ç”Ÿæˆçš„è¿åŠ¨ä¸åŸè§†é¢‘ä¸åŒ¹é… | è¿åŠ¨å‘é‡æå– + æ§åˆ¶ç”Ÿæˆ |

---

## æ€»ç»“

è¿™ä¸ª Agent Workflow çš„æ ¸å¿ƒè®¾è®¡ç†å¿µæ˜¯ï¼š

1. **åˆ†è€Œæ²»ä¹‹**: å°†å¤æ‚ä»»åŠ¡æ‹†è§£ä¸º5ä¸ªä¸“ä¸šé˜¶æ®µ
2. **è´¨é‡ä¼˜å…ˆ**: æ¯ä¸ªé˜¶æ®µéƒ½æœ‰æ˜ç¡®çš„è´¨é‡æ ‡å‡†
3. **å®¹é”™è®¾è®¡**: æ”¯æŒæ–­ç‚¹ç»­ä¼ ã€è‡ªåŠ¨é‡è¯•
4. **å¯è§‚æµ‹æ€§**: å®Œæ•´çš„è¿›åº¦è¿½è¸ªå’Œæ—¥å¿—è®°å½•
5. **å¯æ‰©å±•æ€§**: å„é˜¶æ®µç‹¬ç«‹ï¼Œæ˜“äºå‡çº§ä¼˜åŒ–

é€šè¿‡è¿™ä¸ªè®¾è®¡ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ï¼š
- ğŸ¯ **é«˜è¿˜åŸåº¦**: å¤šå±‚å¤„ç†ç¡®ä¿çœ‹ä¸å‡º AI ç—•è¿¹
- âš¡ **é«˜æ•ˆç‡**: å¹¶è¡Œå¤„ç†ï¼ŒGPU èµ„æºæœ€å¤§åŒ–åˆ©ç”¨
- ğŸ›¡ï¸ **é«˜å¯é **: å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œæ¢å¤æœºåˆ¶
- ğŸ“Š **å¯é‡åŒ–**: è‡ªåŠ¨è´¨é‡æ£€æµ‹ï¼Œç¡®ä¿è¾“å‡ºæ ‡å‡†
