# å›¾ç”Ÿè§†é¢‘ Agent Workflow æŠ€æœ¯æ–¹æ¡ˆ

> ç”¨æˆ·å¯ä»¥åœ¨é™æ€å¸§ä¸Šè‡ªç”±ç»˜ç”»ï¼Œæ ¹æ®ç»˜ç”»åŒºåŸŸè‡ªåŠ¨é€‰æ‹©æœ€ä¼˜è§†é¢‘ç”Ÿæˆç­–ç•¥

## ä¸€ã€æ ¸å¿ƒé—®é¢˜åˆ†æ

### 1. äº§å“åœºæ™¯

ç”¨æˆ·åœ¨è§†é¢‘çš„æŸä¸€å¸§ï¼ˆé™æ€å›¾ï¼‰ä¸Šè‡ªç”±ç»˜ç”»ï¼š
- å¯èƒ½åªç”»èƒŒæ™¯ï¼ˆæ¢åœºæ™¯ï¼‰
- å¯èƒ½ç”»åˆ°äººç‰©èº«ä¸Šï¼ˆåŠ é¢†å¸¦ã€æ¢æœé¥°ã€æ”¹å‘å‹ç­‰ï¼‰

**å…³é”®æ´å¯Ÿ**ï¼šç”¨æˆ·çš„ç¼–è¾‘åŒºåŸŸå†³å®šäº†è§†é¢‘ç”Ÿæˆç­–ç•¥ï¼

### 2. ä¸¤ç§ç­–ç•¥çš„æœ¬è´¨åŒºåˆ«

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç­–ç•¥å†³ç­–æ ‘                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚                    ç”¨æˆ·åœ¨å›¾ç‰‡ä¸Šå®Œæˆç¼–è¾‘                                       â”‚
â”‚                           â”‚                                                 â”‚
â”‚                           â–¼                                                 â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚              â”‚  ç¼–è¾‘åŒºåŸŸä¸äººç‰©æœ‰äº¤é›†å—ï¼Ÿ  â”‚                                    â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚                     â”‚           â”‚                                           â”‚
â”‚                    å¦           æ˜¯                                           â”‚
â”‚                     â”‚           â”‚                                           â”‚
â”‚                     â–¼           â–¼                                           â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”‚
â”‚            â”‚ ç­–ç•¥Aï¼šæŠ å›¾åˆæˆ â”‚  â”‚ ç­–ç•¥Bï¼šéŸ³é¢‘é©±åŠ¨é‡å»º  â”‚                           â”‚
â”‚            â”‚ (ä¿ç•™åŸäººç‰©)   â”‚  â”‚ (ç”Ÿæˆæ–°äººç‰©è§†é¢‘)    â”‚                           â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â”‚
â”‚                     â”‚           â”‚                                           â”‚
â”‚                     â–¼           â–¼                                           â”‚
â”‚            å£å‹ï¼šè‡ªåŠ¨ä¿æŒ      å£å‹ï¼šS2V é‡æ–°ç”Ÿæˆ                               â”‚
â”‚            åŠ¨ä½œï¼šåŸè§†é¢‘ä¿ç•™    åŠ¨ä½œï¼šéœ€è¦ Pose å¼•å¯¼                             â”‚
â”‚            ä¸€è‡´æ€§ï¼š100%       ä¸€è‡´æ€§ï¼šéœ€è¦ IP-Adapter                          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. ä¸¤ç§ç­–ç•¥å¯¹æ¯”

| ç»´åº¦ | ç­–ç•¥Aï¼šæŠ å›¾åˆæˆ | ç­–ç•¥Bï¼šéŸ³é¢‘é©±åŠ¨é‡å»º |
|-----|---------------|-------------------|
| **è§¦å‘æ¡ä»¶** | åªç¼–è¾‘äº†èƒŒæ™¯ | ç¼–è¾‘äº†äººç‰©åŒºåŸŸ |
| **å£å‹å¤„ç†** | âœ… åŸå°ä¸åŠ¨ | âš ï¸ Wan2.2-S2V é‡å»º |
| **åŠ¨ä½œä¿ç•™** | âœ… åŸè§†é¢‘åŠ¨ä½œ | âš ï¸ éœ€è¦ Pose ControlNet |
| **äººç‰©ä¸€è‡´æ€§** | âœ… 100% ä¸€è‡´ | âš ï¸ éœ€è¦ IP-Adapter |
| **ç”Ÿæˆé€Ÿåº¦** | å¿«ï¼ˆåªéœ€åˆæˆï¼‰ | æ…¢ï¼ˆéœ€è¦æ¨ç†ï¼‰ |
| **è´¨é‡é£é™©** | ä½ | ä¸­é«˜ï¼ˆAI å¯èƒ½å‡ºé”™ï¼‰ |
| **é€‚ç”¨åœºæ™¯** | æ¢èƒŒæ™¯ã€æ¢åœºæ™¯ | æ¢è£…ã€åŠ é…é¥°ã€å˜è£… |

---

## äºŒã€å®Œæ•´çš„å›¾ç”Ÿè§†é¢‘æµç¨‹

### é˜¶æ®µ 0ï¼šç¼–è¾‘æ£€æµ‹ï¼ˆå…³é”®å†³ç­–ç‚¹ï¼‰

#### æ ¸å¿ƒæ¦‚å¿µ

æˆ‘ä»¬æœ‰ **3 å¼ å›¾/mask**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           è¾“å…¥æ•°æ®                                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚             â”‚
â”‚  â”‚    åŸå§‹å¸§        â”‚  â”‚    ç¼–è¾‘åçš„å¸§    â”‚  â”‚ â–ˆâ–ˆ äººç‰©åŒºåŸŸ â–ˆâ–ˆ  â”‚             â”‚
â”‚  â”‚  (original)     â”‚  â”‚   (edited)      â”‚  â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ  â”‚             â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚                 â”‚             â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”       â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”       â”‚  â”‚  person_mask    â”‚             â”‚
â”‚  â”‚  â”‚ äººç‰© â”‚       â”‚  â”‚  â”‚äººç‰©+é¢†å¸¦â”‚     â”‚  â”‚  (ä»åŸå§‹å¸§æŠ å‡º)  â”‚             â”‚
â”‚  â”‚  â”‚      â”‚       â”‚  â”‚  â”‚      â”‚       â”‚  â”‚                 â”‚             â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”˜       â”‚  â”‚                 â”‚             â”‚
â”‚  â”‚    èƒŒæ™¯         â”‚  â”‚   æ–°èƒŒæ™¯        â”‚  â”‚                 â”‚             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚
â”‚         â†“                    â†“                    â†“                        â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                              â†“                                             â”‚
â”‚                      ç¼–è¾‘åŒºåŸŸæ£€æµ‹ç®—æ³•                                        â”‚
â”‚                              â†“                                             â”‚
â”‚                    ç­–ç•¥A æˆ– ç­–ç•¥B                                           â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### æ£€æµ‹æµç¨‹è¯¦è§£

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        ç¼–è¾‘åŒºåŸŸæ£€æµ‹ç®—æ³•                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  Step 1: è®¡ç®—åƒç´ å·®å¼‚ï¼Œç”Ÿæˆ edit_mask                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   original_frame          edited_frame           edit_mask          â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚   â”‚             â”‚         â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â”Œâ”€â”€â”€â”     â”‚         â”‚ â–‘â–‘â”Œâ”€â”€â”€â”â–‘â–‘â–‘â–‘ â”‚        â”‚             â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â”‚   â”‚     â”‚   diff  â”‚ â–‘â–‘â”‚ â–ˆ â”‚â–‘â–‘â–‘â–‘ â”‚   â†’    â”‚     â–ˆâ–ˆ      â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â”‚   â”‚     â”‚   â”€â”€â”€â†’  â”‚ â–‘â–‘â”‚   â”‚â–‘â–‘â–‘â–‘ â”‚        â”‚             â”‚   â”‚   â”‚
â”‚  â”‚   â”‚   â””â”€â”€â”€â”˜     â”‚         â”‚ â–‘â–‘â””â”€â”€â”€â”˜â–‘â–‘â–‘â–‘ â”‚        â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚   â”‚   â”‚
â”‚  â”‚   â”‚             â”‚         â”‚ â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘ â”‚        â”‚             â”‚   â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚   (åŸå§‹èƒŒæ™¯)              (æ–°èƒŒæ™¯+é¢†å¸¦)          (è¢«ä¿®æ”¹çš„åŒºåŸŸ)       â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   edit_mask = |original - edited| > pixel_threshold                â”‚   â”‚
â”‚  â”‚   pixel_threshold = 10 (RGBå·®å¼‚è¶…è¿‡10è®¤ä¸ºæ˜¯ç¼–è¾‘)                     â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  Step 2: ä¸äººç‰©maskæ±‚äº¤é›†                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   edit_mask              person_mask           intersection         â”‚   â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   â”‚
â”‚  â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚        â”‚             â”‚       â”‚             â”‚     â”‚   â”‚
â”‚  â”‚   â”‚             â”‚        â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚       â”‚             â”‚     â”‚   â”‚
â”‚  â”‚   â”‚     â–ˆâ–ˆ      â”‚   AND  â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚   =   â”‚     â–ˆâ–ˆ      â”‚     â”‚   â”‚
â”‚  â”‚   â”‚             â”‚        â”‚   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ   â”‚       â”‚             â”‚     â”‚   â”‚
â”‚  â”‚   â”‚ â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚        â”‚             â”‚       â”‚             â”‚     â”‚   â”‚
â”‚  â”‚   â”‚             â”‚        â”‚             â”‚       â”‚             â”‚     â”‚   â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   â”‚
â”‚  â”‚   (ç¼–è¾‘äº†èƒŒæ™¯+é¢†å¸¦)       (äººç‰©æ‰€åœ¨åŒºåŸŸ)         (ç¼–è¾‘è½åœ¨äººç‰©ä¸Šçš„éƒ¨åˆ†) â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  Step 3: è®¡ç®—æ¯”ä¾‹å¹¶å†³ç­–                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   ä¸¤ä¸ªå…³é”®æŒ‡æ ‡ï¼š                                                      â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   â‘  edit_on_person_ratio = intersection / edit_mask                â”‚   â”‚
â”‚  â”‚      "ç¼–è¾‘åŒºåŸŸä¸­ï¼Œæœ‰å¤šå°‘æ¯”ä¾‹è½åœ¨äººç‰©ä¸Šï¼Ÿ"                               â”‚   â”‚
â”‚  â”‚      â†’ ç”¨äºåˆ¤æ–­ï¼šç”¨æˆ·çš„ä¸»è¦ç¼–è¾‘æ„å›¾æ˜¯é’ˆå¯¹äººç‰©è¿˜æ˜¯èƒŒæ™¯                    â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚   â‘¡ person_edited_ratio = intersection / person_mask               â”‚   â”‚
â”‚  â”‚      "äººç‰©åŒºåŸŸä¸­ï¼Œæœ‰å¤šå°‘æ¯”ä¾‹è¢«ç¼–è¾‘äº†ï¼Ÿ"                                 â”‚   â”‚
â”‚  â”‚      â†’ ç”¨äºåˆ¤æ–­ï¼šäººç‰©çš„ä¿®æ”¹ç¨‹åº¦æœ‰å¤šå¤§                                  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### é˜ˆå€¼è®¾è®¡ï¼ˆå…³é”®ï¼ï¼‰

```python
# æ¨èçš„é˜ˆå€¼é…ç½®
THRESHOLDS = {
    # åƒç´ å·®å¼‚é˜ˆå€¼ï¼šRGBå·®å¼‚è¶…è¿‡å¤šå°‘è®¤ä¸ºæ˜¯"è¢«ç¼–è¾‘äº†"
    "pixel_diff": 10,  # 0-255 èŒƒå›´ï¼Œ10 è¶³ä»¥è¿‡æ»¤æ‰å‹ç¼©å™ªå£°
    
    # è¾¹ç¼˜å®¹å·®ï¼šæŠ å›¾è¾¹ç¼˜å¯èƒ½æœ‰å‡ åƒç´ è¯¯å·®ï¼Œéœ€è¦è†¨èƒ€/è…èš€å¤„ç†
    "edge_tolerance_px": 3,  # åƒç´ 
    
    # å†³ç­–é˜ˆå€¼
    "strategy_thresholds": {
        # ç¼–è¾‘åŒºåŸŸä¸­è½åœ¨äººç‰©ä¸Šçš„æ¯”ä¾‹
        "edit_on_person_ratio": {
            "background_only": 0.02,   # < 2% â†’ çº¯èƒŒæ™¯ç¼–è¾‘
            "minor_touch": 0.10,       # 2-10% â†’ è½»å¾®è§¦ç¢°ï¼ˆå¯èƒ½æ˜¯è¾¹ç¼˜è¯¯å·®ï¼‰
            "person_edited": 0.10,     # > 10% â†’ æ˜ç¡®ç¼–è¾‘äº†äººç‰©
        },
        
        # äººç‰©åŒºåŸŸè¢«ç¼–è¾‘çš„æ¯”ä¾‹
        "person_edited_ratio": {
            "negligible": 0.01,        # < 1% â†’ å¯å¿½ç•¥
            "minor": 0.05,             # 1-5% â†’ å°ä¿®æ”¹ï¼ˆé…é¥°ï¼‰
            "major": 0.20,             # 5-20% â†’ ä¸­ç­‰ä¿®æ”¹ï¼ˆæ¢è£…å±€éƒ¨ï¼‰
            "full_change": 0.20,       # > 20% â†’ å¤§æ”¹ï¼ˆæ•´å¥—æœé¥°ï¼‰
        }
    }
}
```

#### å®Œæ•´æ£€æµ‹ä»£ç 

```python
import numpy as np
import cv2
from enum import Enum
from dataclasses import dataclass
from typing import Tuple

class EditStrategy(Enum):
    BACKGROUND_ONLY = "background_only"      # ç­–ç•¥Aï¼šçº¯æŠ å›¾åˆæˆ
    PERSON_MINOR_EDIT = "person_minor_edit"  # ç­–ç•¥B-è½»åº¦ï¼šå°é…é¥°ä¿®æ”¹
    PERSON_MAJOR_EDIT = "person_major_edit"  # ç­–ç•¥B-é‡åº¦ï¼šå¤§é¢ç§¯æ¢è£…


@dataclass
class EditDetectionResult:
    """ç¼–è¾‘æ£€æµ‹ç»“æœ"""
    strategy: EditStrategy
    edit_on_person_ratio: float    # ç¼–è¾‘åŒºåŸŸä¸­è½åœ¨äººç‰©ä¸Šçš„æ¯”ä¾‹
    person_edited_ratio: float     # äººç‰©åŒºåŸŸè¢«ç¼–è¾‘çš„æ¯”ä¾‹
    edit_mask: np.ndarray          # ç¼–è¾‘åŒºåŸŸmask
    intersection_mask: np.ndarray  # äº¤é›†mask
    confidence: float              # ç½®ä¿¡åº¦
    recommendation: str            # æ¨èè¯´æ˜


def detect_edit_strategy(
    original_frame: np.ndarray,      # åŸå§‹å¸§ (H, W, 3) RGB
    edited_frame: np.ndarray,        # ç¼–è¾‘åçš„å¸§ (H, W, 3) RGB  
    person_mask: np.ndarray,         # äººç‰©åˆ†å‰²mask (H, W) 0/1
    pixel_threshold: int = 10,       # åƒç´ å·®å¼‚é˜ˆå€¼
    edge_tolerance: int = 3,         # è¾¹ç¼˜å®¹å·®åƒç´ æ•°
) -> EditDetectionResult:
    """
    æ£€æµ‹ç”¨æˆ·ç¼–è¾‘åŒºåŸŸï¼Œå†³å®šè§†é¢‘ç”Ÿæˆç­–ç•¥
    
    Args:
        original_frame: åŸå§‹è§†é¢‘å¸§
        edited_frame: ç”¨æˆ·ç¼–è¾‘åçš„å¸§
        person_mask: äººç‰©åˆ†å‰²maskï¼ˆ1=äººç‰©ï¼Œ0=èƒŒæ™¯ï¼‰
        pixel_threshold: åƒç´ å·®å¼‚é˜ˆå€¼ï¼Œè¶…è¿‡æ­¤å€¼è®¤ä¸ºæ˜¯ç¼–è¾‘
        edge_tolerance: è¾¹ç¼˜å®¹å·®ï¼Œç”¨äºå¤„ç†æŠ å›¾è¾¹ç¼˜è¯¯å·®
    
    Returns:
        EditDetectionResult: åŒ…å«ç­–ç•¥æ¨èå’Œè¯¦ç»†åˆ†æ
    """
    
    # ========== Step 1: è®¡ç®—ç¼–è¾‘åŒºåŸŸ mask ==========
    # è®¡ç®—åƒç´ çº§å·®å¼‚
    diff = np.abs(original_frame.astype(np.float32) - edited_frame.astype(np.float32))
    diff_gray = diff.mean(axis=2)  # è½¬ä¸ºç°åº¦å·®å¼‚
    
    # ç”Ÿæˆç¼–è¾‘åŒºåŸŸ mask
    edit_mask = (diff_gray > pixel_threshold).astype(np.uint8)
    
    # å½¢æ€å­¦å¤„ç†ï¼šå»é™¤å™ªç‚¹
    kernel = cv2.getStructuringElement(cv2.MORPH_ELLIPSE, (3, 3))
    edit_mask = cv2.morphologyEx(edit_mask, cv2.MORPH_OPEN, kernel)
    edit_mask = cv2.morphologyEx(edit_mask, cv2.MORPH_CLOSE, kernel)
    
    # ========== Step 2: å¤„ç†äººç‰© mask è¾¹ç¼˜ ==========
    # å¯¹äººç‰©maskè¿›è¡Œè…èš€ï¼Œé¿å…è¾¹ç¼˜è¯¯åˆ¤
    # å› ä¸ºæŠ å›¾è¾¹ç¼˜å¯èƒ½æœ‰å‡ åƒç´ çš„è¯¯å·®
    if edge_tolerance > 0:
        erode_kernel = cv2.getStructuringElement(
            cv2.MORPH_ELLIPSE, 
            (edge_tolerance * 2 + 1, edge_tolerance * 2 + 1)
        )
        person_mask_eroded = cv2.erode(person_mask.astype(np.uint8), erode_kernel)
    else:
        person_mask_eroded = person_mask.astype(np.uint8)
    
    # ========== Step 3: è®¡ç®—äº¤é›† ==========
    intersection = cv2.bitwise_and(edit_mask, person_mask_eroded)
    
    # ========== Step 4: è®¡ç®—æ¯”ä¾‹ ==========
    edit_area = edit_mask.sum()
    person_area = person_mask_eroded.sum()
    intersection_area = intersection.sum()
    
    # é¿å…é™¤é›¶
    if edit_area == 0:
        # ç”¨æˆ·æ²¡æœ‰ç¼–è¾‘ä»»ä½•å†…å®¹
        return EditDetectionResult(
            strategy=EditStrategy.BACKGROUND_ONLY,
            edit_on_person_ratio=0.0,
            person_edited_ratio=0.0,
            edit_mask=edit_mask,
            intersection_mask=intersection,
            confidence=1.0,
            recommendation="æœªæ£€æµ‹åˆ°ç¼–è¾‘ï¼Œæ— éœ€ç”Ÿæˆ"
        )
    
    # æ ¸å¿ƒæŒ‡æ ‡
    edit_on_person_ratio = intersection_area / edit_area
    person_edited_ratio = intersection_area / person_area if person_area > 0 else 0
    
    # ========== Step 5: ç­–ç•¥å†³ç­– ==========
    if edit_on_person_ratio < 0.02:
        # ç¼–è¾‘å‡ ä¹å®Œå…¨åœ¨èƒŒæ™¯åŒºåŸŸ
        strategy = EditStrategy.BACKGROUND_ONLY
        confidence = 1.0 - edit_on_person_ratio  # è¶Šæ¥è¿‘0è¶Šç¡®ä¿¡
        recommendation = "ç¼–è¾‘ä»…æ¶‰åŠèƒŒæ™¯ï¼Œä½¿ç”¨æŠ å›¾åˆæˆç­–ç•¥ï¼Œå£å‹åŠ¨ä½œ100%ä¿æŒ"
        
    elif edit_on_person_ratio < 0.10:
        # è½»å¾®è§¦ç¢°äººç‰©åŒºåŸŸï¼ˆå¯èƒ½æ˜¯è¾¹ç¼˜æˆ–å°é…é¥°ï¼‰
        if person_edited_ratio < 0.05:
            # äººç‰©æ•´ä½“æ”¹åŠ¨å¾ˆå°
            strategy = EditStrategy.PERSON_MINOR_EDIT
            confidence = 0.7
            recommendation = "æ£€æµ‹åˆ°å°èŒƒå›´äººç‰©ç¼–è¾‘ï¼ˆå¦‚é…é¥°ï¼‰ï¼Œå°†ä½¿ç”¨éŸ³é¢‘é©±åŠ¨ç”Ÿæˆ"
        else:
            strategy = EditStrategy.PERSON_MAJOR_EDIT
            confidence = 0.8
            recommendation = "æ£€æµ‹åˆ°äººç‰©ç¼–è¾‘ï¼Œå°†ä½¿ç”¨éŸ³é¢‘é©±åŠ¨+Poseå¼•å¯¼ç”Ÿæˆ"
    else:
        # æ˜ç¡®ç¼–è¾‘äº†äººç‰©
        if person_edited_ratio > 0.20:
            strategy = EditStrategy.PERSON_MAJOR_EDIT
            confidence = 0.95
            recommendation = "æ£€æµ‹åˆ°å¤§é¢ç§¯äººç‰©ä¿®æ”¹ï¼ˆæ¢è£…ï¼‰ï¼Œå°†ä½¿ç”¨å®Œæ•´çš„S2Vé‡å»º"
        else:
            strategy = EditStrategy.PERSON_MINOR_EDIT
            confidence = 0.85
            recommendation = "æ£€æµ‹åˆ°äººç‰©ç¼–è¾‘ï¼Œå°†ä½¿ç”¨éŸ³é¢‘é©±åŠ¨ç”Ÿæˆ"
    
    return EditDetectionResult(
        strategy=strategy,
        edit_on_person_ratio=edit_on_person_ratio,
        person_edited_ratio=person_edited_ratio,
        edit_mask=edit_mask,
        intersection_mask=intersection,
        confidence=confidence,
        recommendation=recommendation
    )


# ========== ä½¿ç”¨ç¤ºä¾‹ ==========
def example_usage():
    """ä½¿ç”¨ç¤ºä¾‹"""
    # 1. åŠ è½½å›¾ç‰‡
    original = cv2.imread("original_frame.png")
    edited = cv2.imread("edited_frame.png")
    
    # 2. è·å–äººç‰©maskï¼ˆé€šè¿‡SAM2æˆ–å…¶ä»–åˆ†å‰²æ¨¡å‹ï¼‰
    # è¿™é‡Œå‡è®¾å·²ç»æœ‰äº†
    person_mask = get_person_mask(original)  # è¿”å› 0/1 mask
    
    # 3. æ£€æµ‹ç¼–è¾‘ç­–ç•¥
    result = detect_edit_strategy(original, edited, person_mask)
    
    print(f"æ¨èç­–ç•¥: {result.strategy.value}")
    print(f"ç¼–è¾‘è½åœ¨äººç‰©ä¸Šçš„æ¯”ä¾‹: {result.edit_on_person_ratio:.2%}")
    print(f"äººç‰©è¢«ç¼–è¾‘çš„æ¯”ä¾‹: {result.person_edited_ratio:.2%}")
    print(f"ç½®ä¿¡åº¦: {result.confidence:.2%}")
    print(f"æ¨èè¯´æ˜: {result.recommendation}")
    
    # 4. æ ¹æ®ç­–ç•¥æ‰§è¡Œä¸åŒçš„å·¥ä½œæµ
    if result.strategy == EditStrategy.BACKGROUND_ONLY:
        run_strategy_a()  # æŠ å›¾åˆæˆ
    else:
        run_strategy_b()  # éŸ³é¢‘é©±åŠ¨é‡å»º
```

#### å†³ç­–çŸ©é˜µ

| edit_on_person_ratio | person_edited_ratio | ç­–ç•¥ | è¯´æ˜ |
|---------------------|---------------------|------|------|
| < 2% | ä»»æ„ | ç­–ç•¥A | çº¯èƒŒæ™¯ç¼–è¾‘ï¼ŒæŠ å›¾åˆæˆ |
| 2% ~ 10% | < 5% | ç­–ç•¥B-è½»åº¦ | å°é…é¥°ï¼Œå¯å°è¯•å±€éƒ¨ä¿®å¤ |
| 2% ~ 10% | â‰¥ 5% | ç­–ç•¥B-é‡åº¦ | éœ€è¦å®Œæ•´é‡å»º |
| â‰¥ 10% | < 20% | ç­–ç•¥B-è½»åº¦ | æ˜ç¡®äººç‰©ç¼–è¾‘ |
| â‰¥ 10% | â‰¥ 20% | ç­–ç•¥B-é‡åº¦ | å¤§é¢ç§¯æ¢è£… |

#### è¾¹ç¼˜æƒ…å†µå¤„ç†

```python
# ç‰¹æ®Šæƒ…å†µå¤„ç†
EDGE_CASES = {
    "ç”¨æˆ·åªç”»äº†ä¸€ä¸ªå°ç‚¹åœ¨äººç‰©ä¸Š": {
        "è¡¨ç°": "edit_on_person_ratio é«˜ï¼Œä½† intersection é¢ç§¯å¾ˆå°",
        "å¤„ç†": "å¢åŠ æœ€å°é¢ç§¯é˜ˆå€¼ï¼Œé¢ç§¯ < 100px å¿½ç•¥",
    },
    "ç”¨æˆ·ä¿®æ”¹äº†äººç‰©è¾¹ç¼˜é˜´å½±": {
        "è¡¨ç°": "äº¤é›†åœ¨äººç‰©maskè¾¹ç¼˜",
        "å¤„ç†": "è…èš€äººç‰©mask 3-5px åå†åˆ¤æ–­",
    },
    "JPEGå‹ç¼©å¯¼è‡´çš„å‡é˜³æ€§": {
        "è¡¨ç°": "æ•´å¼ å›¾æœ‰å¾®å°å·®å¼‚",
        "å¤„ç†": "pixel_threshold è®¾ä¸º 10-15",
    },
    "ç”¨æˆ·ä¿®æ”¹äº†ä¸äººç‰©é‡å çš„èƒŒæ™¯ç‰©ä½“": {
        "è¡¨ç°": "å¦‚ä¿®æ”¹æ¤…å­ï¼Œä½†æ¤…å­åœ¨äººç‰©åé¢",
        "å¤„ç†": "éœ€è¦æ·±åº¦æ„ŸçŸ¥ï¼Œæš‚æ—¶æŒ‰ç­–ç•¥Bå¤„ç†",
    },
}
```

---

## äºŒã€æŠ€æœ¯æ–¹æ¡ˆé€‰æ‹©ï¼šå¯çµ Kling APIï¼ˆå·²é›†æˆï¼‰

> ğŸ’¡ **é‡è¦å‘ç°**ï¼šé¡¹ç›®ä¸­å·²å®Œæ•´é›†æˆå¯çµ Kling APIï¼Œæ— éœ€é¢å¤–æ¥å…¥ RunningHubï¼
>
> ä»£ç ä½ç½®ï¼š`backend/app/services/kling_ai_service.py`

### å·²é›†æˆçš„å¯çµèƒ½åŠ›ä¸€è§ˆ

| èƒ½åŠ› | API ç«¯ç‚¹ | ç­–ç•¥å¯¹åº” | ä»£ç æ–¹æ³• |
|------|----------|---------|---------|
| **ğŸ¤ å£å‹åŒæ­¥ (Lip Sync)** | `/videos/advanced-lip-sync` | ç­–ç•¥B æ ¸å¿ƒ | `create_lip_sync_task()` |
| **ğŸ–¼ï¸ å›¾ç”Ÿè§†é¢‘ (I2V)** | `/videos/image2video` | ç­–ç•¥A æ ¸å¿ƒ | `create_image_to_video_task()` |
| **âœï¸ å¤šæ¨¡æ€è§†é¢‘ç¼–è¾‘** | `/videos/multi-elements` | ç›´æ¥æ¢èƒŒæ™¯ | `create_multi_elements_task()` |
| **ğŸ“ æ–‡ç”Ÿè§†é¢‘ (T2V)** | `/videos/text2video` | B-roll ç´ æ | `create_text_to_video_task()` |
| **ğŸ•º åŠ¨ä½œæ§åˆ¶** | `/videos/motion-control` | åŠ¨ä½œè¿ç§» | `create_motion_control_task()` |
| **â±ï¸ è§†é¢‘å»¶é•¿** | `/videos/video-extend` | æ—¶é•¿å»¶é•¿ | `create_video_extend_task()` |
| **ğŸ–¼ï¸ å¤šå›¾ç”Ÿè§†é¢‘** | `/videos/multi-image2video` | é¦–å°¾å¸§æ§åˆ¶ | `create_multi_image_to_video_task()` |
| **ğŸ¨ Omni-Image** | `/images/omni-image` | é«˜çº§å›¾åƒç¼–è¾‘ | `create_omni_image_task()` |
| **ğŸ–¼ï¸ å›¾åƒç”Ÿæˆ** | `/images/generations` | æ–‡/å›¾ç”Ÿå›¾ | `create_image_generation_task()` |

### æ–¹æ¡ˆå¯¹æ¯”ä¸æ¨è

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æŠ€æœ¯æ–¹æ¡ˆæ¨èï¼ˆä¼˜å…ˆä½¿ç”¨å·²é›†æˆçš„å¯çµï¼‰                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  ç­–ç•¥Aï¼ˆåªæ¢èƒŒæ™¯ï¼‰                                                           â”‚
â”‚  â”œâ”€â”€ æ–¹æ¡ˆ1ï¼šå¯çµ I2Vï¼ˆâœ… å·²é›†æˆï¼Œæ¨èï¼‰                                       â”‚
â”‚  â”‚   â””â”€â”€ create_image_to_video_task(image, prompt, options)                â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â”œâ”€â”€ æ–¹æ¡ˆ2ï¼šå¯çµ å¤šæ¨¡æ€ç¼–è¾‘ swap æ¨¡å¼ï¼ˆâœ… å·²é›†æˆï¼Œç›´æ¥æ›¿æ¢èƒŒæ™¯ï¼‰               â”‚
â”‚  â”‚   â””â”€â”€ create_multi_elements_task(session_id, "swap", prompt)            â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â””â”€â”€ å¤‡é€‰ï¼šRunningHub Wan2.2 I2V                                            â”‚
â”‚                                                                             â”‚
â”‚  ç­–ç•¥Bï¼ˆäººç‰©é‡å»º + å£å‹åŒæ­¥ï¼‰                                                 â”‚
â”‚  â”œâ”€â”€ æ–¹æ¡ˆ1ï¼šå¯çµ Lip Syncï¼ˆâœ… å·²é›†æˆï¼Œæ¨èï¼‰                                  â”‚
â”‚  â”‚   â””â”€â”€ identify_face() â†’ create_lip_sync_task()                          â”‚
â”‚  â”‚                                                                          â”‚
â”‚  â””â”€â”€ å¤‡é€‰ï¼šRunningHub Wan2.2-S2V æ•°å­—äºº                                      â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸ºä»€ä¹ˆä¼˜å…ˆç”¨å¯çµè€Œä¸æ˜¯ RunningHubï¼Ÿ

| ç»´åº¦ | å¯çµ Kling | RunningHub |
|-----|-----------|------------|
| **é›†æˆçŠ¶æ€** | âœ… å·²å®Œæ•´é›†æˆ | âŒ éœ€æ–°æ¥å…¥ |
| **å£å‹åŒæ­¥** | âœ… åŸç”Ÿæ”¯æŒ Lip Sync | éœ€ç”¨ Wan2.2-S2V |
| **API ç¨³å®šæ€§** | â­â­â­â­â­ å•†ä¸šçº§ | â­â­â­â­ å¼€æºæ¨¡å‹ |
| **å“åº”é€Ÿåº¦** | å¿«ï¼ˆå•†ä¸š GPU é›†ç¾¤ï¼‰ | ä¸­ç­‰ |
| **è®¡è´¹æ¨¡å¼** | æŒ‰æ¬¡ | æŒ‰è¿è¡Œæ—¶é•¿ |

---

## ä¸‰ã€å¯çµ API è¯¦ç»†å‚æ•°å¯¹ç…§

> âš ï¸ **é‡è¦**ï¼šä»¥ä¸‹å‚æ•°ä¸¥æ ¼æŒ‰ç…§ `kling_ai_service.py` å®é™…ä»£ç å¯¹é½

### 3.1 å£å‹åŒæ­¥ Lip Syncï¼ˆç­–ç•¥B æ ¸å¿ƒï¼‰

#### Step 1: äººè„¸è¯†åˆ« `identify_face()`

```python
# æ–‡ä»¶: backend/app/services/kling_ai_service.py
# ç«¯ç‚¹: POST /v1/videos/identify-face

# å‚æ•°è¯´æ˜
async def identify_face(
    self,
    video_url: str = None,    # è§†é¢‘ URLï¼ˆä¸ video_id äºŒé€‰ä¸€ï¼‰
    video_id: str = None      # å¯çµç”Ÿæˆçš„è§†é¢‘ IDï¼ˆä¸ video_url äºŒé€‰ä¸€ï¼‰
) -> Dict:
    """
    è¿”å›å€¼:
    {
        "session_id": "xxx",           # ä¼šè¯ IDï¼Œç”¨äºåç»­å¯¹å£å‹
        "face_data": [
            {
                "face_id": "xxx",       # äººè„¸ ID
                "face_image": "url",    # äººè„¸æˆªå›¾ URL
                "start_time": 0,        # å¼€å§‹æ—¶é—´(ms)
                "end_time": 5200        # ç»“æŸæ—¶é—´(ms)
            }
        ]
    }
    """
```

#### Step 2: åˆ›å»ºå¯¹å£å‹ä»»åŠ¡ `create_lip_sync_task()`

```python
# ç«¯ç‚¹: POST /v1/videos/advanced-lip-sync

async def create_lip_sync_task(
    self,
    session_id: str,                    # å¿…å¡«ï¼šäººè„¸è¯†åˆ«è¿”å›çš„ä¼šè¯ ID
    face_id: str,                       # å¿…å¡«ï¼šè¦å¯¹å£å‹çš„äººè„¸ ID
    audio_url: str = None,              # éŸ³é¢‘ URLï¼ˆä¸ audio_id äºŒé€‰ä¸€ï¼‰
    audio_id: str = None,               # å¯çµç”Ÿæˆçš„éŸ³é¢‘ IDï¼ˆä¸ audio_url äºŒé€‰ä¸€ï¼‰
    sound_start_time: int = 0,          # éŸ³é¢‘è£å‰ªèµ·ç‚¹æ—¶é—´(ms)
    sound_end_time: int = None,         # éŸ³é¢‘è£å‰ªç»ˆç‚¹æ—¶é—´(ms)
    sound_insert_time: int = 0,         # éŸ³é¢‘æ’å…¥è§†é¢‘çš„æ—¶é—´(ms)
    sound_volume: float = 1.0,          # éŸ³é¢‘éŸ³é‡ [0, 2]
    original_audio_volume: float = 1.0, # åŸå§‹è§†é¢‘éŸ³é‡ [0, 2]
    external_task_id: str = None,       # è‡ªå®šä¹‰ä»»åŠ¡ ID
    callback_url: str = None            # å›è°ƒé€šçŸ¥åœ°å€
) -> Dict:
    """
    è¯·æ±‚ä½“æ ¼å¼:
    {
        "session_id": "xxx",
        "face_choose": [{
            "face_id": "xxx",
            "sound_file": "audio_url",      # æ³¨æ„ï¼šå‚æ•°åæ˜¯ sound_file ä¸æ˜¯ audio_url
            "sound_start_time": 0,
            "sound_end_time": null,
            "sound_insert_time": 0,
            "sound_volume": 1.0,
            "original_audio_volume": 1.0
        }]
    }
    
    è¿”å›å€¼:
    {"task_id": "xxx", "task_status": "submitted", ...}
    """
```

#### Step 3: æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ `get_lip_sync_task()`

```python
# ç«¯ç‚¹: GET /v1/videos/advanced-lip-sync/{task_id}

async def get_lip_sync_task(self, task_id: str) -> Dict:
    """
    è¿”å›å€¼:
    {
        "task_id": "xxx",
        "task_status": "submitted/processing/succeed/failed",
        "task_result": {
            "videos": [{"id": "xxx", "url": "xxx", "duration": "5"}]
        }
    }
    """
```

### 3.2 å›¾ç”Ÿè§†é¢‘ I2Vï¼ˆç­–ç•¥A æ ¸å¿ƒï¼‰

```python
# ç«¯ç‚¹: POST /v1/videos/image2video

async def create_image_to_video_task(
    self,
    image: str,              # å¿…å¡«ï¼šå‚è€ƒå›¾åƒ URL æˆ– Base64
    prompt: str = "",        # æ­£å‘æç¤ºè¯ï¼ˆâ‰¤2500å­—ç¬¦ï¼‰
    options: Dict = None     # å¯é€‰å‚æ•°
) -> Dict:
    """
    options å¯é€‰å‚æ•°:
    {
        "model_name": "kling-v2-5-turbo",  # æ¨¡å‹ç‰ˆæœ¬
            # å¯é€‰å€¼: kling-v2-5-turbo / kling-v2-1-master / kling-v2-6
        "image_tail": "url",               # å°¾å¸§å›¾ç‰‡ï¼ˆæ§åˆ¶ç»“æŸå¸§ï¼‰
        "negative_prompt": "",             # è´Ÿå‘æç¤ºè¯
        "duration": "5",                   # è§†é¢‘æ—¶é•¿ "5" æˆ– "10" ç§’ï¼ˆå­—ç¬¦ä¸²ï¼ï¼‰
        "mode": "std",                     # ç”Ÿæˆæ¨¡å¼ "std"(æ ‡å‡†) / "pro"(é«˜å“è´¨)
        "cfg_scale": 0.5,                  # è‡ªç”±åº¦ 0-1
        "sound": "off",                    # æ˜¯å¦ç”Ÿæˆå£°éŸ³ "on"/"off"ï¼ˆä»…V2.6+ï¼‰
        "voice_list": [{"voice_id": "xxx"}], # éŸ³è‰²åˆ—è¡¨ï¼ˆä»…V2.6+ï¼‰
        "camera_control": {                # è¿é•œæ§åˆ¶ï¼ˆä¸ static_mask äº’æ–¥ï¼‰
            "type": "...",
            "config": {...}
        },
        "static_mask": "url",              # é™æ€ç¬”åˆ·è’™ç‰ˆï¼ˆä¸ camera_control äº’æ–¥ï¼‰
        "dynamic_masks": [{                # åŠ¨æ€ç¬”åˆ·é…ç½®
            "mask": "url",
            "trajectories": [{"x": 0.1, "y": 0.2}]
        }],
        "callback_url": "url",             # å›è°ƒåœ°å€
        "external_task_id": "xxx"          # è‡ªå®šä¹‰ä»»åŠ¡ID
    }
    
    è¿”å›å€¼:
    {
        "code": 0,
        "data": {
            "task_id": "xxx",
            "task_status": "submitted/processing/succeed/failed"
        }
    }
    """
```

### 3.3 å¤šæ¨¡æ€è§†é¢‘ç¼–è¾‘ï¼ˆç›´æ¥æ¢èƒŒæ™¯ï¼Œæœ€ä½³æ–¹æ¡ˆï¼‰

#### Step 1: åˆå§‹åŒ–è§†é¢‘ `init_video_selection()`

```python
# ç«¯ç‚¹: POST /v1/videos/multi-elements/init-selection

async def init_video_selection(
    self,
    video_url: str = None,   # è§†é¢‘URLï¼ˆä¸ video_id äºŒé€‰ä¸€ï¼‰
    video_id: str = None     # è§†é¢‘IDï¼ˆä¸ video_url äºŒé€‰ä¸€ï¼‰
) -> Dict:
    """
    è§†é¢‘è¦æ±‚:
    - ä»…æ”¯æŒ MP4 å’Œ MOV æ ¼å¼
    - æ—¶é•¿ â‰¥2ç§’ä¸”â‰¤5ç§’ï¼Œæˆ– â‰¥7ç§’ä¸”â‰¤10ç§’
    - å®½é«˜ 720px-2160pxï¼Œ24/30/60fps
    
    è¿”å›å€¼:
    {
        "code": 0,
        "data": {
            "session_id": "xxx",       # ä¼šè¯IDï¼Œ24å°æ—¶æœ‰æ•ˆ
            "fps": 30.0,
            "original_duration": 1000,
            "width": 720,
            "height": 1280,
            "total_frame": 300,
            "normalized_video": "url"
        }
    }
    """
```

#### Step 2: æ ‡è®°é€‰åŒº `add_video_selection()`

```python
# ç«¯ç‚¹: POST /v1/videos/multi-elements/add-selection

async def add_video_selection(
    self,
    session_id: str,                    # ä¼šè¯ID
    frame_index: int,                   # å¸§å·ï¼ˆæœ€å¤šæ”¯æŒ10ä¸ªæ ‡è®°å¸§ï¼‰
    points: List[Dict[str, float]]      # ç‚¹é€‰åæ ‡
) -> Dict:
    """
    points æ ¼å¼:
    [{"x": 0.5, "y": 0.5}]
    - x,y å–å€¼èŒƒå›´ [0,1]ï¼Œç™¾åˆ†æ¯”è¡¨ç¤º
    - [0,0] ä»£è¡¨ç”»é¢å·¦ä¸Šè§’
    - æ¯å¸§æœ€å¤šæ ‡è®°10ä¸ªç‚¹
    """
```

#### Step 3: æ‰§è¡Œç¼–è¾‘ `create_multi_elements_task()`

```python
# ç«¯ç‚¹: POST /v1/videos/multi-elements/

async def create_multi_elements_task(
    self,
    session_id: str,            # ä¼šè¯ID
    edit_mode: str,             # æ“ä½œç±»å‹: "addition" / "swap" / "removal"
    prompt: str,                # æç¤ºè¯ï¼ˆå¿…å¡«ï¼‰
    options: Dict = None
) -> Dict:
    """
    prompt æ ¼å¼è¯´æ˜:
    - ç”¨ <<<video_1>>> æŒ‡ä»£è§†é¢‘
    - ç”¨ <<<image_1>>> æŒ‡ä»£å›¾ç‰‡
    
    å¢åŠ å…ƒç´ : "åŸºäº<<<video_1>>>ï¼Œå°†<<<image_1>>>ä¸­çš„ã€Xã€‘èå…¥<<<video_1>>>çš„ã€Yã€‘"
    æ›¿æ¢å…ƒç´ : "ä½¿ç”¨<<<image_1>>>ä¸­çš„ã€Xã€‘ï¼Œæ›¿æ¢<<<video_1>>>ä¸­çš„ã€Yã€‘"
    åˆ é™¤å…ƒç´ : "åˆ é™¤<<<video_1>>>ä¸­çš„ã€Xã€‘"
    
    options å¯é€‰å‚æ•°:
    {
        "model_name": "kling-v1-6",      # æ¨¡å‹ç‰ˆæœ¬ï¼ˆé»˜è®¤ kling-v1-6ï¼‰
        "image_list": ["url1", "url2"],  # å›¾ç‰‡åˆ—è¡¨
            # å¢åŠ : 1-2å¼ ï¼Œå¿…å¡«
            # æ›¿æ¢: 1å¼ ï¼Œå¿…å¡«
            # åˆ é™¤: ä¸éœ€è¦
        "negative_prompt": "",
        "duration": "5",                 # è§†é¢‘æ—¶é•¿ "5" æˆ– "10"
        "mode": "std",                   # "std" æˆ– "pro"
        "callback_url": "url",
        "external_task_id": "xxx"
    }
    """
```

### 3.4 åŠ¨ä½œæ§åˆ¶ï¼ˆä¿æŒåŸåŠ¨ä½œï¼‰

```python
# ç«¯ç‚¹: POST /v1/videos/motion-control

async def create_motion_control_task(
    self,
    image_url: str,              # å¿…å¡«ï¼šå‚è€ƒå›¾åƒï¼ˆäººç‰©éœ€éœ²å‡ºæ¸…æ™°ä¸ŠåŠèº«æˆ–å…¨èº«ï¼‰
    video_url: str,              # å¿…å¡«ï¼šå‚è€ƒè§†é¢‘ï¼ˆåŠ¨ä½œæ¥æºï¼Œ3-30ç§’ï¼Œ.mp4/.movï¼‰
    character_orientation: str,  # å¿…å¡«ï¼šäººç‰©æœå‘
        # "image": ä¸å›¾ç‰‡ä¸€è‡´ï¼ˆâ‰¤10ç§’ï¼‰
        # "video": ä¸è§†é¢‘ä¸€è‡´ï¼ˆâ‰¤30ç§’ï¼‰
    mode: str,                   # å¿…å¡«ï¼šç”Ÿæˆæ¨¡å¼ "std" æˆ– "pro"
    options: Dict = None
) -> Dict:
    """
    options å¯é€‰å‚æ•°:
    {
        "prompt": "",                    # æç¤ºè¯ï¼ˆâ‰¤2500å­—ç¬¦ï¼‰
        "keep_original_sound": "yes",    # æ˜¯å¦ä¿ç•™åŸå£° "yes"/"no"
        "callback_url": "url",
        "external_task_id": "xxx"
    }
    """
```

### 3.5 Omni-Image é«˜çº§å›¾åƒç¼–è¾‘

```python
# ç«¯ç‚¹: POST /v1/images/omni-image

async def create_omni_image_task(
    self,
    prompt: str,                  # å¿…å¡«ï¼šæç¤ºè¯ï¼ˆä½¿ç”¨ <<<image_1>>> å¼•ç”¨å›¾ç‰‡ï¼‰
    image_list: list = None,      # å‚è€ƒå›¾åˆ—è¡¨ [{"image": "urlæˆ–base64"}, ...]
    element_list: list = None,    # ä¸»ä½“å‚è€ƒåˆ—è¡¨ [{"element_id": 123}, ...]
    options: Dict = None
) -> Dict:
    """
    å›¾ç‰‡æ•°é‡ + ä¸»ä½“æ•°é‡ <= 10
    
    options å¯é€‰å‚æ•°:
    {
        "model_name": "kling-v2-1",     # é»˜è®¤ kling-v2-1
        "resolution": "1k",             # æ¸…æ™°åº¦ "1k" æˆ– "2k"
        "n": 1,                         # ç”Ÿæˆæ•°é‡ [1,9]
        "aspect_ratio": "16:9",         # ç”»é¢æ¯”ä¾‹ï¼ˆæ”¯æŒ "auto"ï¼‰
            # å¯é€‰: 16:9/9:16/1:1/4:3/3:4/3:2/2:3/21:9/auto
        "callback_url": "url",
        "external_task_id": "xxx"
    }
    """
```

---

## å››ã€ç­–ç•¥Aï¼šçº¯èƒŒæ™¯æ›¿æ¢ï¼ˆä½¿ç”¨å¯çµ I2V / Multi-Elementsï¼‰

å½“ç”¨æˆ·**åªç¼–è¾‘äº†èƒŒæ™¯**æ—¶ï¼Œä½¿ç”¨æ­¤ç­–ç•¥ã€‚

### æ–¹æ¡ˆå¯¹æ¯”

| æ–¹æ¡ˆ | è¯´æ˜ | ä¼˜åŠ¿ | åŠ£åŠ¿ |
|-----|------|-----|-----|
| **æ–¹æ¡ˆA1ï¼šæŠ å›¾ + I2V + åˆæˆ** | æŠ å‡ºäººç‰©ï¼ŒèƒŒæ™¯å•ç‹¬åŠ¨æ€åŒ–ï¼Œå†åˆæˆ | å£å‹100%ä¿æŒ | éœ€è¦åˆ†å‰²+åˆæˆ |
| **æ–¹æ¡ˆA2ï¼šMulti-Elements swap** | ç›´æ¥ç”¨å¯çµå¤šæ¨¡æ€ç¼–è¾‘æ›¿æ¢èƒŒæ™¯ | ç«¯åˆ°ç«¯ï¼Œä¸€æ­¥å®Œæˆ | è§†é¢‘æ—¶é•¿æœ‰é™åˆ¶ |

### æ–¹æ¡ˆA1ï¼šæŠ å›¾åˆæˆå·¥ä½œæµï¼ˆæ¨èï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç­–ç•¥A1ï¼šæŠ å›¾åˆæˆå·¥ä½œæµï¼ˆä½¿ç”¨å¯çµ I2Vï¼‰                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  åŸå§‹è§†é¢‘                                                                    â”‚
â”‚     â”‚                                                                       â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                     â”‚
â”‚     â”‚                 â”‚                                                     â”‚
â”‚     â–¼                 â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”‚
â”‚  â”‚ æŠ å›¾    â”‚     â”‚ æå–éŸ³é¢‘    â”‚                                              â”‚
â”‚  â”‚ SAM2   â”‚     â”‚            â”‚                                              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚     â”‚                 â”‚                                                     â”‚
â”‚     â–¼                 â”‚                                                     â”‚
â”‚  äººç‰©åºåˆ—             â”‚                                                     â”‚
â”‚  (å¸¦Alpha)            â”‚                                                     â”‚
â”‚     â”‚                 â”‚                                                     â”‚
â”‚     â”‚   ç¼–è¾‘åèƒŒæ™¯å›¾   â”‚                                                     â”‚
â”‚     â”‚        â”‚        â”‚                                                     â”‚
â”‚     â”‚        â–¼        â”‚                                                     â”‚
â”‚     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚     â”‚   â”‚ å¯çµ I2V: create_image_to_video_task() â”‚                          â”‚
â”‚     â”‚   â”‚                                        â”‚                          â”‚
â”‚     â”‚   â”‚ å‚æ•°:                                   â”‚                          â”‚
â”‚     â”‚   â”‚   image: ç¼–è¾‘åèƒŒæ™¯å›¾ URL               â”‚                          â”‚
â”‚     â”‚   â”‚   prompt: "natural movement, ..."      â”‚                          â”‚
â”‚     â”‚   â”‚   options: {                           â”‚                          â”‚
â”‚     â”‚   â”‚     "model_name": "kling-v2-5-turbo",  â”‚                          â”‚
â”‚     â”‚   â”‚     "duration": "5",    â† å­—ç¬¦ä¸²ï¼      â”‚                          â”‚
â”‚     â”‚   â”‚     "mode": "std"                      â”‚                          â”‚
â”‚     â”‚   â”‚   }                                    â”‚                          â”‚
â”‚     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚     â”‚        â”‚                                                              â”‚
â”‚     â”‚        â–¼                                                              â”‚
â”‚     â”‚   åŠ¨æ€èƒŒæ™¯è§†é¢‘                                                         â”‚
â”‚     â”‚        â”‚                                                              â”‚
â”‚     â–¼        â–¼        â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                â”‚
â”‚  â”‚       è§†é¢‘åˆæˆ           â”‚                                                â”‚
â”‚  â”‚  äººç‰© + èƒŒæ™¯ + éŸ³é¢‘      â”‚                                                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                â”‚
â”‚              â”‚                                                              â”‚
â”‚              â–¼                                                              â”‚
â”‚         æœ€ç»ˆè§†é¢‘                                                             â”‚
â”‚    ï¼ˆå£å‹ 100% ä¿æŒï¼‰                                                        â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ä»£ç å®ç°

```python
from app.services.kling_ai_service import KlingAIClient

async def run_strategy_a1(
    original_video_url: str,
    edited_background_url: str,
    person_mask_sequence: List[str]  # ä» SAM2 è·å–çš„äººç‰©åºåˆ—
) -> str:
    """
    ç­–ç•¥A1ï¼šæŠ å›¾ + I2V + åˆæˆ
    """
    client = KlingAIClient()
    
    # Step 1: ç”¨å¯çµç”ŸæˆåŠ¨æ€èƒŒæ™¯
    i2v_result = await client.create_image_to_video_task(
        image=edited_background_url,
        prompt="natural movement, gentle motion, maintain scene consistency",
        options={
            "model_name": "kling-v2-5-turbo",  # å¿«é€Ÿé«˜è´¨é‡
            "duration": "5",                   # âš ï¸ å¿…é¡»æ˜¯å­—ç¬¦ä¸² "5" æˆ– "10"
            "mode": "std",                     # "std" æ ‡å‡† / "pro" é«˜å“è´¨
            "cfg_scale": 0.5                   # 0-1ï¼Œè¶Šå¤§è¶Šè´´è¿‘æç¤ºè¯
        }
    )
    
    task_id = i2v_result.get("data", {}).get("task_id")
    
    # Step 2: è½®è¯¢ç­‰å¾…ç»“æœ
    while True:
        status = await client.get_image_to_video_task(task_id)
        task_status = status.get("data", {}).get("task_status")
        
        if task_status == "succeed":
            background_video_url = status["data"]["task_result"]["videos"][0]["url"]
            break
        elif task_status == "failed":
            raise RuntimeError(status.get("data", {}).get("task_status_msg"))
        
        await asyncio.sleep(5)
    
    # Step 3: åˆæˆï¼ˆäººç‰©å åŠ åˆ°èƒŒæ™¯ï¼‰
    final_video = await composite_video(
        foreground_sequence=person_mask_sequence,
        background_video=background_video_url,
        original_audio=await extract_audio(original_video_url)
    )
    
    return final_video
```

### æ–¹æ¡ˆA2ï¼šMulti-Elements ç›´æ¥æ¢èƒŒæ™¯

```python
async def run_strategy_a2(
    original_video_url: str,
    new_background_image_url: str
) -> str:
    """
    ç­–ç•¥A2ï¼šä½¿ç”¨å¯çµå¤šæ¨¡æ€ç¼–è¾‘ç›´æ¥æ¢èƒŒæ™¯ï¼ˆç«¯åˆ°ç«¯ï¼‰
    
    âš ï¸ é™åˆ¶ï¼šè§†é¢‘æ—¶é•¿ 2-5ç§’ æˆ– 7-10ç§’
    """
    client = KlingAIClient()
    
    # Step 1: åˆå§‹åŒ–è§†é¢‘
    init_result = await client.init_video_selection(video_url=original_video_url)
    session_id = init_result.get("data", {}).get("session_id")
    
    # Step 2: æ ‡è®°èƒŒæ™¯åŒºåŸŸï¼ˆé€‰æ‹©äººç‰©ä»¥å¤–çš„åŒºåŸŸï¼‰
    # è¿™é‡Œéœ€è¦å…ˆæ£€æµ‹äººç‰©ä½ç½®ï¼Œç„¶åç‚¹é€‰èƒŒæ™¯
    await client.add_video_selection(
        session_id=session_id,
        frame_index=0,
        points=[{"x": 0.1, "y": 0.1}]  # ç‚¹é€‰èƒŒæ™¯åŒºåŸŸ
    )
    
    # Step 3: æ‰§è¡Œæ›¿æ¢
    edit_result = await client.create_multi_elements_task(
        session_id=session_id,
        edit_mode="swap",  # âš ï¸ å¿…é¡»æ˜¯ "addition" / "swap" / "removal"
        prompt="ä½¿ç”¨<<<image_1>>>ä¸­çš„èƒŒæ™¯ï¼Œæ›¿æ¢<<<video_1>>>ä¸­çš„èƒŒæ™¯",
        options={
            "model_name": "kling-v1-6",
            "image_list": [new_background_image_url],  # æ–°èƒŒæ™¯å›¾ç‰‡
            "duration": "5",  # âš ï¸ å­—ç¬¦ä¸²
            "mode": "std"
        }
    )
    
    task_id = edit_result.get("data", {}).get("task_id")
    
    # Step 4: è½®è¯¢ç»“æœ
    while True:
        status = await client.get_multi_elements_task(task_id)
        if status.get("data", {}).get("task_status") == "succeed":
            return status["data"]["task_result"]["videos"][0]["url"]
        elif status.get("data", {}).get("task_status") == "failed":
            raise RuntimeError(status.get("data", {}).get("task_status_msg"))
        await asyncio.sleep(5)
```

### ä¼˜åŠ¿
- âœ… å£å‹å®Œç¾ä¿æŒï¼ˆäººç‰©åƒç´ ä¸å˜ï¼‰
- âœ… åŠ¨ä½œå®Œç¾ä¿æŒ
- âœ… äººç‰©ä¸€è‡´æ€§ 100%
- âœ… ç”Ÿæˆé€Ÿåº¦å¿«
- âœ… è´¨é‡å¯æ§

---

## äº”ã€ç­–ç•¥Bï¼šäººç‰©é‡å»ºï¼ˆä½¿ç”¨å¯çµ Lip Syncï¼‰

å½“ç”¨æˆ·**ç¼–è¾‘äº†äººç‰©åŒºåŸŸ**ï¼ˆå¦‚åŠ é¢†å¸¦ã€æ¢æœé¥°ï¼‰æ—¶ï¼Œä½¿ç”¨æ­¤ç­–ç•¥ã€‚

### æ ¸å¿ƒå‘ç°ï¼šå¯çµ Lip Sync å¯ä»¥ç›´æ¥ç”¨ï¼

å¯çµçš„ `advanced-lip-sync` æ¥å£æœ¬è´¨æ˜¯ï¼š
- **è¾“å…¥**ï¼šåŸè§†é¢‘ + æ–°éŸ³é¢‘
- **è¾“å‡º**ï¼šå£å‹åŒæ­¥çš„æ–°è§†é¢‘

ä½†æˆ‘ä»¬å¯ä»¥æ¢ä¸ªæ€è·¯ï¼š
1. å…ˆç”¨ **Omni-Image** æˆ–æ‰‹åŠ¨ç¼–è¾‘ç”Ÿæˆæ–°çš„äººç‰©é™æ€å›¾
2. ç”¨ **Motion Control** è®©é™æ€å›¾æŒ‰åŸè§†é¢‘åŠ¨ä½œåŠ¨èµ·æ¥
3. ç”¨ **Lip Sync** æŠŠéŸ³é¢‘å¯¹ä¸Šå£å‹

### å·¥ä½œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç­–ç•¥Bï¼šä½¿ç”¨å¯çµ Lip Sync + Motion Control                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  åŸå§‹è§†é¢‘                       ç¼–è¾‘åçš„äººç‰©å›¾ç‰‡                              â”‚
â”‚     â”‚                              â”‚                                        â”‚
â”‚     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚                                        â”‚
â”‚     â”‚          â”‚          â”‚        â”‚                                        â”‚
â”‚     â–¼          â”‚          â”‚        â”‚                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”      â”‚          â”‚        â”‚                                        â”‚
â”‚  â”‚æå–   â”‚      â”‚          â”‚        â”‚                                        â”‚
â”‚  â”‚éŸ³é¢‘   â”‚      â”‚          â”‚        â”‚                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”˜      â”‚          â”‚        â”‚                                        â”‚
â”‚     â”‚          â”‚          â”‚        â”‚                                        â”‚
â”‚     â”‚          â–¼          â”‚        â–¼                                        â”‚
â”‚     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚   â”‚        å¯çµ Motion Control               â”‚                         â”‚
â”‚     â”‚   â”‚  create_motion_control_task()           â”‚                         â”‚
â”‚     â”‚   â”‚                                         â”‚                         â”‚
â”‚     â”‚   â”‚  å‚æ•°:                                   â”‚                         â”‚
â”‚     â”‚   â”‚    image_url: ç¼–è¾‘åäººç‰©å›¾               â”‚                         â”‚
â”‚     â”‚   â”‚    video_url: åŸå§‹è§†é¢‘ï¼ˆæä¾›åŠ¨ä½œï¼‰        â”‚                         â”‚
â”‚     â”‚   â”‚    character_orientation: "video"       â”‚                         â”‚
â”‚     â”‚   â”‚    mode: "pro"                          â”‚                         â”‚
â”‚     â”‚   â”‚    options: {                           â”‚                         â”‚
â”‚     â”‚   â”‚      "keep_original_sound": "yes"       â”‚                         â”‚
â”‚     â”‚   â”‚    }                                    â”‚                         â”‚
â”‚     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚     â”‚                    â”‚                                                  â”‚
â”‚     â”‚                    â–¼                                                  â”‚
â”‚     â”‚            æ–°å¤–è§‚åŠ¨æ€è§†é¢‘                                              â”‚
â”‚     â”‚           ï¼ˆåŠ¨ä½œå·²åŒæ­¥ï¼Œä½†å£å‹å¯èƒ½ä¸å‡†ï¼‰                                â”‚
â”‚     â”‚                    â”‚                                                  â”‚
â”‚     â”‚                    â–¼                                                  â”‚
â”‚     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â”‚   â”‚         Step 1: identify_face()         â”‚                         â”‚
â”‚     â”‚   â”‚         è¯†åˆ«è§†é¢‘ä¸­çš„äººè„¸                  â”‚                         â”‚
â”‚     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚     â”‚                    â”‚                                                  â”‚
â”‚     â”‚                    â–¼ session_id + face_id                             â”‚
â”‚     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚     â–¼   â”‚         Step 2: create_lip_sync_task()  â”‚                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”‚                                         â”‚                         â”‚
â”‚  éŸ³é¢‘    â”‚  å‚æ•°:                                   â”‚                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”‚    session_id: ä¸Šä¸€æ­¥è¿”å›                â”‚                         â”‚
â”‚         â”‚    face_id: ä¸Šä¸€æ­¥è¿”å›                   â”‚                         â”‚
â”‚         â”‚    audio_url: åŸè§†é¢‘éŸ³é¢‘                 â”‚                         â”‚
â”‚         â”‚    sound_volume: 1.0                    â”‚                         â”‚
â”‚         â”‚    original_audio_volume: 0.0           â”‚ â† é™éŸ³åŸè§†é¢‘å£°éŸ³          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚                          â”‚                                                  â”‚
â”‚                          â–¼                                                  â”‚
â”‚                   æœ€ç»ˆå£å‹åŒæ­¥è§†é¢‘                                           â”‚
â”‚                 ï¼ˆæ–°å¤–è§‚ + åŸåŠ¨ä½œ + å£å‹åŒæ­¥ï¼‰                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®Œæ•´ä»£ç å®ç°

```python
from app.services.kling_ai_service import KlingAIClient
import asyncio

async def run_strategy_b(
    original_video_url: str,
    edited_person_image_url: str,
    original_audio_url: str
) -> str:
    """
    ç­–ç•¥Bï¼šäººç‰©é‡å»º + å£å‹åŒæ­¥
    
    ä½¿ç”¨å¯çµ Motion Control + Lip Sync å®ç°
    """
    client = KlingAIClient()
    
    # ============ Phase 1: Motion Control ============
    # è®©ç¼–è¾‘åçš„é™æ€äººç‰©å›¾ç‰‡æŒ‰åŸè§†é¢‘åŠ¨ä½œåŠ¨èµ·æ¥
    
    motion_result = await client.create_motion_control_task(
        image_url=edited_person_image_url,  # ç”¨æˆ·ç¼–è¾‘åçš„äººç‰©å›¾
        video_url=original_video_url,        # åŸè§†é¢‘æä¾›åŠ¨ä½œå‚è€ƒ
        character_orientation="video",       # âš ï¸ å¿…é¡»æ˜¯ "image" æˆ– "video"
        mode="pro",                          # âš ï¸ å¿…é¡»æ˜¯ "std" æˆ– "pro"
        options={
            "keep_original_sound": "yes",    # âš ï¸ å¿…é¡»æ˜¯ "yes" æˆ– "no"
            "prompt": "maintain facial features, natural movement"
        }
    )
    
    motion_task_id = motion_result.get("data", {}).get("task_id")
    
    # ç­‰å¾… Motion Control å®Œæˆ
    while True:
        status = await client.get_motion_control_task(motion_task_id)
        task_status = status.get("data", {}).get("task_status")
        
        if task_status == "succeed":
            motion_video_url = status["data"]["task_result"]["videos"][0]["url"]
            break
        elif task_status == "failed":
            raise RuntimeError(f"Motion Control å¤±è´¥: {status.get('data', {}).get('task_status_msg')}")
        
        await asyncio.sleep(5)
    
    # ============ Phase 2: Lip Sync ============
    # å¯¹ç”Ÿæˆçš„è§†é¢‘è¿›è¡Œå£å‹åŒæ­¥
    
    # Step 2.1: è¯†åˆ«äººè„¸
    face_result = await client.identify_face(video_url=motion_video_url)
    
    session_id = face_result.get("session_id")
    face_data = face_result.get("face_data", [])
    
    if not face_data:
        raise RuntimeError("æœªæ£€æµ‹åˆ°äººè„¸")
    
    face_id = face_data[0]["face_id"]
    
    # Step 2.2: åˆ›å»ºå¯¹å£å‹ä»»åŠ¡
    lip_sync_result = await client.create_lip_sync_task(
        session_id=session_id,
        face_id=face_id,
        audio_url=original_audio_url,       # åŸè§†é¢‘çš„éŸ³é¢‘
        sound_volume=1.0,                   # éŸ³é¢‘éŸ³é‡ [0, 2]
        original_audio_volume=0.0           # âš ï¸ è®¾ä¸º0é™éŸ³åŸè§†é¢‘å£°éŸ³ï¼Œé¿å…é‡å¤
    )
    
    lip_sync_task_id = lip_sync_result.get("task_id")
    
    # Step 2.3: ç­‰å¾…å®Œæˆ
    while True:
        status = await client.get_lip_sync_task(lip_sync_task_id)
        task_status = status.get("task_status")
        
        if task_status == "succeed":
            return status["task_result"]["videos"][0]["url"]
        elif task_status == "failed":
            raise RuntimeError(f"Lip Sync å¤±è´¥: {status.get('task_status_msg')}")
        
        await asyncio.sleep(5)
```

### ç­–ç•¥B çš„é™åˆ¶ä¸æ³¨æ„äº‹é¡¹

| é¡¹ç›® | è¯´æ˜ |
|-----|------|
| **Motion Control æ—¶é•¿** | `character_orientation="image"` æœ€å¤š10ç§’ï¼Œ`"video"` æœ€å¤š30ç§’ |
| **Lip Sync è¦æ±‚** | è§†é¢‘ä¸­å¿…é¡»æœ‰æ¸…æ™°äººè„¸ |
| **éŸ³é¢‘æ ¼å¼** | æ”¯æŒå¸¸è§æ ¼å¼ï¼Œå»ºè®® MP3/WAV |
| **äººç‰©å§¿æ€** | å‚è€ƒå›¾éœ€éœ²å‡ºæ¸…æ™°ä¸ŠåŠèº«æˆ–å…¨èº« |

---

## å…­ã€å®Œæ•´ Agent Workflow æ¶æ„

### 1. å†³ç­–ä¸æ‰§è¡Œæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å›¾ç”Ÿè§†é¢‘ Agent Workflow æ¶æ„ï¼ˆä½¿ç”¨å¯çµ APIï¼‰              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  å‰ç«¯                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ ç”¨æˆ·åœ¨å›¾ç‰‡ä¸Š  â”‚ -> â”‚ è‡ªåŠ¨æ£€æµ‹ç¼–è¾‘  â”‚ -> â”‚ è°ƒç”¨ API å¼€å§‹ç”Ÿæˆ     â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ è‡ªç”±ç»˜ç”»     â”‚    â”‚ åŒºåŸŸ(ç­–ç•¥A/B) â”‚    â”‚ /api/video-generate  â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                   â”‚                â”‚   â”‚
â”‚  â”‚                                                   â–¼                â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚              å®æ—¶è¿›åº¦å±•ç¤ºï¼ˆSSEï¼‰                              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  [é˜¶æ®µ1: ç¼–è¾‘æ£€æµ‹] [é˜¶æ®µ2: å¯çµAPIè°ƒç”¨] [é˜¶æ®µ3: åˆæˆ] ...      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  åç«¯ Agent Workflow                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚   â”‚
â”‚  â”‚  â”‚ Agent 0:     â”‚                                                   â”‚   â”‚
â”‚  â”‚  â”‚ EditDetector â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚   â”‚
â”‚  â”‚  â”‚ (ç¼–è¾‘æ£€æµ‹)    â”‚                                      â”‚            â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                      â”‚            â”‚   â”‚
â”‚  â”‚         â”‚                                              â”‚            â”‚   â”‚
â”‚  â”‚         â”œâ”€â”€â”€ background_only â”€â”€â”€â”                      â”‚            â”‚   â”‚
â”‚  â”‚         â”‚                       â”‚                      â”‚            â”‚   â”‚
â”‚  â”‚         â”‚                       â–¼                      â–¼            â”‚   â”‚
â”‚  â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚  â”‚         â”‚              â”‚ ç­–ç•¥A Pipeline  â”‚    â”‚ ç­–ç•¥B Pipeline  â”‚   â”‚   â”‚
â”‚  â”‚         â”‚              â”‚                 â”‚    â”‚                 â”‚   â”‚   â”‚
â”‚  â”‚         â”‚              â”‚ å¯çµ I2V        â”‚    â”‚ å¯çµ Motion     â”‚   â”‚   â”‚
â”‚  â”‚         â”‚              â”‚ æˆ– Multi-Elem   â”‚    â”‚ å¯çµ Lip Sync   â”‚   â”‚   â”‚
â”‚  â”‚         â”‚              â”‚                 â”‚    â”‚                 â”‚   â”‚   â”‚
â”‚  â”‚         â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚  â”‚         â”‚                       â”‚                      â”‚            â”‚   â”‚
â”‚  â”‚         â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚   â”‚
â”‚  â”‚         â”‚                                  â”‚                        â”‚   â”‚
â”‚  â”‚         â”‚                                  â–¼                        â”‚   â”‚
â”‚  â”‚         â”‚                            æœ€ç»ˆè§†é¢‘                        â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”‚  å¤–éƒ¨æœåŠ¡                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚ å¯çµ Kling   â”‚    â”‚ Supabase     â”‚    â”‚ å¯¹è±¡å­˜å‚¨              â”‚  â”‚   â”‚
â”‚  â”‚  â”‚ (è§†é¢‘ç”Ÿæˆ)   â”‚    â”‚ (çŠ¶æ€å­˜å‚¨)    â”‚    â”‚ (è§†é¢‘/å›¾ç‰‡å­˜å‚¨)       â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2. åç«¯æœåŠ¡è®¾è®¡

```python
# backend/app/services/video_generation_workflow.py

from enum import Enum
from typing import Callable, Optional
from app.services.kling_ai_service import KlingAIClient

class EditType(Enum):
    BACKGROUND_ONLY = "background_only"  # åªç¼–è¾‘èƒŒæ™¯ â†’ ç­–ç•¥A
    PERSON_EDITED = "person_edited"      # ç¼–è¾‘äº†äººç‰© â†’ ç­–ç•¥B


class VideoGenerationWorkflow:
    """
    å›¾ç”Ÿè§†é¢‘å·¥ä½œæµæ§åˆ¶å™¨
    ä½¿ç”¨å·²é›†æˆçš„å¯çµ API
    """
    
    def __init__(self):
        self.kling = KlingAIClient()
    
    async def run(
        self,
        original_video_url: str,
        edited_frame_url: str,
        original_audio_url: str,
        edit_type: EditType,
        on_progress: Optional[Callable[[str, float], None]] = None
    ) -> str:
        """
        æ‰§è¡Œå›¾ç”Ÿè§†é¢‘å·¥ä½œæµ
        
        Args:
            original_video_url: åŸå§‹è§†é¢‘ URL
            edited_frame_url: ç”¨æˆ·ç¼–è¾‘åçš„å¸§å›¾ç‰‡ URL
            original_audio_url: åŸè§†é¢‘éŸ³é¢‘ URL
            edit_type: ç¼–è¾‘ç±»å‹ï¼ˆå†³å®šç­–ç•¥ï¼‰
            on_progress: è¿›åº¦å›è°ƒ (stage_name, progress_0_to_1)
            
        Returns:
            final_video_url: ç”Ÿæˆçš„è§†é¢‘ URL
        """
        if on_progress:
            on_progress("å¼€å§‹å¤„ç†", 0.0)
        
        if edit_type == EditType.BACKGROUND_ONLY:
            return await self._run_strategy_a(
                original_video_url, 
                edited_frame_url, 
                on_progress
            )
        else:
            return await self._run_strategy_b(
                original_video_url, 
                edited_frame_url, 
                original_audio_url,
                on_progress
            )
    
    async def _run_strategy_a(
        self, 
        video_url: str, 
        edited_frame_url: str, 
        on_progress: Optional[Callable]
    ) -> str:
        """
        ç­–ç•¥Aï¼šä½¿ç”¨å¯çµ I2V ç”ŸæˆåŠ¨æ€èƒŒæ™¯
        """
        if on_progress:
            on_progress("èƒŒæ™¯åŠ¨æ€åŒ–", 0.2)
        
        # è°ƒç”¨å¯çµ I2V
        result = await self.kling.create_image_to_video_task(
            image=edited_frame_url,
            prompt="natural movement, gentle motion, maintain scene consistency",
            options={
                "model_name": "kling-v2-5-turbo",
                "duration": "5",    # âš ï¸ å­—ç¬¦ä¸²ç±»å‹
                "mode": "std"
            }
        )
        
        task_id = result.get("data", {}).get("task_id")
        
        if on_progress:
            on_progress("ç­‰å¾…ç”Ÿæˆ", 0.4)
        
        # è½®è¯¢ç­‰å¾…
        final_url = await self._poll_i2v_task(task_id, on_progress)
        
        if on_progress:
            on_progress("å®Œæˆ", 1.0)
        
        return final_url
    
    async def _run_strategy_b(
        self, 
        video_url: str, 
        edited_frame_url: str,
        audio_url: str,
        on_progress: Optional[Callable]
    ) -> str:
        """
        ç­–ç•¥Bï¼šä½¿ç”¨å¯çµ Motion Control + Lip Sync
        """
        # Phase 1: Motion Control
        if on_progress:
            on_progress("åŠ¨ä½œè¿ç§»", 0.1)
        
        motion_result = await self.kling.create_motion_control_task(
            image_url=edited_frame_url,
            video_url=video_url,
            character_orientation="video",
            mode="pro",
            options={"keep_original_sound": "yes"}
        )
        
        motion_task_id = motion_result.get("data", {}).get("task_id")
        motion_video = await self._poll_motion_task(motion_task_id, on_progress)
        
        # Phase 2: Lip Sync
        if on_progress:
            on_progress("äººè„¸è¯†åˆ«", 0.5)
        
        face_result = await self.kling.identify_face(video_url=motion_video)
        session_id = face_result.get("session_id")
        face_id = face_result.get("face_data", [{}])[0].get("face_id")
        
        if not face_id:
            raise RuntimeError("æœªæ£€æµ‹åˆ°äººè„¸")
        
        if on_progress:
            on_progress("å£å‹åŒæ­¥", 0.6)
        
        lip_result = await self.kling.create_lip_sync_task(
            session_id=session_id,
            face_id=face_id,
            audio_url=audio_url,
            sound_volume=1.0,
            original_audio_volume=0.0  # é™éŸ³åŸè§†é¢‘å£°éŸ³
        )
        
        lip_task_id = lip_result.get("task_id")
        final_url = await self._poll_lip_sync_task(lip_task_id, on_progress)
        
        if on_progress:
            on_progress("å®Œæˆ", 1.0)
        
        return final_url
    
    async def _poll_i2v_task(self, task_id: str, on_progress: Optional[Callable]) -> str:
        """è½®è¯¢ I2V ä»»åŠ¡"""
        import asyncio
        
        for i in range(120):  # æœ€å¤šç­‰å¾… 10 åˆ†é’Ÿ
            status = await self.kling.get_image_to_video_task(task_id)
            task_status = status.get("data", {}).get("task_status")
            
            if task_status == "succeed":
                return status["data"]["task_result"]["videos"][0]["url"]
            elif task_status == "failed":
                raise RuntimeError(status.get("data", {}).get("task_status_msg", "ç”Ÿæˆå¤±è´¥"))
            
            if on_progress:
                on_progress("ç”Ÿæˆä¸­", 0.4 + i * 0.004)
            
            await asyncio.sleep(5)
        
        raise TimeoutError("I2V ä»»åŠ¡è¶…æ—¶")
    
    async def _poll_motion_task(self, task_id: str, on_progress: Optional[Callable]) -> str:
        """è½®è¯¢ Motion Control ä»»åŠ¡"""
        import asyncio
        
        for i in range(120):
            status = await self.kling.get_motion_control_task(task_id)
            task_status = status.get("data", {}).get("task_status")
            
            if task_status == "succeed":
                return status["data"]["task_result"]["videos"][0]["url"]
            elif task_status == "failed":
                raise RuntimeError(status.get("data", {}).get("task_status_msg", "åŠ¨ä½œæ§åˆ¶å¤±è´¥"))
            
            if on_progress:
                on_progress("åŠ¨ä½œç”Ÿæˆä¸­", 0.1 + i * 0.003)
            
            await asyncio.sleep(5)
        
        raise TimeoutError("Motion Control ä»»åŠ¡è¶…æ—¶")
    
    async def _poll_lip_sync_task(self, task_id: str, on_progress: Optional[Callable]) -> str:
        """è½®è¯¢ Lip Sync ä»»åŠ¡"""
        import asyncio
        
        for i in range(120):
            status = await self.kling.get_lip_sync_task(task_id)
            task_status = status.get("task_status")
            
            if task_status == "succeed":
                return status["task_result"]["videos"][0]["url"]
            elif task_status == "failed":
                raise RuntimeError(status.get("task_status_msg", "å£å‹åŒæ­¥å¤±è´¥"))
            
            if on_progress:
                on_progress("å£å‹åŒæ­¥ä¸­", 0.6 + i * 0.003)
            
            await asyncio.sleep(5)
        
        raise TimeoutError("Lip Sync ä»»åŠ¡è¶…æ—¶")
```

---

## ä¸ƒã€å¤‡é€‰æ–¹æ¡ˆï¼šRunningHubï¼ˆå¦‚å¯çµä¸æ»¡è¶³éœ€æ±‚ï¼‰

> ğŸ’¡ å¦‚æœå¯çµ API åœ¨æŸäº›åœºæ™¯ä¸‹æ•ˆæœä¸ç†æƒ³ï¼Œå¯ä»¥ä½¿ç”¨ RunningHub ä½œä¸ºå¤‡é€‰

### RunningHub ä¸‰ç§ API ç±»å‹

| API ç±»å‹ | è¯´æ˜ | è®¡è´¹æ–¹å¼ | é€‚ç”¨åœºæ™¯ |
|---------|------|---------|---------|
| **æ¨¡å‹ API** | ç›´æ¥è°ƒç”¨å•†ä¸šæ¨¡å‹ | æŒ‰æ¬¡è®¡è´¹ | ç®€å•ä»»åŠ¡ |
| **AIåº”ç”¨ API** | è°ƒç”¨å°è£…å¥½çš„åº”ç”¨ | æŒ‰è¿è¡Œæ—¶é•¿ | ç°æˆè§£å†³æ–¹æ¡ˆ |
| **ComfyUI å·¥ä½œæµ API** | è°ƒç”¨è‡ªå®šä¹‰å·¥ä½œæµ | æŒ‰è¿è¡Œæ—¶é•¿ | å¤æ‚å¤šæ­¥éª¤ä»»åŠ¡ |

### å¯ç”¨çš„å¤‡é€‰æ¨¡å‹

| æ¨¡å‹ | ç”¨é€” | é€‚ç”¨ç­–ç•¥ |
|-----|------|---------|
| **Wan2.2-S2V æ•°å­—äºº** | è¯­éŸ³é©±åŠ¨æ•°å­—äºº | ç­–ç•¥B å¤‡é€‰ |
| **FantasyTalking** | è¯­éŸ³é©±åŠ¨å…¨èº« | ç­–ç•¥B å¤‡é€‰ |
| **SkyReels TalkingAvatar** | è¯´è¯å¤´åƒ | ç­–ç•¥B å¤‡é€‰ |
| **Wan2.2 I2V** | å›¾ç”Ÿè§†é¢‘ | ç­–ç•¥A å¤‡é€‰ |
| **SAM2** | è§†é¢‘äººç‰©åˆ†å‰² | ä¸¤ç§ç­–ç•¥ |

---

## å…«ã€æ€»ç»“ä¸å»ºè®®

### æŠ€æœ¯æ–¹æ¡ˆé€ŸæŸ¥è¡¨

| åœºæ™¯ | æ¨èæ–¹æ¡ˆ | API æ–¹æ³• | å¤‡é€‰æ–¹æ¡ˆ |
|-----|---------|---------|---------|
| **åªæ¢èƒŒæ™¯** | å¯çµ I2V | `create_image_to_video_task()` | RunningHub Wan2.2 I2V |
| **ç›´æ¥æ¢èƒŒæ™¯** | å¯çµ Multi-Elements | `create_multi_elements_task()` | - |
| **æ”¹äº†äººç‰©+å£å‹** | å¯çµ Motion + Lip Sync | `create_motion_control_task()` â†’ `create_lip_sync_task()` | RunningHub Wan2.2-S2V |
| **åªéœ€å£å‹åŒæ­¥** | å¯çµ Lip Sync | `identify_face()` â†’ `create_lip_sync_task()` | - |

### ç­–ç•¥é€‰æ‹©é€ŸæŸ¥è¡¨

| ç”¨æˆ·æ“ä½œ | æ£€æµ‹æ–¹æ³• | é€‰æ‹©ç­–ç•¥ | æ ¸å¿ƒ API | å£å‹ | å¤æ‚åº¦ |
|---------|---------|---------|---------|-----|-------|
| åªç”»èƒŒæ™¯/åœºæ™¯ | ç¼–è¾‘åŒºåŸŸä¸äººç‰©maskæ— äº¤é›† | ç­–ç•¥A | `create_image_to_video_task` | âœ… ä¿æŒ | ä½ |
| ç”»äº†é¢†å¸¦/é…é¥° | ç¼–è¾‘åŒºåŸŸä¸äººç‰©maskæœ‰äº¤é›† | ç­–ç•¥B | `motion_control` + `lip_sync` | âš ï¸ é‡å»º | é«˜ |
| æ¢äº†æ•´å¥—æœé¥° | ç¼–è¾‘åŒºåŸŸè¦†ç›–äººç‰©ä¸»ä½“ | ç­–ç•¥B | `motion_control` + `lip_sync` | âš ï¸ é‡å»º | é«˜ |
| æ”¹äº†å‘å‹/å¦†å®¹ | ç¼–è¾‘åŒºåŸŸåœ¨å¤´éƒ¨ | ç­–ç•¥B | `motion_control` + `lip_sync` | âš ï¸ é‡å»º | é«˜ |

### å¯çµ API å‚æ•°é€ŸæŸ¥ï¼ˆâš ï¸ å…³é”®æ˜“é”™ç‚¹ï¼‰

| å‚æ•° | ç±»å‹ | æ˜“é”™ç‚¹ |
|-----|------|-------|
| `duration` | `str` | âš ï¸ å¿…é¡»æ˜¯å­—ç¬¦ä¸² `"5"` æˆ– `"10"`ï¼Œä¸æ˜¯æ•°å­—ï¼ |
| `mode` | `str` | åªèƒ½æ˜¯ `"std"` æˆ– `"pro"` |
| `character_orientation` | `str` | åªèƒ½æ˜¯ `"image"` æˆ– `"video"` |
| `keep_original_sound` | `str` | åªèƒ½æ˜¯ `"yes"` æˆ– `"no"`ï¼Œä¸æ˜¯å¸ƒå°”å€¼ï¼ |
| `sound` | `str` | åªèƒ½æ˜¯ `"on"` æˆ– `"off"`ï¼ˆä»… V2.6+ æ”¯æŒï¼‰ |
| `edit_mode` | `str` | åªèƒ½æ˜¯ `"addition"` / `"swap"` / `"removal"` |
| `cfg_scale` | `float` | èŒƒå›´ 0-1 |
| `sound_volume` | `float` | èŒƒå›´ 0-2 |

### æ¨èçš„äº§å“è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ç”¨æˆ·å®Œæˆå›¾ç‰‡ç¼–è¾‘å                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                â”‚
â”‚  æ£€æµ‹åˆ°ä½ ç¼–è¾‘äº† [äººç‰©åŒºåŸŸ / èƒŒæ™¯åŒºåŸŸ]                             â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â—‹ åªæ¢èƒŒæ™¯ï¼ˆæ¨èï¼‰                                      â”‚  â”‚
â”‚  â”‚    ä¿æŒåŸè§†é¢‘ä¸­çš„äººç‰©åŠ¨ä½œå’Œå£å‹ï¼Œåªæ›¿æ¢èƒŒæ™¯                 â”‚  â”‚
â”‚  â”‚    âš¡ ç”Ÿæˆå¿« | ğŸ¯ è´¨é‡é«˜ | ğŸ’° æˆæœ¬ä½                      â”‚  â”‚
â”‚  â”‚    ä½¿ç”¨ï¼šå¯çµ I2V                                        â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  â—‹ æ¢è£…/å˜è£…                                             â”‚  â”‚
â”‚  â”‚    ä½¿ç”¨ä½ ç¼–è¾‘çš„äººç‰©å¤–è§‚ï¼ŒAI é‡æ–°ç”Ÿæˆè¯´è¯è§†é¢‘                â”‚  â”‚
â”‚  â”‚    â³ è¾ƒæ…¢ | âš ï¸ å¯èƒ½æœ‰å·®å¼‚ | ğŸ’° æˆæœ¬è¾ƒé«˜                   â”‚  â”‚
â”‚  â”‚    ä½¿ç”¨ï¼šå¯çµ Motion Control + Lip Sync                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                â”‚
â”‚                        [ å¼€å§‹ç”Ÿæˆ ]                            â”‚
â”‚                                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **æµ‹è¯•å¯çµ API**
   - æµ‹è¯• I2V ç”Ÿæˆæ•ˆæœï¼ˆç­–ç•¥Aï¼‰
   - æµ‹è¯• Motion Control + Lip Sync æ•ˆæœï¼ˆç­–ç•¥Bï¼‰

2. **å®ç°ç¼–è¾‘æ£€æµ‹ç®—æ³•**
   - ä½¿ç”¨ç¬¬ä¸€ç« çš„ `detect_edit_strategy()` å‡½æ•°
   - æ¥å…¥ SAM2 è·å–äººç‰© mask

3. **é›†æˆåˆ°åç«¯**
   - åˆ›å»º `VideoGenerationWorkflow` æœåŠ¡
   - æ·»åŠ  API è·¯ç”± `/api/video-generate`

4. **æ›´æ–°å‰ç«¯äº¤äº’**
   - ç¼–è¾‘å®Œæˆåè‡ªåŠ¨æ£€æµ‹ç¼–è¾‘åŒºåŸŸ
   - æ˜¾ç¤ºç­–ç•¥æ¨èå¹¶è®©ç”¨æˆ·ç¡®è®¤

---

## ä¹ã€å‚è€ƒèµ„æº

### é¡¹ç›®å†…éƒ¨æ–‡æ¡£
- **å¯çµæœåŠ¡ä»£ç **: `backend/app/services/kling_ai_service.py`
- **å¯çµå®¢æˆ·ç«¯**: `backend/app/services/kling_client.py`
- **èƒŒæ™¯æ›¿æ¢å·¥ä½œæµ**: `backend/app/services/background_replace_workflow.py`

### å¯çµå®˜æ–¹æ–‡æ¡£
- **API æ–‡æ¡£**: https://platform.klingai.com/docs/api
- **å›¾ç”Ÿè§†é¢‘**: https://app.klingai.com/cn/dev/document-api/apiReference/model/imageToVideo
- **æ–‡ç”Ÿè§†é¢‘**: https://app.klingai.com/cn/dev/document-api/apiReference/model/textToVideo
- **åŠ¨ä½œæ§åˆ¶**: https://app.klingai.com/cn/dev/document-api/apiReference/model/motionControl
- **å¤šæ¨¡æ€ç¼–è¾‘**: https://app.klingai.com/cn/dev/document-api/apiReference/model/multiElements

### å¤‡é€‰æ–¹æ¡ˆèµ„æº
- **Wan2.2-S2V å®˜æ–¹**: https://github.com/aigc-apps/VideoX-Fun
- **Wan2.2-S2V æ¨¡å‹**: https://huggingface.co/Wan-AI/Wan2.2-S2V-14B
- **RunningHub æ–‡æ¡£**: https://docs.runninghub.cn/
- **ComfyUI Wiki**: https://comfyui-wiki.com/zh/tutorial/advanced/video/wan2.2/wan2-2-s2v
