# 代码审查标准 (Code Review Standards)

> 本文档定义了 HoppingRabbit AI 项目的代码审查标准，每次大开发完成后必须按此标准进行审查。
> 
> ⚠️ **重要**: 前后端交互相关规范请参阅 [前后端交互规范.md](./前后端交互规范.md)

---

## 📋 审查清单

### 0. 前后端交互检查 🔴 最高优先级

> 详细规范见 [前后端交互规范.md](./前后端交互规范.md)

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| **时间单位一致性** | 数据库/API/Store 使用毫秒，视频播放使用秒 | 🔴 高 |
| **字段命名转换** | 后端 snake_case ↔ 前端 camelCase 正确映射 | 🔴 高 |
| **关键帧格式** | offset 归一化 0-1，复合属性使用 `{x, y}` | 🔴 高 |
| **视频加载事件** | 使用 `canplay` 而非 `canplaythrough` | 🔴 高 |
| **sourceStart vs start** | 媒体源时间 vs 时间线位置，不可混淆 | 🔴 高 |

```typescript
// ❌ 错误：时间单位混淆
video.currentTime = currentTimeMs;  // 把毫秒当秒用

// ✅ 正确：明确转换
video.currentTime = currentTimeMs / 1000;

// ❌ 错误：字段名未转换
const clip = { start_time: data.startTime };  // 应该是 start_time: data.start

// ✅ 正确：统一使用映射
const clip = {
  start_time: data.start,
  source_start: data.sourceStart,
};
```

### 1. 冗余代码检查

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| **重复逻辑** | 相同或相似的逻辑在多处重复出现 | 🔴 高 |
| **未使用的变量/函数** | 定义了但从未使用的代码 | 🟡 中 |
| **重复计算** | 相同的计算在多个地方执行（应提取为 useMemo/函数） | 🔴 高 |
| **冗余状态** | 可以从其他状态派生的 state（应改为 useMemo） | 🔴 高 |
| **冗余注释** | 代码即文档，注释应精简且有价值 | 🟡 中 |

#### 1.1 冗余注释规范

**必须删除的注释类型：**

| 类型 | 示例 | 说明 |
|------|------|------|
| **显而易见** | `// 设置为 true` 后面跟着 `setIsPlaying(true)` | 代码已清晰表达 |
| **重复代码** | `// 计算宽度` 后面跟着 `const width = ...` | 变量名已说明 |
| **过时注释** | `// TODO: 待修复` 但问题已解决 | 应及时清理 |
| **分隔线注释** | `// ========== xxx ==========` | 用空行分隔即可 |
| **章节标题过多** | 每 5 行就有标题注释 | 保留关键节点即可 |

**应保留的注释类型：**

| 类型 | 示例 | 说明 |
|------|------|------|
| **为什么（Why）** | `// 使用 canplay 而非 canplaythrough，后者需完全缓冲` | 解释非直观决策 |
| **警告/陷阱** | `// ⚠️ 此处顺序不能调换，transform 从右到左应用` | 防止未来出错 |
| **复杂算法** | `// 使用二分查找优化 O(n) -> O(log n)` | 解释复杂逻辑 |
| **API 文档** | `/** @param offset 归一化时间 0-1 */` | JSDoc 保留 |

```typescript
// ❌ 冗余注释
// 检查是否正在播放
if (isPlaying) {
  // 暂停视频
  video.pause();
}

// ✅ 精简后
if (isPlaying) {
  video.pause();
}

// ❌ 过多分隔线
// ============================================
// 常量定义
// ============================================
const MAX_ZOOM = 3;
// ============================================
// 类型定义
// ============================================

// ✅ 用空行分隔
const MAX_ZOOM = 3;

interface VideoState { ... }
```

### 2. React 性能优化

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| **函数组件外定义工具函数** | 纯函数应移到组件外，避免每次渲染重新创建 | 🔴 高 |
| **useMemo 合理使用** | 计算密集或引用稳定性要求的值应使用 useMemo | 🟡 中 |
| **useCallback 合理使用** | 传递给子组件或作为依赖的函数应使用 useCallback | 🟡 中 |
| **细粒度 Store 订阅** | 只订阅需要的字段，避免订阅整个 store | 🔴 高 |
| **避免在渲染中创建对象/数组** | `style={{}}` 等应提取为常量或 useMemo | 🟡 中 |

### 3. useEffect 规范

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| **合并相关 useEffect** | 功能相关的 effect 应合并，减少副作用数量 | 🟡 中 |
| **依赖数组完整性** | 所有外部变量都应在依赖数组中 | 🔴 高 |
| **清理函数** | 订阅、定时器、事件监听必须有清理函数 | 🔴 高 |
| **避免不必要的 effect** | 可以在渲染时计算的不要用 effect | 🟡 中 |

### 3.5 调试日志规范

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| **禁止直接 console.log** | 生产环境不应向用户暴露日志 | 🔴 高 |
| **使用 debugLog 模式** | 封装条件日志，仅开发环境输出 | 🔴 高 |
| **避免高频日志** | progress 等事件需节流，避免刷屏 | 🟡 中 |

```typescript
// ✅ 正确：条件日志
const debugLog = (...args: unknown[]) => {
  if (process.env.NODE_ENV === 'development') {
    console.log(...args);
  }
};

// ❌ 错误：直接 console.log
console.log('视频加载完成'); // 生产环境用户可见
```

### 3.6 媒体加载规范

| 检查项 | 说明 | 严重程度 |
|--------|------|----------|
| **优先使用 canplay** | 不要用 canplaythrough，后者需完全缓冲 | 🔴 高 |
| **readyState >= 2 即可播放** | 无需等待 readyState=4 | 🔴 高 |
| **跨组件共享媒体缓存** | 使用全局 cache 避免重复加载 | 🟡 中 |
| **区分硬性慢与代码慢** | 网络/文件大小慢可接受，代码放大延迟必须修复 | 🔴 高 |

```typescript
// ✅ 正确：使用 canplay
video.addEventListener('canplay', () => {
  // readyState >= 3，可开始播放
  resolve(video);
});

// ❌ 错误：使用 canplaythrough
video.addEventListener('canplaythrough', () => {
  // readyState = 4，需完全缓冲，20秒视频可能等65秒
  resolve(video);
});
```

### 4. 代码组织结构

```tsx
// ✅ 推荐的组件结构
// 1. 常量定义（组件外）
// 2. 类型定义（组件外）
// 3. 工具函数（组件外）
// 4. 组件函数
//    4.1 Store 订阅
//    4.2 Refs
//    4.3 Local State
//    4.4 派生计算 (useMemo)
//    4.5 辅助函数 (useCallback)
//    4.6 Effects (useEffect)
//    4.7 事件处理器
//    4.8 渲染
```

### 5. 命名规范

| 类型 | 规范 | 示例 |
|------|------|------|
| **组件** | PascalCase | `VideoCanvas`, `TimelineTrack` |
| **函数/变量** | camelCase | `handlePlayPause`, `videoClips` |
| **常量** | UPPER_SNAKE_CASE | `MAX_ZOOM`, `SEEK_THRESHOLD` |
| **类型/接口** | PascalCase | `AspectRatio`, `ClipTransform` |
| **布尔值** | is/has/can/should 前缀 | `isPlaying`, `hasActiveVideo` |
| **事件处理器** | handle 前缀 | `handleClick`, `handleTimeUpdate` |

### 6. 状态管理规范

```tsx
// ❌ 错误：冗余状态
const [hasActiveVideo, setHasActiveVideo] = useState(true);
// 在多处手动同步更新...

// ✅ 正确：派生状态
const hasActiveVideo = activeVideoClip !== null;
```

```tsx
// ❌ 错误：订阅整个 store
const store = useEditorStore();

// ✅ 正确：细粒度订阅
const clips = useEditorStore((s) => s.clips);
const isPlaying = useEditorStore((s) => s.isPlaying);
```

---

## 🔍 审查记录

### 2026-01-14 关键帧系统重构 (Compound Keyframe Refactoring)

#### 重构背景

用户反馈：调整位置和缩放时，需要为 X/Y 分别创建关键帧（共 4 个），体验繁琐。后端已使用复合格式，前端需同步设计。

#### 架构变更

| 属性 | 重构前 | 重构后 |
|------|--------|--------|
| 位置 | `position_x`, `position_y` (2 个关键帧) | `position: {x, y}` (1 个关键帧) |
| 缩放 | `scale_x`, `scale_y` (2 个关键帧) | `scale: {x, y}` (1 个关键帧) |
| 旋转 | `rotation` (1 个关键帧) | 不变 |
| 不透明度 | `opacity` (1 个关键帧) | 不变 |

#### 修改的文件

1. **types/keyframe.ts** - 类型系统重写 (V3)
   - 新增 `CompoundKeyframeProperty`, `SimpleKeyframeProperty`, `CompoundValue`
   - 新增类型守卫 `isCompoundProperty()`, `isCompoundValue()`
   - 新增 `PROPERTY_CONFIGS` 支持复合属性配置
   - 新增 `LEGACY_PROPERTY_MAP` 支持旧数据迁移

2. **lib/keyframe-interpolation.ts** - 插值逻辑重写
   - 新增 `interpolateCompound()` 处理 `{x, y}` 插值
   - `getClipTransformAtOffset()` 优先使用复合属性，回退到旧格式
   - 新增 `migrateLegacyKeyframes()` 迁移函数

3. **lib/ai-transform-converter.ts** - AI 转换器更新 (V2)
   - 输出格式改为 `property: 'scale', value: {x, y}`

4. **components/TransformPanel.tsx** - UI 重构
   - 缩放/位置使用 `CompoundKeyframeControls`
   - 处理函数更新为创建 `CompoundValue`

5. **components/keyframes/PropertyKeyframeButton.tsx**
   - 新增 `CompoundKeyframeControls` 组件

6. **components/keyframes/KeyframeDiamond.tsx**
   - 新增 `formatKeyframeValue()` 处理复合值显示

7. **components/keyframes/KeyframePanel.tsx**
   - 复合属性显示 X/Y 双行编辑

8. **store/editor-store.ts**
   - `addKeyframe` 签名更新支持 `CompoundValue`

#### 结果

| 指标 | 重构前 | 重构后 |
|------|--------|--------|
| 创建位置动画所需关键帧 | 4 个 | 2 个 |
| 创建缩放动画所需关键帧 | 4 个 | 2 个 |
| 前后端数据格式一致性 | ❌ | ✅ |
| TypeScript 编译 | ✅ | ✅ |

---

### 2026-01-13 编辑器页面审查

#### 发现的问题

1. **VideoCanvas.tsx 遗留 console.log** (🔴 高)
   - 第 582 行 AudioSync 使用 `console.log` 而非 `debugLog`
   - **修复**：改为 `debugLog('[AudioSync] drift detected:', ...)`

2. **多个组件订阅整个 store** (🔴 高)
   - Header.tsx、AssetPanel.tsx、EasingSelector.tsx、Timeline.tsx、useKeyframeTransform.ts 使用解构订阅
   - **修复**：全部改为细粒度 selector `useEditorStore((s) => s.xxx)`

3. **Timeline.tsx 订阅过多字段** (🔴 高)
   - 使用 `const {...} = useEditorStore()` 订阅了 25+ 个字段
   - **修复**：拆分为独立的 selector 调用

#### 优化结果

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 直接 console.log | 1 处 | 0 处 |
| 整个 store 订阅 | 5 处 | 0 处 |
| TypeScript 错误 | 0 | 0 |

---

### 2026-01-12 VideoCanvas.tsx 审查结果

#### 发现的问题

1. **重复计算 `activeVideoClip`** (🔴 高)
   - 在 useMemo、播放逻辑 useEffect、timeupdate 处理中重复计算了 3 次
   - **修复**：提取为公共函数 `findActiveClip()`

2. **`hasActiveVideo` 状态冗余** (🔴 高)
   - 可以直接从 `activeVideoClip` 派生
   - **修复**：改为 `const hasActiveVideo = activeVideoClip !== null`

3. **重复的音频同步逻辑** (🟡 中)
   - 在播放 useEffect 和 timeupdate 中都有处理 audio clips 的代码
   - **修复**：抽取为 `syncAudioClips()` 函数

4. **`formatTime` 函数每次渲染都创建** (🟡 中)
   - **修复**：移到组件外部定义

5. **`uniqueMediaUrls` 计算冗余** (🟢 低)
   - **修复**：直接合并到分类 clips 的 useMemo 中

6. **初始化 `hasActiveVideo` 的 useEffect 多余** (🟡 中)
   - **修复**：删除该 useEffect

#### 优化结果

| 指标 | 优化前 | 优化后 | 改善 |
|------|--------|--------|------|
| 代码行数 | 697 行 | ~530 行 | -24% |
| State 数量 | 5 个 | 4 个 | -20% |
| useEffect 数量 | 8 个 | 6 个 | -25% |
| 重复逻辑 | 3 处 | 0 处 | -100% |

---

### 2026-01-15 全局代码审查（多功能开发后）

#### 审查范围

本次审查覆盖最近开发的多个模块：
- 类型系统重构 (`types/clip.ts`, `types/keyframe.ts`, `types/asset.ts` 等)
- 新增项目管理 Store (`project-store.ts`)
- 智能清理向导 (`SmartCleanupWizard.tsx`, `SilenceCleanupDialog.tsx`)
- 媒体代理功能 (`media-proxy.ts`)
- 视频画布优化 (`VideoCanvas.tsx`, `VideoCanvasStore.tsx`)

#### 发现的问题

1. **page.tsx 直接 console.error** (🔴 高)
   - 第 120, 277, 322 行使用直接 `console.error`
   - **已修复**：添加 `debugError` 函数，改为条件日志

2. **Timeline.tsx getState() 获取 actions** (🟢 低)
   - 使用 `getStore().action` 模式获取方法引用
   - **评估结果**：这是 Zustand 推荐的性能优化模式，方法引用稳定，无需修改

3. **类型文件注释** (🟢 低)
   - 新增类型文件包含 JSDoc 文档注释
   - **评估结果**：注释是合理的 API 文档，不属于冗余注释

4. **后端循环 SQL 更新** (🟡 中)
   - `tracks.py:180` 轨道重排序循环更新
   - `workspace.py:459,1592` 素材状态批量更新
   - **评估结果**：数据量小（轨道 <10，素材通常 <5），暂不影响性能，后续可考虑优化

#### 代码质量评估

| 检查项 | 状态 | 说明 |
|--------|------|------|
| debugLog 条件日志 | ✅ 通过 | 所有组件正确使用条件日志 |
| 细粒度 Store 订阅 | ✅ 通过 | 未发现解构订阅整个 store |
| TypeScript 编译 | ✅ 通过 | 无类型错误 |
| 冗余代码 | ✅ 通过 | 类型系统整洁，无重复逻辑 |
| 视频缓冲代码 | ⚠️ 保留 | 按用户要求暂不修改 |

#### 优化结果

| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| 直接 console.error | 3 处 | 0 处 |
| TypeScript 错误 | 0 | 0 |
| 整个 store 订阅 | 0 处 | 0 处 |

#### 未使用文件清理

经分析后删除以下未使用的文件（共 ~2300 行代码）：

| 删除文件 | 原因 |
|----------|------|
| `components/HlsVideo.tsx` | 没有任何 import 引用 |
| `components/VideoCanvas.tsx` | 已被 `canvas/VideoCanvasStore.tsx` 取代 |
| `hooks/useHlsPlayer.ts` | 没有任何 import 引用 |
| `hooks/useVideoSources.ts` | 没有任何 import 引用 |
| `hooks/useKeyframeTransform.ts` | 只有导出，无实际使用 |

同步更新了 `hooks/index.ts` 和 `features/editor/index.ts` 的导出。

#### 保留待观察

以下文件只有导出但无 JSX 使用，可能是预留功能：
- `SmartPanel.tsx` 及 smart 子面板 - 智能功能面板框架
- `SilenceCleanupDialog.tsx` - 静音清理对话框
- `SmartAnalysisDialog.tsx` - 智能分析对话框
- `AIVideoCreateButton.tsx` - AI 成片按钮

#### 备注

视频播放缓冲相关的优化代码（`VideoCanvas.tsx`, `VideoCanvasStore.tsx`）按用户要求暂不修改，待后期统一进行大的缓冲优化。

---

## 📅 审查频率

- **功能开发完成后**：必须审查
- **PR 合并前**：必须审查
- **定期审查**：每两周对核心模块进行一次

---

## ✅ 审查通过标准

1. 无 🔴 高严重程度问题
2. 🟡 中严重程度问题已记录并有计划解决
3. 代码结构符合组织规范
4. 命名符合规范
5. 性能优化已考虑

---

### 2026-01-16 前后端代码审查

#### 审查范围

本次审查覆盖近期开发的代码，重点检查前后端交互、性能问题和代码规范。

#### 发现的问题

**🔴 后端严重问题**

| 文件 | 行号 | 问题 | 状态 |
|------|------|------|------|
| `projects.py` | 661-665 | 循环删除关键帧（N+1 问题） | ✅ 已修复 |
| `assets.py` | 205-207 | `except: pass` 静默失败 | ✅ 已修复 |

**🟡 后端中等问题**

| 文件 | 行号 | 问题 | 状态 |
|------|------|------|------|
| `tracks.py` | 180-186 | 循环更新轨道顺序 | ⚠️ 已添加注释说明（数据量小暂不优化） |
| 多个 API 文件 | - | 使用 `SELECT *` | 📋 待后期优化 |

**🔴 前端严重问题**

| 文件 | 行号 | 问题 | 状态 |
|------|------|------|------|
| `ClipListPanel.tsx` | 393,402,430 | 直接 `console.log` | ✅ 已修复 |
| `AssetsView.tsx` | 605 | 直接 `console.log` | ✅ 已修复 |
| `ServiceWorkerRegister.tsx` | 12 | 生产环境输出日志 | ✅ 已修复 |

**🟡 前端中等问题**

| 文件 | 问题 | 状态 |
|------|------|------|
| `ToolsSidebar.tsx` | 订阅 `currentTime`（高频变化） | 📋 建议改用 ref + subscribe |
| `clips.ts` | 字段重复定义 | 📋 待后期清理 |

#### 修复内容

1. **projects.py**：将循环删除关键帧改为批量删除 `in_()`
2. **assets.py**：将空 except 块改为记录日志
3. **tracks.py**：添加注释说明数据量小暂不优化
4. **ClipListPanel.tsx**：添加 `debugLog` 条件日志
5. **AssetsView.tsx**：添加 `debugLog` 条件日志
6. **ServiceWorkerRegister.tsx**：移除生产环境日志输出

#### 待优化项（后续版本）

- [ ] API 层使用字段选择而非 `SELECT *`
- [ ] 高频订阅 currentTime 改用 ref + subscribe 模式
- [ ] 清理 clips.ts 中的重复字段定义

---

*最后更新: 2026-01-16*
