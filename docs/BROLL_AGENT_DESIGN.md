# B-Roll 智能推荐系统设计文档

> 版本: 1.0.0  
> 日期: 2026-01-30  
> 作者: @hexiangyang

---

## 一、概述

B-Roll 智能推荐系统是 AI 一键成片流程中的关键环节，通过语义分析自动为口播视频推荐合适的 B-Roll 素材。

### 1.1 核心目标

| 目标 | 描述 |
|------|------|
| 🎯 **智能识别** | 自动识别哪些片段需要添加 B-Roll |
| 🎬 **类型决策** | 判断使用视频 B-Roll 还是图片 B-Roll |
| ⏱️ **时长匹配** | 根据内容长度智能决定 B-Roll 时长 |
| 🔍 **关键词提取** | 生成精准的搜索关键词 |
| 📦 **素材搜索** | 自动搜索并推荐匹配素材 |

### 1.2 在一键成片流程中的位置

```
┌─────────────────────────────────────────────────────────────────┐
│                    AI 一键成片 V2 流程                          │
└─────────────────────────────────────────────────────────────────┘

  上传视频 → ASR 转写 → 口癖检测 → 语义修剪 → 【B-Roll 推荐】→ 编辑器
                                                    ↑
                                               当前模块
```

---

## 二、系统架构

### 2.1 B-Roll Agent 工作流程

```
                        ┌─────────────────┐
                        │   输入片段列表   │
                        │ [{id, text, ...}]│
                        └────────┬────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────┐
│                    Step 1: LLM 语义分析                        │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │  分析每个片段：                                           │  │
│  │  • 是否需要 B-Roll？                                     │  │
│  │  • 视频还是图片？                                         │  │
│  │  • 建议时长多少？                                         │  │
│  │  • 搜索关键词是什么？                                     │  │
│  └──────────────────────────────────────────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────┐
│                  Step 2: 素材搜索                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   Pexels     │  │   Pixabay    │  │   Kling AI (可选)    │  │
│  │  视频搜索    │  │  视频/图片   │  │   AI 生成视频        │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌────────────────────────────────────────────────────────────────┐
│                  Step 3: 排序 & 返回                           │
│  • 按相关度排序                                                │
│  • 返回 Top N 素材建议                                         │
│  • 包含 B-Roll 时长建议                                        │
└────────────────────────────────────────────────────────────────┘
```

### 2.2 核心代码结构

```
backend/app/services/
├── broll_agent.py          # B-Roll Agent 核心逻辑
├── llm/
│   ├── prompts.py          # Prompt 模板（已有 BROLL_SUGGESTION_PROMPT）
│   └── parsers.py          # 输出解析器
└── ...

backend/app/api/
└── workspace.py            # clip-suggestions API（已集成）
```

---

## 三、LLM 分析规则

### 3.1 什么情况下需要 B-Roll？

#### ✅ 强烈建议添加

| 场景 | 示例 | B-Roll 类型 |
|------|------|------------|
| **描述具体事物** | "这款手机的摄像头很强大" | 视频：手机特写 |
| **提到地点** | "在北京的时候..." | 视频：城市风景 |
| **解释抽象概念** | "数据增长了300%" | 视频/图片：图表动画 |
| **列举/举例** | "第一点是...第二点是..." | 视频：配合图标 |
| **情绪高潮** | "这是最关键的一步！" | 视频：强调画面 |
| **话题转折** | "说完这个，我们来看看..." | 视频：过渡画面 |

#### ❌ 不需要添加

| 场景 | 原因 |
|------|------|
| 人物特写强调 | 需要看到说话人表情 |
| 快速过渡句（< 2秒） | 时间太短 |
| 正在展示产品 | 已有画面 |
| 互动性内容 | 需要面对观众 |

### 3.2 B-Roll 类型选择

| 类型 | 适用场景 | 示例 |
|------|---------|------|
| **视频** | 动态场景、产品演示、抽象概念 | 城市、自然、数据可视化 |
| **图片** | 静态物体、信息图表、引用内容 | 产品图、截图、证书 |

### 3.3 时长规则

| 时长 | 适用场景 |
|------|---------|
| **2-5秒** | 单个概念、快速展示 |
| **5-10秒** | 详细展示、场景建立 |
| **10-15秒** | 复杂概念、多步骤演示 |

> **限制**：B-Roll 时长不超过片段时长的 80%

---

## 四、API 设计

### 4.1 获取 B-Roll 建议

```http
POST /api/workspace/sessions/{session_id}/clip-suggestions
```

#### 响应示例

```json
{
  "status": "completed",
  "session_id": "xxx",
  "project_id": "xxx",
  "total_duration_ms": 60000,
  "broll_segments_count": 5,
  "total_broll_duration_ms": 20000,
  "clips": [
    {
      "clip_id": "clip-1",
      "clip_number": 1,
      "text": "今天给大家介绍一款新手机",
      "time_range": {"start": 0, "end": 5000},
      
      "need_broll": true,
      "broll_type": "video",
      "broll_reason": "描述具体产品，需要产品画面辅助",
      "keywords_en": ["smartphone", "mobile phone", "technology"],
      "keywords_cn": ["手机", "智能手机", "科技"],
      "suggested_duration_ms": 3000,
      
      "suggested_assets": [
        {
          "id": "pexels-123",
          "source": "pexels",
          "thumbnail_url": "https://...",
          "video_url": "https://...",
          "duration": 5000,
          "width": 1920,
          "height": 1080,
          "relevance_score": 0.95
        }
      ]
    }
  ]
}
```

---

## 五、关键词生成策略

### 5.1 规则

1. **优先具象词**：物体 > 动作 > 抽象概念
2. **使用英文**：Pexels/Pixabay API 搜索
3. **通用化**：避免过于具体，增加匹配率
4. **2-4个关键词**：主关键词 + 补充词

### 5.2 示例

| 原文 | 关键词（英文） | 关键词（中文） |
|------|--------------|--------------|
| "这款 iPhone 15 Pro 的摄像头" | smartphone, camera, technology | 手机, 摄像头, 科技 |
| "在北京的故宫门前" | Beijing, palace, architecture | 北京, 宫殿, 建筑 |
| "数据增长了 300%" | growth, chart, business | 增长, 图表, 商业 |
| "第一步是打开设置" | settings, app, tutorial | 设置, 应用, 教程 |

---

## 六、素材搜索策略

### 6.1 搜索优先级

1. **Pexels**：免费高质量视频，优先使用
2. **Pixabay**：备选，支持视频和图片
3. **Kling AI**：AI 生成，用于找不到合适素材时

### 6.2 筛选条件

- **分辨率**：≥ 1280x720 (HD)
- **方向**：优先横屏 (landscape)
- **时长**：≥ 建议时长

### 6.3 排序规则

```python
relevance_score = (
    keyword_match_score * 0.5 +  # 关键词匹配度
    quality_score * 0.3 +        # 画质评分
    duration_match_score * 0.2   # 时长匹配度
)
```

---

## 七、前端交互设计

### 7.1 B-Roll 配置界面

```
┌─────────────────────────────────────────────────────────────────┐
│  🎬 B-Roll 配置                                    [一键接受推荐] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  📊 智能分析结果: 12 个片段，5 个建议添加 B-Roll                  │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 片段 1 (0:00 - 0:05)                            [需要 B-Roll]││
│  │ "今天给大家介绍一款新手机"                                    ││
│  │                                                             ││
│  │ 推荐素材:                                                    ││
│  │ ┌──────┐ ┌──────┐ ┌──────┐                                  ││
│  │ │ 🎬  │ │ 🎬  │ │ 🎬  │   ← 可点击预览/选择                 ││
│  │ │ 3秒  │ │ 5秒  │ │ 4秒  │                                  ││
│  │ └──────┘ └──────┘ └──────┘                                  ││
│  │                                                             ││
│  │ 关键词: smartphone, technology        [🔍 换一批]            ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │ 片段 2 (0:05 - 0:10)                          [不需要 B-Roll]││
│  │ "我想和大家分享一下使用体验"                                  ││
│  │ 原因: 人物特写强调，保持口播画面                              ││
│  └─────────────────────────────────────────────────────────────┘│
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### 7.2 用户操作

1. **一键接受**：采用所有 AI 推荐
2. **逐个调整**：
   - 切换是否需要 B-Roll
   - 更换推荐素材
   - 自定义搜索关键词
3. **手动搜索**：输入自定义关键词重新搜索

---

## 八、未来扩展

### 8.1 Phase 2: AI 生成

- 集成 Kling AI 文生视频
- 当搜索素材不理想时，自动生成

### 8.2 Phase 3: 智能分镜

- 根据脚本自动生成分镜头脚本
- 每个镜头对应一个 B-Roll 建议

### 8.3 Phase 4: 用户素材库

- 优先从用户上传的素材中匹配
- 建立个人素材标签体系

---

## 九、参考资料

### 9.1 行业参考

| 产品 | B-Roll 功能 | 特点 |
|------|------------|------|
| Descript | Overdub + Stock | 内置素材库 + AI 配音 |
| Kapwing | Smart Cut + B-Roll | 自动剪辑 + 素材推荐 |
| InVideo | AI Script + Stock | 脚本生成 + 智能配图 |
| Pictory | Blog to Video | 文章转视频 + 自动配图 |

### 9.2 技术文档

- [Pexels API](https://www.pexels.com/api/documentation/)
- [Pixabay API](https://pixabay.com/api/docs/)
- [LangChain Agents](https://python.langchain.com/docs/modules/agents/)

---

## 十、附录：代码示例

### 10.1 调用 B-Roll Agent

```python
from app.services.broll_agent import BRollAgent

# 初始化
agent = BRollAgent()

# 分析片段
result = await agent.analyze(
    session_id="session-123",
    segments=[
        {"id": "seg-1", "text": "今天介绍一款手机", "start": 0, "end": 5000},
        {"id": "seg-2", "text": "我想和大家分享", "start": 5000, "end": 10000},
    ],
    video_style="口播",
    total_duration_ms=60000,
    search_assets=True,
)

# 结果
print(f"需要 B-Roll 的片段: {result.broll_segments}/{result.total_segments}")
for d in result.decisions:
    if d.need_broll:
        print(f"  - {d.segment_id}: {d.broll_type}, 关键词: {d.keywords_en}")
```

### 10.2 单独搜索素材

```python
from app.services.broll_agent import BRollAgent

agent = BRollAgent()

# 搜索视频素材
assets = await agent._search_assets(
    keywords=["smartphone", "technology"],
    broll_type="video",
    duration_hint_ms=3000,
    limit=5,
)
```
