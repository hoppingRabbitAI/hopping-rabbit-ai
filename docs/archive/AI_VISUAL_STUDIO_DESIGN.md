# AI 视觉工作室设计文档 (AI Visual Studio Design) v3

## 1. 设计理念

### 1.1 核心原则：渐进式交互 + AI 驱动

| 阶段 | 操作 | 说明 |
|------|------|------|
| 1 | 触发 AI 分析 | 用户点击按钮，AI 开始分析视频 |
| 2 | 展示分镜结果 | AI 返回分镜数量、时间点、关键帧 |
| 3 | 逐镜/全局定制 | 用户可为每个分镜单独设置背景，或一键应用全部 |
| 4 | 进入编辑器 | 带着配置进入后续流程 |

### 1.2 关键洞察

1. **分镜是必须的中间产物** - 无论是 B-Roll 还是背景替换，都需要先有分镜划分
2. **背景替换的本质** - 先识别人物前景 → 生成/选择背景图 → 逐帧合成
3. **渐进式交互** - 先让 AI 分析，用户基于结果做决策

---

## 2. 交互流程

### 2.1 状态 1：未分析（Idle）

```
┌────────────────────────────────────────────────────────────────────────┐
│  ⬅️  ✨ AI 视觉工作室                                             ✕   │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────┐  ┌─────────────────────────────┐  │
│  │                                │  │       [视频预览]            │  │
│  │     🔍                         │  │       原始比例               │  │
│  │     准备分析视频                │  │                             │  │
│  │                                │  │       时长：2分30秒          │  │
│  │     AI 将自动识别：             │  │                             │  │
│  │     • 智能划分分镜              │  │                             │  │
│  │     • 识别最佳切换点            │  │                             │  │
│  │     • 检测人物前景              │  │                             │  │
│  │                                │  │                             │  │
│  │     [🔍 开始 AI 分析]           │  │                             │  │
│  │                                │  │                             │  │
│  └────────────────────────────────┘  └─────────────────────────────┘  │
│                                                                         │
├────────────────────────────────────────────────────────────────────────┤
│              [请先完成 AI 分析] (灰色禁用)                              │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.2 状态 2：分析中（Analyzing）

```
┌────────────────────────────────────────────────────────────────────────┐
│                                                                         │
│     ⏳ 正在分析视频...                                                 │
│                                                                         │
│     识别分镜、检测人物、分析切换点                                      │
│                                                                         │
│     [████████████░░░░░░] 60%                                           │
│                                                                         │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.3 状态 3：分析完成（Done）

```
┌────────────────────────────────────────────────────────────────────────┐
│  ⬅️  ✨ AI 视觉工作室                                             ✕   │
│      已识别 10 个分镜                                                   │
├────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌────────────────────────────────┐  ┌─────────────────────────────┐  │
│  │  已识别 10 个分镜               │  │       [视频预览]            │  │
│  │  [#1][#2][#3][#4][#5]... →     │  │                             │  │
│  │                                │  │       ✓ 分析完成            │  │
│  │  当前：分镜 #3 (0:28-0:45)     │  │       已识别 10 个分镜       │  │
│  │                                │  │                             │  │
│  │  ┌──────────────────────────┐  │  │                             │  │
│  │  │ [保持原始] [自定义背景]   │  │  │                             │  │
│  │  └──────────────────────────┘  │  │                             │  │
│  │                                │  │                             │  │
│  │  应用范围：[仅此分镜][全部]    │  │                             │  │
│  │                                │  │                             │  │
│  │  [AI生成] [画布] [模板]        │  │                             │  │
│  │  ┌──────────────────────────┐  │  │                             │  │
│  │  │ (对应的定制面板)          │  │  │                             │  │
│  │  └──────────────────────────┘  │  │                             │  │
│  └────────────────────────────────┘  └─────────────────────────────┘  │
│                                                                         │
├────────────────────────────────────────────────────────────────────────┤
│                      ✨ 进入编辑器                                     │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 3. 数据结构

```typescript
// 分析状态
type AnalysisStatus = 'idle' | 'analyzing' | 'done' | 'error';

// 单个分镜
interface Shot {
    id: string;
    index: number;
    startTime: number;      // 秒
    endTime: number;        // 秒
    thumbnailUrl: string;   // 关键帧
    background?: ShotBackground | null;  // null = 保持原始
}

// 分镜背景配置
interface ShotBackground {
    source: 'ai-generate' | 'canvas' | 'template';
    aiGenerate?: { prompt: string; generatedImageUrl?: string };
    canvas?: { dataUrl?: string };
    template?: { selectedId?: string; selectedTemplate?: TemplateItem };
}

// 完整配置
interface VisualStudioConfig {
    analysisStatus: AnalysisStatus;
    shots: Shot[];
    selectedShotId: string | null;
    globalBackground: ShotBackground | null;
    useGlobalBackground: boolean;
}
```

---

## 4. API 设计

### 4.1 触发分析

```
POST /api/workspace/sessions/{id}/analyze-shots

Response:
{
    "shots": [
        { "index": 0, "startTime": 0, "endTime": 15.5, "thumbnailUrl": "..." },
        { "index": 1, "startTime": 15.5, "endTime": 28.3, "thumbnailUrl": "..." },
        ...
    ]
}
```

### 4.2 保存配置

```
POST /api/workspace/sessions/{id}/workflow-config

Body:
{
    "shots": [
        { "index": 0, "startTime": 0, "endTime": 15.5, "background": { ... } },
        ...
    ],
    "globalBackground": { ... } | null
}
```

---

## 5. 文件结构

```
frontend/src/components/workspace/VisualStudio/
├── index.tsx    # 主组件（包含所有状态和子组件）
└── types.ts     # 类型定义
```

---

## 6. 用户体验亮点

| 方面 | 优势 |
|------|------|
| 渐进式 | 先分析再定制，用户有明确的操作路径 |
| 可视化 | 分镜时间轴直观展示，点击即可选中 |
| 灵活性 | 支持逐镜定制，也支持全局应用 |
| 反馈 | 分析过程有进度条，完成后有状态提示 |

---

## 7. 后续迭代

- [ ] 对接真实的 AI 分析 API
- [ ] 画布绘制功能完整实现
- [ ] AI 背景生成对接 Kling/Stable Diffusion
- [ ] 分镜关键帧真实提取
- [ ] 支持手动调整分镜切点
