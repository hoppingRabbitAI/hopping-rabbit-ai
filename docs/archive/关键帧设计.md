# å…³é”®å¸§ç³»ç»Ÿè®¾è®¡æ–‡æ¡£ V3

> å‚è€ƒ CapCut å…³é”®å¸§è®¾è®¡ï¼ŒHoppingRabbit AI çš„å…³é”®å¸§ç³»ç»Ÿå®ç°æ–‡æ¡£
> 
> **çŠ¶æ€**: âœ… Phase 1-2 å·²å®Œæˆï¼Œå½“å‰ä½¿ç”¨ V3 å¤åˆå±æ€§æ¨¡å‹

## 1. æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1.1 CapCut è®¾è®¡ç²¾é«“

| æ¨¡å— | æ ¸å¿ƒè¦ç‚¹ | å…³é”®ç»†èŠ‚ |
|------|----------|----------|
| äº¤äº’é€»è¾‘ | **é€‰æ‹©-æ ‡è®°-è°ƒèŠ‚** | å±æ€§æ—çš„é’»çŸ³å›¾æ ‡æ˜¯ç»Ÿä¸€è§¦å‘ç‚¹ï¼Œæ“ä½œç›´è§‚ |
| è‡ªåŠ¨ç”Ÿæˆ | **Aâ†’B è‡ªåŠ¨åˆ›å»º** | åœ¨ A ç‚¹è®¾ç½®å‚æ•°ï¼Œç§»åŠ¨åˆ° B ç‚¹å†è°ƒæ•´ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºæ–°å…³é”®å¸§ |
| æ•°æ®æ¨¡å‹ | **æ—¶é—´å½’ä¸€åŒ– offset** | å…³é”®å¸§æ—¶é—´ç”¨ 0.0-1.0 è¡¨ç¤ºç›¸å¯¹ä½ç½®ï¼Œç®€åŒ–æ—¶é•¿å˜åŒ–çš„ç»´æŠ¤ |
| å±æ€§ç¦»æ•£åŒ– | **æ¯ä¸ªå±æ€§ç‹¬ç«‹** | position_xã€scale_x ç­‰å„è‡ªç‹¬ç«‹å®šä¹‰å’Œæ’å€¼ |

### 1.2 è®¾è®¡åŸåˆ™

1. **å…¥å£æ˜ç¡®**ï¼šæ¯ä¸ªå¯åŠ¨ç”»å±æ€§æ—éƒ½æœ‰é’»çŸ³ â—† å›¾æ ‡ä½œä¸ºç»Ÿä¸€å…¥å£
2. **æ“ä½œç®€åŒ–**ï¼šä¿®æ”¹å±æ€§å€¼æ—¶è‡ªåŠ¨åœ¨å½“å‰æ—¶é—´ç‚¹åˆ›å»º/æ›´æ–°å…³é”®å¸§
3. **è§†è§‰åé¦ˆ**ï¼š
   - æ—¶é—´è½´ä¸Šç›´æ¥æ˜¾ç¤ºå…³é”®å¸§è±å½¢æ ‡è®°
   - å±æ€§å·²æœ‰å…³é”®å¸§æ—¶å›¾æ ‡é«˜äº®
   - clip ä¸Šæ˜¾ç¤ºå…³é”®å¸§æ•°é‡å¾½ç« 
4. **é«˜æ•ˆç¼–è¾‘**ï¼šæ”¯æŒé”®ç›˜å¿«æ·é”®ã€æ‰¹é‡æ“ä½œã€æ‹–æ‹½è°ƒæ•´

## 2. äº¤äº’æµç¨‹è®¾è®¡

### 2.1 æ ¸å¿ƒå·¥ä½œæµï¼ˆCapCut é£æ ¼ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å…³é”®å¸§æ“ä½œå·¥ä½œæµ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. é€‰ä¸­ Clip                                                    â”‚
â”‚     â†“                                                            â”‚
â”‚  2. åœ¨å³ä¾§å±æ€§é¢æ¿æ‰¾åˆ°ç›®æ ‡å±æ€§ï¼ˆå¦‚ç¼©æ”¾ï¼‰                          â”‚
â”‚     â†“                                                            â”‚
â”‚  3. ç‚¹å‡»å±æ€§æ—çš„ â—† æ·»åŠ ç¬¬ä¸€ä¸ªå…³é”®å¸§                              â”‚
â”‚     â†“                                                            â”‚
â”‚  4. ç§»åŠ¨æ’­æ”¾å¤´åˆ°æ–°ä½ç½®                                           â”‚
â”‚     â†“                                                            â”‚
â”‚  5. è°ƒæ•´å±æ€§å€¼ â†’ ç³»ç»Ÿè‡ªåŠ¨åœ¨æ–°ä½ç½®åˆ›å»ºå…³é”®å¸§                      â”‚
â”‚     â†“                                                            â”‚
â”‚  6. é¢„è§ˆåŠ¨ç”»æ•ˆæœï¼Œå¾®è°ƒå…³é”®å¸§ä½ç½®/å€¼                              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 å±æ€§é¢æ¿è®¾è®¡

```
â”Œâ”€ å±æ€§é¢æ¿ï¼ˆé€‰ä¸­ Clip æ—¶æ˜¾ç¤ºï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                              â”‚
â”‚ ğŸ¬ åŸºç¡€                                      â”‚
â”‚ â”œâ”€ ç¼©æ”¾    [100%] â”€â”€â”€â”€â—‹â”€â”€â”€â”€ [â—†] â† å…³é”®å¸§æŒ‰é’® â”‚
â”‚ â”œâ”€ X åç§»  [  0 ] â”€â”€â”€â”€â—‹â”€â”€â”€â”€ [â—†]             â”‚
â”‚ â”œâ”€ Y åç§»  [  0 ] â”€â”€â”€â”€â—‹â”€â”€â”€â”€ [â—†]             â”‚
â”‚ â””â”€ æ—‹è½¬    [  0Â°] â”€â”€â”€â”€â—‹â”€â”€â”€â”€ [â—†]             â”‚
â”‚                                              â”‚
â”‚ ğŸ‘ è§†è§‰æ•ˆæœ                                   â”‚
â”‚ â”œâ”€ ä¸é€æ˜åº¦ [100%] â”€â”€â”€â—‹â”€â”€â”€â”€ [â—†]             â”‚
â”‚ â””â”€ æ¨¡ç³Š    [  0 ] â”€â”€â”€â”€â—‹â”€â”€â”€â”€ [â—†]             â”‚
â”‚                                              â”‚
â”‚ ğŸ”Š éŸ³é¢‘ï¼ˆä»…éŸ³è§†é¢‘ Clipï¼‰                      â”‚
â”‚ â”œâ”€ éŸ³é‡    [100%] â”€â”€â”€â—‹â”€â”€â”€â”€ [â—†]             â”‚
â”‚ â””â”€ å£°åƒ    [ä¸­å¤®] â”€â”€â”€â”€â—‹â”€â”€â”€â”€ [â—†]             â”‚
â”‚                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®å¸§æŒ‰é’®çŠ¶æ€ï¼š
â—‡ ç°è‰²ç©ºå¿ƒ - æ­¤å±æ€§æ— å…³é”®å¸§
â—† é’è‰²å®å¿ƒ - æ’­æ”¾å¤´æ­£å¥½åœ¨å…³é”®å¸§ä½ç½®
â—† é»„è‰²å®å¿ƒ - æ’­æ”¾å¤´åœ¨ä¸¤ä¸ªå…³é”®å¸§ä¹‹é—´
```

### 2.3 æ—¶é—´è½´å…³é”®å¸§æ˜¾ç¤º

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Timeline                                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚ â”‚Trackâ”‚ â”‚ [Clip â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– â– ]    â”‚               â”‚
â”‚ â”‚  1  â”‚ â”‚  â—†3      â—†        â—†           â—†       â”‚  â† å…³é”®å¸§æ ‡è®°  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚          â†‘                                                       â”‚
â”‚          å…³é”®å¸§æ•°é‡å¾½ç«                                           â”‚
â”‚                                                                  â”‚
â”‚ Clip ä¸Šå§‹ç»ˆæ˜¾ç¤ºå…³é”®å¸§è±å½¢ä½ç½®ï¼Œæ— éœ€è¿›å…¥ç‰¹æ®Šæ¨¡å¼                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 3. æ•°æ®æ¨¡å‹è®¾è®¡

### 3.1 æ•°æ®åº“ Schema

```sql
-- å…³é”®å¸§è¡¨ï¼ˆä½¿ç”¨å½’ä¸€åŒ–æ—¶é—´ offsetï¼‰
CREATE TABLE keyframes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clip_id UUID NOT NULL REFERENCES clips(id) ON DELETE CASCADE,
  
  -- å±æ€§æ ‡è¯†
  property TEXT NOT NULL,
  -- å¯é€‰å€¼: 'scale_x' | 'scale_y' | 'position_x' | 'position_y' | 
  --         'rotation' | 'opacity' | 'volume' | 'pan'
  
  -- å½’ä¸€åŒ–æ—¶é—´åç§»ï¼ˆ0.0-1.0ï¼Œç›¸å¯¹äº clip é•¿åº¦ï¼‰
  offset FLOAT NOT NULL CHECK (offset >= 0 AND offset <= 1),
  
  -- å±æ€§å€¼ï¼ˆå·²æ ‡å‡†åŒ–åˆ°å„å±æ€§çš„å€¼åŸŸï¼‰
  value FLOAT NOT NULL,
  
  -- æ’å€¼ç±»å‹
  easing TEXT NOT NULL DEFAULT 'linear',
  -- å¯é€‰å€¼: 'linear' | 'ease_in' | 'ease_out' | 'ease_in_out' | 'hold'
  
  -- è´å¡å°”æ§åˆ¶ç‚¹ï¼ˆé¢„ç•™ï¼Œå½“éœ€è¦è‡ªå®šä¹‰æ›²çº¿æ—¶ä½¿ç”¨ï¼‰
  bezier_control JSONB,
  
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- ç´¢å¼•
CREATE INDEX idx_keyframes_clip_id ON keyframes(clip_id);
CREATE INDEX idx_keyframes_clip_property ON keyframes(clip_id, property);
CREATE UNIQUE INDEX idx_keyframes_unique ON keyframes(clip_id, property, offset);
```

### 3.2 TypeScript ç±»å‹ï¼ˆV3 å¤åˆå±æ€§ï¼‰

```typescript
// ========== V3: å¤åˆå±æ€§å…³é”®å¸§ ==========

/**
 * å¤åˆå…³é”®å¸§å±æ€§ï¼ˆä¸€ä¸ªå…³é”®å¸§åŒæ—¶æ§åˆ¶å¤šä¸ªå€¼ï¼‰
 */
export type CompoundKeyframeProperty = 
  | 'position'     // ä½ç½® (x, y) - åƒç´ å€¼
  | 'scale';       // ç¼©æ”¾ (x, y) - æ¯”ä¾‹å€¼

/**
 * ç®€å•å…³é”®å¸§å±æ€§ï¼ˆä¸€ä¸ªå…³é”®å¸§åªæ§åˆ¶ä¸€ä¸ªå€¼ï¼‰
 */
export type SimpleKeyframeProperty = 
  | 'rotation'     // æ—‹è½¬ (-360~360Â°)
  | 'opacity'      // ä¸é€æ˜åº¦ (0-1)
  | 'volume'       // éŸ³é‡ (0-2)
  | 'pan';         // å£°åƒ (-1~1)

export type KeyframeProperty = CompoundKeyframeProperty | SimpleKeyframeProperty;

// æ’å€¼ç±»å‹
export type EasingType = 'linear' | 'ease_in' | 'ease_out' | 'ease_in_out' | 'hold';

/**
 * å¤åˆå…³é”®å¸§å€¼ï¼ˆæ”¯æŒ x/y ä¸¤ä¸ªåˆ†é‡ï¼‰
 */
export interface CompoundValue {
  x: number;
  y: number;
}

/**
 * å…³é”®å¸§æ•°æ®ç»“æ„ V3
 */
export interface Keyframe {
  id: string;
  clipId: string;
  property: KeyframeProperty;
  offset: number;                    // å½’ä¸€åŒ–æ—¶é—´ 0.0-1.0
  value: number | CompoundValue;     // ç®€å•å€¼æˆ–å¤åˆå€¼
  easing: EasingType;
}

// å±æ€§é…ç½®è¡¨ï¼ˆå¤åˆå±æ€§å¸¦ x/y é…ç½®ï¼‰
export const PROPERTY_CONFIGS: Record<KeyframeProperty, PropertyConfig> = {
  // â˜… å¤åˆå±æ€§
  position: {
    property: 'position',
    label: 'ä½ç½®',
    isCompound: true,
    xConfig: { label: 'X', min: -1920, max: 1920, step: 1, defaultValue: 0 },
    yConfig: { label: 'Y', min: -1080, max: 1080, step: 1, defaultValue: 0 },
    defaultValue: { x: 0, y: 0 },
    category: 'transform',
  },
  scale: {
    property: 'scale',
    label: 'ç¼©æ”¾',
    isCompound: true,
    xConfig: { label: 'X', min: 0.1, max: 5, step: 0.01, defaultValue: 1 },
    yConfig: { label: 'Y', min: 0.1, max: 5, step: 0.01, defaultValue: 1 },
    defaultValue: { x: 1, y: 1 },
    category: 'transform',
  },
  // â˜… ç®€å•å±æ€§
  rotation: { property: 'rotation', label: 'æ—‹è½¬', min: -360, max: 360, defaultValue: 0 },
  opacity:  { property: 'opacity',  label: 'ä¸é€æ˜åº¦', min: 0, max: 1, defaultValue: 1 },
  volume:   { property: 'volume',   label: 'éŸ³é‡', min: 0, max: 2, defaultValue: 1 },
  pan:      { property: 'pan',      label: 'å£°åƒ', min: -1, max: 1, defaultValue: 0 },
};
```

### 3.3 æ—§ç‰ˆå±æ€§å…¼å®¹ï¼ˆæ¸è¿›å¼è¿ç§»ï¼‰

```typescript
/**
 * å…¼å®¹æ—§å±æ€§åï¼ˆV1/V2 â†’ V3ï¼‰
 * @deprecated ä½¿ç”¨ CompoundKeyframeProperty ä»£æ›¿
 */
export type LegacyKeyframeProperty = 
  | 'scale_x' | 'scale_y' 
  | 'position_x' | 'position_y';

// æ—§å±æ€§æ˜ å°„åˆ°æ–°å±æ€§
export const LEGACY_PROPERTY_MAP: Record<LegacyKeyframeProperty, { property: CompoundKeyframeProperty; component: 'x' | 'y' }> = {
  'scale_x':    { property: 'scale',    component: 'x' },
  'scale_y':    { property: 'scale',    component: 'y' },
  'position_x': { property: 'position', component: 'x' },
  'position_y': { property: 'position', component: 'y' },
};
```

## 4. æ ¸å¿ƒäº¤äº’å®ç°

### 4.1 å±æ€§é¢æ¿å…³é”®å¸§æŒ‰é’®

```typescript
// components/keyframes/PropertyKeyframeButton.tsx

interface PropertyKeyframeButtonProps {
  clipId: string;
  property: KeyframeProperty;
  currentValue: number;
  onValueChange: (value: number) => void;
}

/**
 * å±æ€§æ—çš„å…³é”®å¸§æŒ‰é’®
 * - ç‚¹å‡»æ·»åŠ /åˆ é™¤å…³é”®å¸§
 * - æ˜¾ç¤ºå½“å‰çŠ¶æ€ï¼ˆæ— /åœ¨å…³é”®å¸§ä¸Š/åœ¨ä¸¤å¸§ä¹‹é—´ï¼‰
 */
export function PropertyKeyframeButton({ 
  clipId, 
  property, 
  currentValue,
  onValueChange 
}: PropertyKeyframeButtonProps) {
  const { currentTime, keyframes, addKeyframe, deleteKeyframe } = useEditorStore();
  const clip = useEditorStore(s => s.clips.find(c => c.id === clipId));
  
  if (!clip) return null;
  
  // è®¡ç®—å½“å‰æ—¶é—´çš„ offset
  const relativeTime = currentTime - clip.startTime;
  const offset = relativeTime / clip.duration;
  
  // è·å–æ­¤å±æ€§çš„æ‰€æœ‰å…³é”®å¸§
  const propertyKeyframes = keyframes.get(clipId)?.get(property) || [];
  
  // åˆ¤æ–­å½“å‰çŠ¶æ€
  const existingKeyframe = propertyKeyframes.find(
    kf => Math.abs(kf.offset - offset) < 0.001
  );
  const hasKeyframes = propertyKeyframes.length > 0;
  const isBetweenKeyframes = hasKeyframes && !existingKeyframe;
  
  const handleClick = () => {
    if (existingKeyframe) {
      // åˆ é™¤å½“å‰ä½ç½®çš„å…³é”®å¸§
      deleteKeyframe(existingKeyframe.id);
    } else {
      // æ·»åŠ å…³é”®å¸§
      addKeyframe(clipId, property, offset, currentValue);
    }
  };
  
  return (
    <button
      onClick={handleClick}
      className={cn(
        "w-5 h-5 flex items-center justify-center transition-colors",
        existingKeyframe && "text-cyan-400",           // åœ¨å…³é”®å¸§ä¸Š
        isBetweenKeyframes && "text-yellow-400",       // åœ¨ä¸¤å¸§ä¹‹é—´
        !hasKeyframes && "text-gray-500 hover:text-gray-300"  // æ— å…³é”®å¸§
      )}
      title={existingKeyframe ? "åˆ é™¤å…³é”®å¸§" : "æ·»åŠ å…³é”®å¸§"}
    >
      <Diamond 
        size={14} 
        className={cn(existingKeyframe && "fill-current")} 
      />
    </button>
  );
}
```

### 4.2 è‡ªåŠ¨åˆ›å»ºå…³é”®å¸§ï¼ˆCapCut é£æ ¼ï¼‰

```typescript
// åœ¨å±æ€§é¢æ¿ä¸­ï¼Œå½“ç”¨æˆ·ä¿®æ”¹å±æ€§å€¼æ—¶

function handlePropertyChange(property: KeyframeProperty, newValue: number) {
  const { currentTime, keyframes, addKeyframe, updateKeyframe, clips } = useEditorStore.getState();
  const clip = clips.find(c => c.id === selectedClipId);
  
  if (!clip) return;
  
  const offset = (currentTime - clip.startTime) / clip.duration;
  const propertyKeyframes = keyframes.get(clip.id)?.get(property) || [];
  
  // CapCut æ ¸å¿ƒé€»è¾‘ï¼šå¦‚æœæ­¤å±æ€§å·²æœ‰å…³é”®å¸§ï¼Œåˆ™è‡ªåŠ¨åœ¨å½“å‰ä½ç½®åˆ›å»º/æ›´æ–°
  if (propertyKeyframes.length > 0) {
    const existing = propertyKeyframes.find(kf => Math.abs(kf.offset - offset) < 0.001);
    
    if (existing) {
      // æ›´æ–°ç°æœ‰å…³é”®å¸§
      updateKeyframe(existing.id, { value: newValue });
    } else {
      // è‡ªåŠ¨åˆ›å»ºæ–°å…³é”®å¸§ï¼ˆCapCut çš„ Aâ†’B è‡ªåŠ¨åˆ›å»ºï¼‰
      addKeyframe(clip.id, property, offset, newValue);
    }
  }
  
  // åŒæ—¶æ›´æ–° clip çš„å½“å‰å±æ€§ï¼ˆç”¨äºæ— å…³é”®å¸§æ—¶çš„é™æ€å€¼ï¼‰
  updateClip(clip.id, { [property]: newValue });
}
```

### 4.3 æ—¶é—´è½´å…³é”®å¸§æ˜¾ç¤º

```typescript
// åœ¨ Timeline.tsx çš„ Clip æ¸²æŸ“ä¸­

// å§‹ç»ˆæ˜¾ç¤ºå…³é”®å¸§è±å½¢ï¼ˆä¸éœ€è¦ç‰¹æ®Šæ¨¡å¼ï¼‰
{clipKeyframes.map((kf) => (
  <KeyframeDiamond
    key={kf.id}
    keyframe={kf}
    clipWidth={clipWidth}
    isSelected={selectedKeyframeIds.has(kf.id)}
    onSelect={() => selectKeyframe(kf.id)}
    onDrag={(newOffset) => updateKeyframe(kf.id, { offset: newOffset })}
  />
))}

// å…³é”®å¸§æ•°é‡å¾½ç« 
{clipKeyframes.length > 0 && (
  <div className="absolute -top-1.5 left-1 px-1 py-0.5 bg-cyan-500/90 rounded text-[8px] font-bold text-black">
    â—† {clipKeyframes.length}
  </div>
)}
```

## 5. æ’å€¼ç³»ç»Ÿ

### 5.1 çº¿æ€§æ’å€¼ï¼ˆPhase 1ï¼‰

```typescript
/**
 * è®¡ç®—æŒ‡å®š offset ä½ç½®çš„å±æ€§å€¼
 */
export function getInterpolatedValue(
  keyframes: Keyframe[],
  offset: number,
  defaultValue: number
): number {
  if (keyframes.length === 0) return defaultValue;
  if (keyframes.length === 1) return keyframes[0].value;
  
  const sorted = [...keyframes].sort((a, b) => a.offset - b.offset);
  
  // è¶…å‡ºèŒƒå›´
  if (offset <= sorted[0].offset) return sorted[0].value;
  if (offset >= sorted[sorted.length - 1].offset) return sorted[sorted.length - 1].value;
  
  // æ‰¾åˆ°åŒºé—´
  for (let i = 0; i < sorted.length - 1; i++) {
    const kf1 = sorted[i];
    const kf2 = sorted[i + 1];
    
    if (offset >= kf1.offset && offset <= kf2.offset) {
      // Hold æ¨¡å¼ï¼šä¿æŒå‰å€¼ä¸å˜
      if (kf1.easing === 'hold') return kf1.value;
      
      // è®¡ç®—æ’å€¼è¿›åº¦
      const t = (offset - kf1.offset) / (kf2.offset - kf1.offset);
      const easedT = applyEasing(t, kf1.easing);
      
      // çº¿æ€§æ’å€¼
      return kf1.value + (kf2.value - kf1.value) * easedT;
    }
  }
  
  return defaultValue;
}

function applyEasing(t: number, easing: EasingType): number {
  switch (easing) {
    case 'ease_in':     return t * t;
    case 'ease_out':    return 1 - (1 - t) * (1 - t);
    case 'ease_in_out': return t < 0.5 ? 2 * t * t : 1 - 2 * (1 - t) * (1 - t);
    case 'hold':        return 0;
    default:            return t; // linear
  }
}
```

## 6. å®ç°çŠ¶æ€

### âœ… å·²å®Œæˆï¼ˆPhase 1-2ï¼‰

| åŠŸèƒ½ | æ–‡ä»¶ | çŠ¶æ€ |
|------|------|------|
| V3 å¤åˆå±æ€§æ•°æ®æ¨¡å‹ | `types/keyframe.ts` | âœ… |
| Store å…³é”®å¸§ç®¡ç† | `store/editor-store.ts` | âœ… |
| PropertyKeyframeButton | `keyframes/PropertyKeyframeButton.tsx` | âœ… |
| CompoundKeyframeControls | `keyframes/PropertyKeyframeButton.tsx` | âœ… |
| è‡ªåŠ¨åˆ›å»ºå…³é”®å¸§é€»è¾‘ | å±æ€§é¢æ¿è”åŠ¨ | âœ… |
| Timeline å…³é”®å¸§æ˜¾ç¤º | `Timeline.tsx` + `KeyframeDiamond` | âœ… |
| çº¿æ€§æ’å€¼ + ç¼“åŠ¨ | `keyframe-interpolation.ts` | âœ… |
| ç”»å¸ƒæ¸²æŸ“å…³é”®å¸§åŠ¨ç”» | `VideoCanvas.tsx` | âœ… |
| ç§»é™¤ keyframeMode | å…¨å±€ | âœ… å·²ç§»é™¤ |

### ğŸ“‹ å¾…å®Œæˆï¼ˆPhase 3ï¼‰

| åŠŸèƒ½ | ä¼˜å…ˆçº§ | è¯´æ˜ |
|------|--------|------|
| æ›²çº¿ç¼–è¾‘å™¨ | P3 | å¯è§†åŒ–è°ƒæ•´è´å¡å°”æ›²çº¿ |
| å…³é”®å¸§å¤åˆ¶ç²˜è´´ | P3 | è·¨ clip å¤åˆ¶å…³é”®å¸§ |
| æ‰¹é‡ç¼–è¾‘ | P3 | å¤šé€‰å…³é”®å¸§æ‰¹é‡è°ƒæ•´ |
| é¢„è®¾åŠ¨ç”» | P3 | æ·¡å…¥æ·¡å‡ºã€ç¼©æ”¾è¿›å‡ºç­‰é¢„è®¾ |

### æ–‡ä»¶ç»“æ„

```
frontend/src/features/editor/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ keyframe.ts              # V3 å¤åˆå±æ€§ç±»å‹å®šä¹‰
â”œâ”€â”€ store/
â”‚   â””â”€â”€ editor-store.ts          # å…³é”®å¸§ CRUD + Map ç»“æ„
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ TransformPanel.tsx       # å˜æ¢å±æ€§é¢æ¿ï¼ˆé›†æˆå…³é”®å¸§æŒ‰é’®ï¼‰
â”‚   â”œâ”€â”€ AudioPanel.tsx           # éŸ³é¢‘å±æ€§é¢æ¿ï¼ˆé›†æˆå…³é”®å¸§æŒ‰é’®ï¼‰
â”‚   â”œâ”€â”€ TextStylePanel.tsx       # æ–‡å­—å±æ€§é¢æ¿ï¼ˆé›†æˆå…³é”®å¸§æŒ‰é’®ï¼‰
â”‚   â”œâ”€â”€ Timeline.tsx             # æ—¶é—´è½´ï¼ˆæ˜¾ç¤º KeyframeDiamondï¼‰
â”‚   â””â”€â”€ keyframes/
â”‚       â”œâ”€â”€ PropertyKeyframeButton.tsx  # å±æ€§å…³é”®å¸§æŒ‰é’®ç»„ä»¶
â”‚       â”œâ”€â”€ KeyframeDiamond.tsx         # æ—¶é—´è½´è±å½¢æ ‡è®°
â”‚       â”œâ”€â”€ KeyframePanel.tsx           # å…³é”®å¸§ç¼–è¾‘é¢æ¿
â”‚       â””â”€â”€ index.ts
â””â”€â”€ lib/
    â””â”€â”€ keyframe-interpolation.ts  # æ’å€¼ç®—æ³•ï¼ˆæ”¯æŒå¤åˆå€¼ï¼‰
```

## 7. ä¸ç°æœ‰ä»£ç çš„é›†æˆ

### 7.1 æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶ | èŒè´£ | çŠ¶æ€ |
|------|------|------|
| `types/keyframe.ts` | V3 ç±»å‹å®šä¹‰ + å¤åˆå±æ€§ | âœ… å·²å®ç° |
| `store/editor-store.ts` | å…³é”®å¸§ stateï¼ˆMap ç»“æ„ï¼‰ | âœ… å·²å®ç° |
| `keyframes/PropertyKeyframeButton.tsx` | å±æ€§å…³é”®å¸§æŒ‰é’® | âœ… å·²å®ç° |
| `keyframes/KeyframeDiamond.tsx` | æ—¶é—´è½´è±å½¢ | âœ… å·²å®ç° |
| `lib/keyframe-interpolation.ts` | æ’å€¼ç®—æ³• | âœ… å·²å®ç° |

### 7.2 å·²ç§»é™¤çš„æ¦‚å¿µ

- âœ… `keyframeMode` - ä¸å†éœ€è¦ç‰¹æ®Šæ¨¡å¼ï¼Œå§‹ç»ˆå¯ä»¥æ“ä½œå…³é”®å¸§
- âœ… `activeKeyframeProperty` - ä¸å†éœ€è¦"å½“å‰ç¼–è¾‘å±æ€§"æ¦‚å¿µ
- âœ… `scale_x/scale_y/position_x/position_y` - å·²è¿ç§»ä¸ºå¤åˆå±æ€§ï¼ˆä¿ç•™å‘åå…¼å®¹ï¼‰

## 8. æ£€æŸ¥æ¸…å•

### äº¤äº’ä¸ UI

- [ ] æ¯ä¸ªå¯åŠ¨ç”»å±æ€§æ—éƒ½æœ‰ â—† å…³é”®å¸§æŒ‰é’®
- [ ] æŒ‰é’®æ­£ç¡®æ˜¾ç¤ºä¸‰ç§çŠ¶æ€ï¼ˆæ— /åœ¨å…³é”®å¸§ä¸Š/åœ¨ä¸¤å¸§ä¹‹é—´ï¼‰
- [ ] æ—¶é—´è½´ä¸Šå§‹ç»ˆæ˜¾ç¤ºå…³é”®å¸§è±å½¢ä½ç½®
- [ ] Clip ä¸Šæ˜¾ç¤ºå…³é”®å¸§æ•°é‡å¾½ç« 
- [ ] ä¿®æ”¹å±æ€§å€¼æ—¶è‡ªåŠ¨åˆ›å»ºå…³é”®å¸§ï¼ˆCapCut é£æ ¼ï¼‰

### åŠŸèƒ½

- [ ] æ”¯æŒç¼©æ”¾ X/Yã€ä½ç½® X/Y å››ä¸ªåŸºç¡€å±æ€§
- [ ] çº¿æ€§æ’å€¼å’ŒåŸºç¡€ç¼“åŠ¨ï¼ˆease_in, ease_out, ease_in_out, holdï¼‰
- [ ] æ’­æ”¾æ—¶æ­£ç¡®åº”ç”¨å…³é”®å¸§åŠ¨ç”»
- [ ] å…³é”®å¸§å¯åœ¨æ—¶é—´è½´ä¸Šæ‹–æ‹½è°ƒæ•´ä½ç½®

### æ€§èƒ½

- [ ] æ’å€¼è®¡ç®—æœ‰ç¼“å­˜ï¼Œé¿å…æ¯å¸§é‡å¤è®¡ç®—
- [ ] å…³é”®å¸§æ•°é‡æœ‰åˆç†ä¸Šé™ï¼ˆæ¯å±æ€§æœ€å¤š 50 ä¸ªï¼‰

---

*è®¾è®¡æ—¥æœŸï¼š2026-01-12*  
*æœ€åæ›´æ–°ï¼š2026-01-16ï¼ˆV3 å¤åˆå±æ€§æ¨¡å‹ï¼‰*  
*å‚è€ƒï¼šCapCut å…³é”®å¸§è®¾è®¡æ–‡æ¡£*
