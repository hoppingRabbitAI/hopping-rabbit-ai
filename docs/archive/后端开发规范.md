# HoppingRabbit AI åç«¯å¼€å‘è§„èŒƒ

> ç‰ˆæœ¬: 1.1.0  
> æœ€åæ›´æ–°: 2026-01-16  
> ç»´æŠ¤è€…: @hexiangyang
>
> âš ï¸ **é‡è¦**: å‰åç«¯äº¤äº’ç›¸å…³è§„èŒƒè¯·å‚é˜… [å‰åç«¯äº¤äº’è§„èŒƒ.md](./å‰åç«¯äº¤äº’è§„èŒƒ.md)

---

## ã€‡ã€å‰åç«¯äº¤äº’æ³¨æ„äº‹é¡¹ ğŸ”´

> è¯¦ç»†è§„èŒƒè§ [å‰åç«¯äº¤äº’è§„èŒƒ.md](./å‰åç«¯äº¤äº’è§„èŒƒ.md)ï¼Œæ­¤å¤„åˆ—å‡ºåç«¯å¼€å‘éœ€ç‰¹åˆ«æ³¨æ„çš„è¦ç‚¹ã€‚

### 0.1 æ—¶é—´å•ä½è§„èŒƒ

| åœºæ™¯ | å•ä½ | ç¤ºä¾‹ |
|------|------|------|
| æ•°æ®åº“å­˜å‚¨ | æ¯«ç§’ (ms) | `clip.start = 5000` |
| API è¿”å› | æ¯«ç§’ (ms) | `{"start": 5000}` |
| å…³é”®å¸§ offset | å½’ä¸€åŒ– 0-1 | `{"offset": 0.5}` |
| FFmpeg å‘½ä»¤ | ç§’ (s) | `-ss 5.0` |

```python
# âœ… æ­£ç¡®ï¼šæ˜¾å¼è½¬æ¢å•ä½
ffmpeg_start = clip.start / 1000  # ms -> s
ffmpeg_cmd = f"-ss {ffmpeg_start}"

# âŒ é”™è¯¯ï¼šç›´æ¥ä½¿ç”¨æ¯«ç§’
ffmpeg_cmd = f"-ss {clip.start}"  # ä¼šå¯¼è‡´æ—¶é—´åç§»å·¨å¤§
```

### 0.2 å­—æ®µå‘½åè§„èŒƒ

åç«¯ä½¿ç”¨ **snake_case**ï¼Œè¿”å›ç»™å‰ç«¯æ—¶ä¿æŒ snake_caseï¼Œå‰ç«¯è‡ªè¡Œè½¬æ¢ä¸º camelCaseï¼š

| åç«¯å­—æ®µ | è¯´æ˜ |
|----------|------|
| `source_start` | åª’ä½“æºå†…çš„èµ·å§‹æ—¶é—´ |
| `source_end` | åª’ä½“æºå†…çš„ç»“æŸæ—¶é—´ |
| `start` | æ—¶é—´çº¿ä¸Šçš„ä½ç½®ï¼ˆç›¸å¯¹æ—¶é—´çº¿èµ·ç‚¹ï¼‰ |
| `duration` | ç‰‡æ®µæ—¶é•¿ |

### 0.3 å…³é”®å¸§æ•°æ®æ ¼å¼

```python
# å…³é”®å¸§è¿”å›æ ¼å¼
keyframe = {
    "id": "uuid-string",
    "clip_id": "uuid-string",
    "property": "scale",  # å±æ€§å
    "offset": 0.5,        # 0-1 å½’ä¸€åŒ–ï¼Œç›¸å¯¹äº clip æ—¶é•¿
    "value": {"x": 1.2, "y": 1.2},  # â˜… å¤åˆå±æ€§å¿…é¡»ç”¨ {x, y} æ ¼å¼
    "easing": "linear"    # ç¼“åŠ¨ç±»å‹
}

# â˜… å±æ€§ç±»å‹è§„èŒƒ
# - scale / position: å¤åˆå¯¹è±¡ {"x": number, "y": number}
# - rotation / opacity / volume / pan: ç®€å•æ•°å€¼ number
```

### 0.4 å¸¸è§é”™è¯¯åœºæ™¯

1. **FFmpeg æ—¶é—´å‚æ•°**ï¼šå¿…é¡»ä½¿ç”¨ç§’ï¼Œä¸æ˜¯æ¯«ç§’
2. **sourceStart vs start**ï¼šsourceStart æ˜¯åª’ä½“å†…æ—¶é—´ï¼Œstart æ˜¯æ—¶é—´çº¿ä½ç½®ï¼Œä¸å¯æ··æ·†
3. **å…³é”®å¸§ offset è®¡ç®—**ï¼š`offset = (keyframe_time - clip.start) / clip.duration`
4. **wizard_completed å­˜å‚¨**ï¼šå¿…é¡»å­˜æ•°æ®åº“ï¼Œä¸èƒ½ä¾èµ–å‰ç«¯ localStorage

---

## ä¸€ã€é¡¹ç›®ç»“æ„

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ api/                    # API è·¯ç”±å±‚
â”‚   â”‚   â”œâ”€â”€ assets.py           # ç´ æç®¡ç†
â”‚   â”‚   â”œâ”€â”€ clips.py            # ç‰‡æ®µ CRUD
â”‚   â”‚   â”œâ”€â”€ projects.py         # é¡¹ç›®ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ smart.py            # æ™ºèƒ½åŠŸèƒ½å…¥å£
â”‚   â”‚   â”œâ”€â”€ tasks.py            # ä»»åŠ¡çŠ¶æ€æŸ¥è¯¢
â”‚   â”‚   â””â”€â”€ workspace.py        # å·¥ä½œåŒº & ä¸€é”®æˆç‰‡
â”‚   â”œâ”€â”€ services/               # ä¸šåŠ¡é€»è¾‘å±‚
â”‚   â”‚   â”œâ”€â”€ ai_video_creator.py # ğŸ”¥ ä¸€é”®æˆç‰‡æ ¸å¿ƒç¼–æ’
â”‚   â”‚   â”œâ”€â”€ transform_rules.py  # ğŸ”¥ è¿é•œè§„åˆ™å¼•æ“
â”‚   â”‚   â”œâ”€â”€ llm_service.py      # LLM è°ƒç”¨å°è£…
â”‚   â”‚   â””â”€â”€ supabase_client.py  # æ•°æ®åº“å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ tasks/                  # Celery å¼‚æ­¥ä»»åŠ¡
â”‚   â”‚   â”œâ”€â”€ transcribe.py       # ASR è½¬å†™
â”‚   â”‚   â”œâ”€â”€ vad.py              # è¯­éŸ³æ´»åŠ¨æ£€æµ‹
â”‚   â”‚   â”œâ”€â”€ ai_editing.py       # AI å‰ªè¾‘ä»»åŠ¡
â”‚   â”‚   â””â”€â”€ export.py           # å¯¼å‡ºä»»åŠ¡
â”‚   â”œâ”€â”€ features/               # åŠŸèƒ½æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ vision/             # CV è§†è§‰åˆ†æ
â”‚   â”‚   â””â”€â”€ asset_library/      # ç´ æåº“
â”‚   â”œâ”€â”€ config.py               # é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ models.py               # Pydantic æ¨¡å‹
â”‚   â””â”€â”€ main.py                 # FastAPI å…¥å£
â”œâ”€â”€ scripts/                    # æµ‹è¯•/è°ƒè¯•è„šæœ¬
â”‚   â””â”€â”€ test_transform_rules.py
â”œâ”€â”€ requirements.txt            # æ ¸å¿ƒä¾èµ–
â””â”€â”€ requirements_ai.txt         # AI ç›¸å…³ä¾èµ–
```

---

## äºŒã€æ ¸å¿ƒæ¨¡å—èŒè´£

### 2.1 åˆ†å±‚æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      API Layer (api/)                        â”‚
â”‚           æ¥æ”¶è¯·æ±‚ã€å‚æ•°æ ¡éªŒã€è°ƒç”¨ Service                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Service Layer (services/)                  â”‚
â”‚        ä¸šåŠ¡é€»è¾‘ç¼–æ’ã€è§„åˆ™å¼•æ“ã€å¤–éƒ¨æœåŠ¡è°ƒç”¨                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚AIVideoCreator â”‚  â”‚TransformRules â”‚  â”‚  LLMService   â”‚    â”‚
â”‚  â”‚  (æµç¨‹ç¼–æ’)   â”‚  â”‚  (è§„åˆ™å¼•æ“)   â”‚  â”‚  (LLMå°è£…)    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Task Layer (tasks/)                        â”‚
â”‚              Celery å¼‚æ­¥ä»»åŠ¡ã€è€—æ—¶æ“ä½œ                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Transcribe   â”‚  â”‚     VAD       â”‚  â”‚    Export     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  Feature Layer (features/)                   â”‚
â”‚              ç‹¬ç«‹åŠŸèƒ½æ¨¡å—ã€å¯å¤ç”¨ç»„ä»¶                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚    Vision     â”‚  â”‚ Asset Library â”‚                       â”‚
â”‚  â”‚   (CVåˆ†æ)    â”‚  â”‚   (ç´ æåº“)    â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 ä¸€é”®æˆç‰‡æ•°æ®æµ

```
workspace.py                    ai_video_creator.py              transform_rules.py
     â”‚                                  â”‚                               â”‚
     â”‚  POST /workspace/ai-edit         â”‚                               â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚                               â”‚
     â”‚                                  â”‚                               â”‚
     â”‚                           Step 1: é¢„å¤„ç†                         â”‚
     â”‚                           Step 2: VAD+ASR åˆ‡ç‰‡                   â”‚
     â”‚                           Step 3: CV è§†è§‰åˆ†æ                    â”‚
     â”‚                           Step 4: LLM è¯­ä¹‰åˆ†æ                   â”‚
     â”‚                                  â”‚                               â”‚
     â”‚                           Step 5: è¿é•œå†³ç­–                       â”‚
     â”‚                                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                  â”‚   transform_engine.process()  â”‚
     â”‚                                  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                  â”‚                               â”‚
     â”‚                           Step 6: åºåˆ—æ„ŸçŸ¥åå¤„ç†                  â”‚
     â”‚                                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
     â”‚                                  â”‚   sequence_processor.process()â”‚
     â”‚                                  â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                  â”‚                               â”‚
     â”‚  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  AIEditingResult              â”‚
     â”‚         è¿”å› clips + transforms  â”‚                               â”‚
```

---

## ä¸‰ã€å¼€å‘è§„èŒƒ

### 3.1 ä»£ç é£æ ¼

| ç±»å‹ | å‘½åè§„èŒƒ | ç¤ºä¾‹ |
|------|----------|------|
| æ–‡ä»¶å | `snake_case` | `transform_rules.py` |
| ç±»å | `PascalCase` | `AIVideoCreatorService` |
| å‡½æ•°å | `snake_case` | `generate_transform()` |
| å¸¸é‡ | `UPPER_SNAKE_CASE` | `MAX_CONSECUTIVE_SAME` |
| ç§æœ‰æ–¹æ³• | `_å‰ç¼€` | `_step4_generate_transform()` |
| æšä¸¾å€¼ | `UPPER_SNAKE_CASE` | `EmotionType.EXCITED` |

### 3.2 æ–‡æ¡£å­—ç¬¦ä¸²è§„èŒƒ

```python
def generate_transform(
    segment_id: str,
    duration_ms: float,
    emotion: str = "neutral",
    importance: str = "medium",
    **kwargs
) -> Dict:
    """
    ç”Ÿæˆè¿é•œå…³é”®å¸§æ•°æ®
    
    Args:
        segment_id: ç‰‡æ®µ ID
        duration_ms: ç‰‡æ®µæ—¶é•¿ï¼ˆæ¯«ç§’ï¼‰
        emotion: æƒ…ç»ªç±»å‹ (excited|serious|happy|sad|neutral)
        importance: é‡è¦æ€§çº§åˆ« (high|medium|low)
    
    Returns:
        å…³é”®å¸§æ•°æ®å­—å…¸ï¼ŒåŒ…å«:
        - enable_animation: bool
        - keyframes: List[Dict]
        - _rule_applied: str
    
    Example:
        >>> result = generate_transform("seg_001", 3000, emotion="excited")
        >>> result['keyframes'][0]['scale']
        1.0
    """
```

### 3.3 ç±»å‹æ³¨è§£è§„èŒƒ

```python
# âœ… æ­£ç¡®ï¼šå®Œæ•´ç±»å‹æ³¨è§£
from typing import List, Dict, Optional, Tuple
from dataclasses import dataclass

@dataclass
class TransformParams:
    strategy: ZoomStrategy = ZoomStrategy.KEYFRAME
    start_scale: float = 1.0
    end_scale: float = 1.0

def process(self, context: SegmentContext) -> TransformParams:
    ...

# âŒ é”™è¯¯ï¼šç¼ºå°‘ç±»å‹æ³¨è§£
def process(self, context):
    return TransformParams()
```

### 3.4 é”™è¯¯å¤„ç†è§„èŒƒ

```python
# âœ… æ­£ç¡®ï¼šæ˜ç¡®çš„å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—
async def analyze_video(self, video_path: str) -> AnalysisResult:
    try:
        result = await self._run_analysis(video_path)
        logger.info(f"åˆ†æå®Œæˆ: {video_path}, è€—æ—¶: {result.duration}ms")
        return result
    except FileNotFoundError:
        logger.error(f"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {video_path}")
        raise HTTPException(status_code=404, detail="Video not found")
    except AnalysisError as e:
        logger.warning(f"åˆ†æå¤±è´¥: {e}, ä½¿ç”¨é»˜è®¤å€¼")
        return AnalysisResult.default()

# âŒ é”™è¯¯ï¼šåæ‰å¼‚å¸¸
async def analyze_video(self, video_path: str):
    try:
        return await self._run_analysis(video_path)
    except:
        pass  # ä¸è¦è¿™æ ·åšï¼
```

---

## å››ã€è¿é•œè§„åˆ™å¼•æ“è§„èŒƒ

### 4.1 æ–°å¢è§„åˆ™ Checklist

æ·»åŠ æ–°è§„åˆ™æ—¶ï¼Œå¿…é¡»å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼š

```markdown
## æ–°è§„åˆ™ PR è‡ªæ£€æ¸…å•

### è§„åˆ™è®¾è®¡
- [ ] ç»§æ‰¿ `TransformRule` åŸºç±»
- [ ] å®ç° `match()` å’Œ `apply()` æ–¹æ³•
- [ ] è®¾ç½®åˆç†çš„ `priority` (æ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜)
- [ ] æ·»åŠ å®Œæ•´çš„ docstring è¯´æ˜è§„åˆ™é€»è¾‘

### è§„åˆ™æ³¨å†Œ
- [ ] åœ¨ `TransformRuleEngine._register_default_rules()` ä¸­æ³¨å†Œ
- [ ] ç¡®è®¤ä¼˜å…ˆçº§ä¸ä¸ç°æœ‰è§„åˆ™å†²çª

### æµ‹è¯•è¦†ç›–
- [ ] åœ¨ `test_transform_rules.py` æ·»åŠ æµ‹è¯•ç”¨ä¾‹
- [ ] æµ‹è¯•è¾¹ç•Œæ¡ä»¶ï¼ˆæ—¶é•¿æçŸ­/æé•¿ã€æ— äººè„¸ç­‰ï¼‰
- [ ] éªŒè¯ä¸ç°æœ‰è§„åˆ™çš„äº¤äº’

### æ–‡æ¡£æ›´æ–°
- [ ] æ›´æ–° `AI_VIDEO_CREATION_SOP.md` è§„åˆ™è¡¨æ ¼
- [ ] å¦‚æœ‰æ–°å‚æ•°ï¼Œæ›´æ–°é…ç½®è¯´æ˜
```

### 4.2 è§„åˆ™å®ç°æ¨¡æ¿

```python
class MyNewRule(TransformRule):
    """
    æˆ‘çš„æ–°è§„åˆ™
    
    é€‚ç”¨åœºæ™¯ï¼šæè¿°ä»€ä¹ˆæƒ…å†µä¸‹ä½¿ç”¨æ­¤è§„åˆ™
    
    ç­–ç•¥è¯´æ˜ï¼š
    - æ¡ä»¶Aï¼šåšä»€ä¹ˆ
    - æ¡ä»¶Bï¼šåšä»€ä¹ˆ
    """
    
    name = "my_new_rule"
    priority = 15  # åœ¨ EmotionZoomRule(10) ä¹‹åï¼ŒNoFaceZoomRule(20) ä¹‹å‰
    
    def match(self, context: SegmentContext) -> bool:
        """
        åŒ¹é…æ¡ä»¶ï¼š
        1. æ¡ä»¶1
        2. æ¡ä»¶2
        """
        if context.is_breath:
            return False
        return context.xxx and context.duration_seconds > 2.0
    
    def apply(self, context: SegmentContext) -> TransformParams:
        """æ ¹æ®å…·ä½“æƒ…å†µç”Ÿæˆå‚æ•°"""
        return TransformParams(
            strategy=ZoomStrategy.KEYFRAME,
            start_scale=1.0,
            end_scale=1.15,
            easing=EasingType.EASE_OUT,
            rule_applied=f"{self.name}:å…·ä½“æ ‡ç­¾"
        )
```

### 4.3 è§„åˆ™ä¼˜å…ˆçº§åˆ†é…

| ä¼˜å…ˆçº§èŒƒå›´ | ç”¨é€” | ç°æœ‰è§„åˆ™ |
|------------|------|----------|
| 1-4 | æœ€é«˜ä¼˜å…ˆï¼Œç‰¹æ®Šå¤„ç† | `BreathClipRule` (1), `SuddenEmphasisRule` (2) |
| 5-9 | åŸºäºæ—¶é•¿çš„é¢„è¿‡æ»¤ | `ShortClipRule` (5) |
| 10-19 | æ ¸å¿ƒä¸šåŠ¡è§„åˆ™ | `EmotionZoomRule` (10) |
| 20-29 | å…œåº•è§„åˆ™ | `NoFaceZoomRule` (20) |
| 30+ | é¢„ç•™æ‰©å±• | - |

---

## äº”ã€å¼‚æ­¥ä»»åŠ¡è§„èŒƒ

### 5.1 Celery ä»»åŠ¡æ¨¡æ¿

```python
from celery import shared_task
from app.celery_config import celery_app

@celery_app.task(
    bind=True,
    max_retries=3,
    default_retry_delay=60,
    autoretry_for=(ConnectionError, TimeoutError),
)
def process_video_task(self, video_id: str, options: dict):
    """
    è§†é¢‘å¤„ç†ä»»åŠ¡
    
    Args:
        video_id: è§†é¢‘ ID
        options: å¤„ç†é€‰é¡¹
    
    Retries:
        æœ€å¤šé‡è¯• 3 æ¬¡ï¼Œé—´éš” 60 ç§’
    """
    try:
        logger.info(f"[Task {self.request.id}] å¼€å§‹å¤„ç†: {video_id}")
        result = process_video(video_id, options)
        logger.info(f"[Task {self.request.id}] å¤„ç†å®Œæˆ: {video_id}")
        return result
    except SoftTimeLimitExceeded:
        logger.warning(f"[Task {self.request.id}] è¶…æ—¶: {video_id}")
        raise
```

### 5.2 ä»»åŠ¡çŠ¶æ€æ›´æ–°

```python
# ä»»åŠ¡è¿›åº¦æ›´æ–°æ¨¡å¼
@celery_app.task(bind=True)
def long_running_task(self, video_id: str):
    total_steps = 5
    
    for i, step in enumerate(["VAD", "ASR", "CV", "LLM", "Transform"]):
        self.update_state(
            state='PROGRESS',
            meta={
                'current': i + 1,
                'total': total_steps,
                'step': step,
                'percent': int((i + 1) / total_steps * 100)
            }
        )
        # æ‰§è¡Œæ­¥éª¤...
    
    return {'status': 'completed', 'video_id': video_id}
```

---

## å…­ã€æ—¥å¿—è§„èŒƒ

### 6.1 æ—¥å¿—çº§åˆ«ä½¿ç”¨

| çº§åˆ« | åœºæ™¯ | ç¤ºä¾‹ |
|------|------|------|
| `DEBUG` | å¼€å‘è°ƒè¯•ï¼Œè¯¦ç»†è¿‡ç¨‹ | `logger.debug(f"è§„åˆ™åŒ¹é…: {rule.name}")` |
| `INFO` | å…³é”®ä¸šåŠ¡èŠ‚ç‚¹ | `logger.info(f"âœ… Step 4 å®Œæˆ: {len(segments)} ä¸ªç‰‡æ®µ")` |
| `WARNING` | å¯æ¢å¤çš„å¼‚å¸¸ | `logger.warning(f"LLM å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼")` |
| `ERROR` | ä¸å¯æ¢å¤çš„é”™è¯¯ | `logger.error(f"è§†é¢‘æ–‡ä»¶ä¸å­˜åœ¨: {path}")` |

### 6.2 æ—¥å¿—æ ¼å¼

```python
# âœ… æ¨èï¼šç»“æ„åŒ–æ—¥å¿—ï¼Œæ˜“äºè¿½è¸ª
logger.info(f"[AICreator] Step {step_num}: {step_name} | è¾“å…¥: {input_count} | è¾“å‡º: {output_count}")
logger.info(f"   ğŸ“Š è§„åˆ™ç»Ÿè®¡: {rule_counts}")
logger.info(f"   ğŸ¬ æ•ˆæœåˆ†å¸ƒ: zoom_in={zoom_in}, static={static}")

# âŒ é¿å…ï¼šæ— ä¸Šä¸‹æ–‡çš„æ—¥å¿—
logger.info("done")
logger.info(result)
```

---

## ä¸ƒã€æµ‹è¯•è§„èŒƒ

### 7.1 æµ‹è¯•æ–‡ä»¶ç»“æ„

```
backend/
â”œâ”€â”€ scripts/
â”‚   â”œâ”€â”€ test_transform_rules.py    # è§„åˆ™å¼•æ“æµ‹è¯•
â”‚   â”œâ”€â”€ test_llm_api.py            # LLM æœåŠ¡æµ‹è¯•
â”‚   â””â”€â”€ test_ai_creator.py         # é›†æˆæµ‹è¯•
â””â”€â”€ tests/                         # å•å…ƒæµ‹è¯• (pytest)
    â”œâ”€â”€ test_models.py
    â””â”€â”€ test_services.py
```

### 7.2 æµ‹è¯•ç”¨ä¾‹æ¨¡æ¿

```python
def test_sequence_aware():
    """æµ‹è¯•åºåˆ—æ„ŸçŸ¥åå¤„ç†å™¨"""
    # Arrange: å‡†å¤‡æµ‹è¯•æ•°æ®
    segments = [
        {"segment_id": "1", "emotion": "neutral", "importance": "medium", ...},
        {"segment_id": "2", "emotion": "neutral", "importance": "medium", ...},
        {"segment_id": "3", "emotion": "neutral", "importance": "medium", ...},
    ]
    
    # Act: æ‰§è¡Œè¢«æµ‹å‡½æ•°
    results = generate_transforms_batch(segments, enable_sequence_aware=True)
    
    # Assert: éªŒè¯ç»“æœ
    effects = [classify_effect(r) for r in results]
    assert len(set(effects)) > 1, "åº”è¯¥æœ‰å¤šç§æ•ˆæœç±»å‹"
    
    # éªŒè¯ä¸è¿ç»­è¶…è¿‡2ä¸ªç›¸åŒæ•ˆæœ
    for i in range(len(effects) - 2):
        same_count = sum(1 for e in effects[i:i+3] if e == effects[i])
        assert same_count <= 2, f"è¿ç»­ç›¸åŒæ•ˆæœä¸åº”è¶…è¿‡2ä¸ª: {effects[i:i+3]}"
```

### 7.3 è¿è¡Œæµ‹è¯•

```bash
# è¿è¡Œè§„åˆ™å¼•æ“æµ‹è¯•
cd backend
.venv/bin/python scripts/test_transform_rules.py

# è¿è¡Œ pytest å•å…ƒæµ‹è¯•
.venv/bin/pytest tests/ -v

# è¿è¡Œå•ä¸ªæµ‹è¯•æ–‡ä»¶
.venv/bin/pytest tests/test_services.py -v
```

---

## å…«ã€ä»£ç å®¡æŸ¥æ¸…å•

### 8.1 é€šç”¨æ£€æŸ¥

```markdown
## PR å®¡æŸ¥æ¸…å•

### ä»£ç è´¨é‡
- [ ] å‡½æ•°/æ–¹æ³•æœ‰å®Œæ•´çš„ docstring
- [ ] æ‰€æœ‰å‚æ•°å’Œè¿”å›å€¼æœ‰ç±»å‹æ³¨è§£
- [ ] å¼‚å¸¸å¤„ç†å®Œå–„ï¼Œä¸åæ‰é”™è¯¯
- [ ] æ—¥å¿—è¾“å‡ºåˆç†ï¼Œä¾¿äºè¿½è¸ª

### æ€§èƒ½
- [ ] é¿å…åœ¨å¾ªç¯ä¸­è¿›è¡Œ IO æ“ä½œ
- [ ] å¤§æ•°æ®å¤„ç†è€ƒè™‘åˆ†æ‰¹/æµå¼
- [ ] å¼‚æ­¥æ“ä½œæ­£ç¡®ä½¿ç”¨ async/await

### å®‰å…¨
- [ ] ç”¨æˆ·è¾“å…¥æœ‰æ ¡éªŒ
- [ ] SQL ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
- [ ] æ•æ„Ÿä¿¡æ¯ä¸è®°å½•åˆ°æ—¥å¿—

### å…¼å®¹æ€§
- [ ] æ–°å¢å­—æ®µæœ‰é»˜è®¤å€¼
- [ ] API å˜æ›´è€ƒè™‘å‘åå…¼å®¹
- [ ] é…ç½®é¡¹æœ‰ç¯å¢ƒå˜é‡æ”¯æŒ
```

### 8.2 è¿é•œè§„åˆ™ä¸“é¡¹æ£€æŸ¥

```markdown
## è¿é•œè§„åˆ™ PR æ£€æŸ¥æ¸…å•

### è§„åˆ™è®¾è®¡
- [ ] è§„åˆ™ä¼˜å…ˆçº§åˆç†ï¼Œä¸ä¸ç°æœ‰è§„åˆ™å†²çª
- [ ] match() æ¡ä»¶æ¸…æ™°ï¼Œè¾¹ç•Œæ˜ç¡®
- [ ] apply() è¿”å›å€¼ç¬¦åˆ TransformParams è§„èŒƒ
- [ ] rule_applied æ ‡ç­¾ä¾¿äºè°ƒè¯•è¿½è¸ª

### æ•ˆæœéªŒè¯
- [ ] è¿è¡Œ test_transform_rules.py é€šè¿‡
- [ ] æµ‹è¯•è¦†ç›–è¾¹ç•Œæƒ…å†µï¼ˆçŸ­ç‰‡æ®µã€æ— äººè„¸ã€é«˜æ½®ç‚¹ç­‰ï¼‰
- [ ] éªŒè¯ä¸åºåˆ—æ„ŸçŸ¥åå¤„ç†å™¨çš„äº¤äº’

### æ–‡æ¡£åŒæ­¥
- [ ] æ›´æ–° AI_VIDEO_CREATION_SOP.md
- [ ] è§„åˆ™è¡¨æ ¼ä¸­æ·»åŠ æ–°è§„åˆ™è¯´æ˜
```

---

## ä¹ã€æ•°æ®åº“ä¸ SQL ä¼˜åŒ–è§„èŒƒ

> **é‡è¦**: æ•°æ®åº“æ“ä½œæ˜¯åç«¯æ€§èƒ½çš„å…³é”®ç“¶é¢ˆï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹è§„èŒƒã€‚

### 9.1 N+1 æŸ¥è¯¢é—®é¢˜

**âŒ é”™è¯¯ç¤ºèŒƒï¼ˆå¾ªç¯ä¸­é€ä¸ªæŸ¥è¯¢ï¼‰**:
```python
# é—®é¢˜ï¼šæ¯ä¸ª track éƒ½å‘èµ·ä¸€æ¬¡ SQL æŸ¥è¯¢
for track in tracks.data:
    clips = supabase.table("clips").select("id").eq("track_id", track["id"]).execute()
    for clip in clips.data:
        supabase.table("keyframes").delete().eq("clip_id", clip["id"]).execute()
```

**âœ… æ­£ç¡®åšæ³•ï¼ˆæ‰¹é‡æŸ¥è¯¢ + æ‰¹é‡æ“ä½œï¼‰**:
```python
# 1. ä¸€æ¬¡æ€§è·å–æ‰€æœ‰ track IDs
track_ids = [t["id"] for t in tracks.data]

# 2. ä½¿ç”¨ in_() æ‰¹é‡æŸ¥è¯¢
clips = supabase.table("clips").select("id").in_("track_id", track_ids).execute()
clip_ids = [c["id"] for c in clips.data]

# 3. ä½¿ç”¨ in_() æ‰¹é‡åˆ é™¤
if clip_ids:
    supabase.table("keyframes").delete().in_("clip_id", clip_ids).execute()
if track_ids:
    supabase.table("clips").delete().in_("track_id", track_ids).execute()
```

### 9.2 æŸ¥è¯¢ä¼˜åŒ–åŸåˆ™

#### 9.2.1 åªæŸ¥éœ€è¦çš„å­—æ®µ

```python
# âŒ é”™è¯¯ï¼šæŸ¥è¯¢æ‰€æœ‰å­—æ®µ
result = supabase.table("projects").select("*").eq("id", project_id).execute()

# âœ… æ­£ç¡®ï¼šåªæŸ¥éœ€è¦çš„å­—æ®µ
result = supabase.table("projects").select("id, user_id, status").eq("id", project_id).execute()
```

#### 9.2.2 ä½¿ç”¨æ‰¹é‡æ“ä½œ

```python
# âŒ é”™è¯¯ï¼šå¾ªç¯ä¸­é€ä¸ªåˆ é™¤
for clip_id in clip_ids:
    supabase.table("clips").delete().eq("id", clip_id).execute()

# âœ… æ­£ç¡®ï¼šæ‰¹é‡åˆ é™¤
supabase.table("clips").delete().in_("id", clip_ids).execute()
```

#### 9.2.3 å¤ç”¨æƒé™éªŒè¯ç»“æœ

```python
# âŒ é”™è¯¯ï¼šå¤šæ¬¡éªŒè¯åŒä¸€ä¸ªé¡¹ç›®
async def some_operation(project_id: str, user_id: str):
    await verify_project_access(project_id, user_id)  # æŸ¥è¯¢ 1
    # ... ä¸€äº›æ“ä½œ
    await verify_project_access(project_id, user_id)  # æŸ¥è¯¢ 2ï¼ˆé‡å¤ï¼ï¼‰

# âœ… æ­£ç¡®ï¼šéªŒè¯ä¸€æ¬¡å¹¶å¤ç”¨ç»“æœ
async def some_operation(project_id: str, user_id: str):
    project = await verify_project_access(project_id, user_id)  # æŸ¥è¯¢ 1
    # ä½¿ç”¨ project å¯¹è±¡ï¼Œæ— éœ€å†æ¬¡æŸ¥è¯¢
    if project["status"] == "archived":
        raise HTTPException(...)
```

### 9.3 æ‰¹é‡ URL ç­¾å

```python
# âŒ é”™è¯¯ï¼šå¾ªç¯ç”Ÿæˆç­¾å URL
for asset in assets:
    asset["url"] = get_file_url("clips", asset["storage_path"])

# âœ… æ­£ç¡®ï¼šæ‰¹é‡ç”Ÿæˆ
from ..services.supabase_client import get_file_urls_batch

paths = [a["storage_path"] for a in assets if a.get("storage_path")]
url_map = get_file_urls_batch("clips", paths)
for asset in assets:
    asset["url"] = url_map.get(asset["storage_path"], "")
```

### 9.4 çº§è”åˆ é™¤ä¼˜åŒ–

å¯¹äºå…³è”æ•°æ®çš„åˆ é™¤ï¼Œæ¨èé¡ºåºï¼ˆç”±å­åˆ°çˆ¶ï¼‰:

```python
async def delete_project_cascade(project_id: str):
    """çº§è”åˆ é™¤é¡¹ç›®ï¼ˆä¼˜åŒ–ç‰ˆï¼‰"""
    # 1. è·å–æ‰€æœ‰å…³è” IDï¼ˆ2æ¬¡æŸ¥è¯¢ï¼‰
    tracks = supabase.table("tracks").select("id").eq("project_id", project_id).execute()
    track_ids = [t["id"] for t in tracks.data] if tracks.data else []
    
    clip_ids = []
    if track_ids:
        clips = supabase.table("clips").select("id").in_("track_id", track_ids).execute()
        clip_ids = [c["id"] for c in clips.data] if clips.data else []
    
    # 2. æŒ‰ä¾èµ–é¡ºåºæ‰¹é‡åˆ é™¤ï¼ˆ4æ¬¡åˆ é™¤ï¼‰
    if clip_ids:
        supabase.table("keyframes").delete().in_("clip_id", clip_ids).execute()
        supabase.table("clips").delete().in_("id", clip_ids).execute()
    if track_ids:
        supabase.table("tracks").delete().in_("id", track_ids).execute()
    
    supabase.table("assets").delete().eq("project_id", project_id).execute()
    supabase.table("projects").delete().eq("id", project_id).execute()
```

### 9.5 åˆ†é¡µæŸ¥è¯¢

```python
# å¤§é‡æ•°æ®æŸ¥è¯¢å¿…é¡»åˆ†é¡µ
@router.get("/clips")
async def list_clips(
    project_id: str,
    limit: int = Query(100, ge=1, le=500),
    offset: int = Query(0, ge=0)
):
    result = supabase.table("clips").select("*").eq(
        "project_id", project_id
    ).range(offset, offset + limit - 1).execute()
    
    return {
        "items": result.data,
        "limit": limit,
        "offset": offset
    }
```

### 9.6 æŸ¥è¯¢æ€§èƒ½æ¸…å•

åœ¨ Code Review æ—¶æ£€æŸ¥ä»¥ä¸‹é¡¹ç›®ï¼š

| æ£€æŸ¥é¡¹ | è¯´æ˜ |
|-------|------|
| âŒ å¾ªç¯å†…æŸ¥è¯¢ | ç¦æ­¢åœ¨ for å¾ªç¯ä¸­æ‰§è¡Œ SQL |
| âŒ SELECT * | åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ |
| âŒ é‡å¤æƒé™éªŒè¯ | åŒä¸€è¯·æ±‚å†…å¤ç”¨éªŒè¯ç»“æœ |
| âœ… ä½¿ç”¨ in_() | æ‰¹é‡ ID æŸ¥è¯¢ç”¨ in_() |
| âœ… ä½¿ç”¨ range() | åˆ—è¡¨æŸ¥è¯¢å¿…é¡»åˆ†é¡µ |
| âœ… æ‰¹é‡ URL ç­¾å | ä½¿ç”¨ get_file_urls_batch |
| âœ… æ·»åŠ ç´¢å¼• | é«˜é¢‘æŸ¥è¯¢å­—æ®µéœ€å»ºç´¢å¼• |

### 9.7 æ¨èæ•°æ®åº“ç´¢å¼•

```sql
-- é«˜é¢‘æŸ¥è¯¢å­—æ®µå»ºè®®ç´¢å¼•
CREATE INDEX IF NOT EXISTS idx_clips_track_id ON clips(track_id);
CREATE INDEX IF NOT EXISTS idx_clips_asset_id ON clips(asset_id);
CREATE INDEX IF NOT EXISTS idx_tracks_project_id ON tracks(project_id);
CREATE INDEX IF NOT EXISTS idx_assets_project_id ON assets(project_id);
CREATE INDEX IF NOT EXISTS idx_keyframes_clip_id ON keyframes(clip_id);
CREATE INDEX IF NOT EXISTS idx_projects_user_id ON projects(user_id);

-- å¤åˆç´¢å¼•ï¼ˆæŒ‰æ—¶é—´æ’åºçš„åœºæ™¯ï¼‰
CREATE INDEX IF NOT EXISTS idx_clips_track_start ON clips(track_id, start_time);
```

---

## åã€é…ç½®ç®¡ç†

### 9.1 ç¯å¢ƒå˜é‡

```bash
# backend/.env

# === å¿…éœ€ ===
SUPABASE_URL=https://xxx.supabase.co
SUPABASE_KEY=xxx
SUPABASE_SERVICE_KEY=xxx

# === LLM é…ç½® ===
DEEPSEEK_API_KEY=xxx
DEEPSEEK_BASE_URL=https://api.deepseek.com

# === å¯é€‰ ===
DEV_MODE=true              # å¼€å‘æ¨¡å¼ï¼Œè¾“å‡ºè¯¦ç»†æ—¥å¿—
LOG_LEVEL=INFO             # æ—¥å¿—çº§åˆ«
CELERY_BROKER_URL=redis://localhost:6379/0
```

### 9.2 é…ç½®ç±»

```python
# app/config.py
from pydantic_settings import BaseSettings

class Settings(BaseSettings):
    # å¿…éœ€é…ç½®
    supabase_url: str
    supabase_key: str
    
    # å¯é€‰é…ç½®ï¼ˆæœ‰é»˜è®¤å€¼ï¼‰
    dev_mode: bool = False
    log_level: str = "INFO"
    
    # è¿é•œè§„åˆ™é…ç½®
    max_consecutive_same_effect: int = 2
    post_climax_rest_count: int = 1
    
    class Config:
        env_file = ".env"
```

---

## åã€å˜æ›´æ—¥å¿—
### 2026-01-14 (v1.2.0)
- **æ–°å¢**: æ•°æ®åº“ä¸ SQL ä¼˜åŒ–è§„èŒƒï¼ˆç¬¬ä¹ç« ï¼‰
- **ä¼˜åŒ–**: ä¿®å¤ `projects.py` ä¸­çš„ N+1 æŸ¥è¯¢é—®é¢˜ï¼ˆçº§è”åˆ é™¤ã€å¿«ç…§æ¢å¤ï¼‰
- **ä¼˜åŒ–**: ä¿®å¤ `clips.py` ä¸­çš„æ‰¹é‡åˆ é™¤ä½¿ç”¨å¾ªç¯é—®é¢˜
- **ä¼˜åŒ–**: ä¿®å¤ `smart.py` ä¸­çš„å…³é”®å¸§æ‰¹é‡åˆ é™¤é—®é¢˜
- **æ–°å¢**: æ¨èæ•°æ®åº“ç´¢å¼•é…ç½®
- **æ–°å¢**: æŸ¥è¯¢æ€§èƒ½æ£€æŸ¥æ¸…å•
### 2026-01-13 (v1.1.0)
- **æ–°å¢**: çªå‘è¿é•œè§„åˆ™ (`SuddenEmphasisRule`)ï¼Œæ”¯æŒå…³é”®è¯ç¬é—´ç‰¹å†™
- **æ–°å¢**: ASR è¯çº§æ—¶é—´æˆ³æ”¯æŒï¼Œå®ç°ç²¾ç»†åŒ–å¾®åˆ‡ç‰‡
- **ä¼˜åŒ–**: æ›´æ–° `AI_VIDEO_CREATION_SOP.md` æ“ä½œè§„èŒƒ
- **æ–°å¢**: åˆ›å»ºåç«¯å¼€å‘è§„èŒƒæ–‡æ¡£
- **æ–°å¢**: è¿é•œè§„åˆ™å¼•æ“å¼€å‘è§„èŒƒ
- **æ–°å¢**: åºåˆ—æ„ŸçŸ¥åå¤„ç†å™¨ (`SequenceAwarePostProcessor`)
- **æ–°å¢**: ä»£ç å®¡æŸ¥æ¸…å•
- **æ–‡æ¡£**: å®šä¹‰åˆ†å±‚æ¶æ„å’Œæ•°æ®æµ
