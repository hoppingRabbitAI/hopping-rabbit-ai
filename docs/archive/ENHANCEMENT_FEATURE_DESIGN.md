# AI ç”Ÿæˆå¢å¼ºåŠŸèƒ½è®¾è®¡

## 1. èƒŒæ™¯ä¸ç›®æ ‡

### 1.1 ç”¨æˆ·ç—›ç‚¹
å½“ AI ç”Ÿæˆçš„æ•ˆæœä¸æ»¡æ„æ—¶ï¼Œç”¨æˆ·éœ€è¦ï¼š
1. **é‡æ–°ç”Ÿæˆ** - ä¿æŒåŒæ ·å‚æ•°ï¼Œæ¢ä¸€ä¸ªéšæœºç»“æœ
2. **ç»†ç²’åº¦ä¼˜åŒ–** - å•ç‹¬ä¼˜åŒ–èƒŒæ™¯ï¼Œå†ä¸äººç‰©åˆæˆ
3. **ç‰ˆæœ¬å¯¹æ¯”** - æµè§ˆå†å²ç”Ÿæˆç»“æœï¼Œé€‰æ‹©æœ€æ»¡æ„çš„

### 1.2 å¸‚åœºè°ƒç ”æ€»ç»“

| äº§å“ | æ ¸å¿ƒåŠŸèƒ½ | å€¼å¾—å€Ÿé‰´ |
|------|---------|---------|
| **Adobe Generative Fill** | Generate Similar / Reference Image | ã€Œç›¸ä¼¼ç”Ÿæˆã€è®©ç”¨æˆ·åœ¨å–œæ¬¢çš„ç‰ˆæœ¬åŸºç¡€ä¸Šå¾®è°ƒ |
| **Runway Gen-3** | Fine-grained temporal control | ç²¾ç»†çš„åŒºåŸŸæ§åˆ¶ï¼Œåˆ†å±‚å¤„ç† |
| **DALLÂ·E 3** | ChatGPT åä½œ prompt ä¼˜åŒ– | äº¤äº’å¼ prompt æ”¹è¿› |

## 2. åŠŸèƒ½è®¾è®¡

### 2.0 æ ¸å¿ƒç†å¿µï¼šè¿­ä»£å¼ç”Ÿæˆï¼ˆAgent å¿…é¡»ç†è§£ï¼‰

**ç”¨æˆ·å·¥ä½œæµæ˜¯è¿­ä»£çš„ï¼Œè€Œä¸æ˜¯ä¸€æ¬¡æ€§çš„ï¼š**

```
ç¬¬ä¸€æ¬¡ç”Ÿæˆ â†’ ä¸æ»¡æ„ â†’ è°ƒæ•´å‚æ•° â†’ é‡æ–°ç”Ÿæˆ â†’ ä¸æ»¡æ„ â†’ å†è°ƒæ•´ â†’ ... â†’ æ»¡æ„ â†’ ç¡®è®¤
```

**Agent å¿…é¡»ç†è§£çš„å…³é”®ç‚¹ï¼š**

1. **ç”¨æˆ·å¯èƒ½ä¼šä¿®æ”¹ prompt**ï¼šç”Ÿæˆåç”¨æˆ·å¯ä»¥ä¿®æ”¹æè¿°ï¼Œç„¶åé‡æ–°ç”Ÿæˆ
2. **ç”¨æˆ·å¯èƒ½ä¼šä¿®æ”¹ mask**ï¼šç”Ÿæˆåç”¨æˆ·å¯ä»¥é‡æ–°æ¶‚æŠ¹ä¿®æ”¹åŒºåŸŸï¼Œç„¶åé‡æ–°ç”Ÿæˆ
3. **ç”¨æˆ·å¯èƒ½åŒæ—¶ä¿®æ”¹ prompt + mask**ï¼šä¸¤è€…éƒ½å¯ä»¥è°ƒæ•´
4. **å†å²ç‰ˆæœ¬å¯å›æº¯**ï¼šç”¨æˆ·å¯ä»¥å¯¹æ¯”å¤šä¸ªç‰ˆæœ¬ï¼Œé€‰æ‹©æœ€æ»¡æ„çš„
5. **ã€Œæ¢ä¸€ä¸ªã€= ä¿æŒå‚æ•°æ¢ç»“æœ**ï¼šç›¸åŒ prompt + maskï¼Œä½†æ¢ä¸€ä¸ªéšæœºç»“æœ

**å‰ç«¯æ”¯æŒçš„æ“ä½œï¼š**
- âœ… ä¿®æ”¹ prompt åç‚¹ã€Œé‡æ–°ç”Ÿæˆã€
- âœ… ç‚¹ã€Œé‡æ–°æ¶‚æŠ¹ä¿®æ”¹åŒºåŸŸã€é‡æ–°ç”» mask
- âœ… ç‚¹ã€Œæ¢ä¸€ä¸ªã€ä¿æŒå‚æ•°æ¢ç»“æœ
- âœ… ç‚¹å†å²ç¼©ç•¥å›¾åˆ‡æ¢ç‰ˆæœ¬
- âœ… æœ€ç»ˆç‚¹ã€Œç¡®è®¤ã€åº”ç”¨é€‰ä¸­çš„ç‰ˆæœ¬

---

### 2.1 åŠŸèƒ½ä¸€ï¼šé‡æ–°ç”Ÿæˆ (Regenerate)

**ç”¨æˆ·åœºæ™¯**: ç”Ÿæˆç»“æœä¸æ»¡æ„ï¼Œä½† prompt æ˜¯å¯¹çš„ï¼Œå¸Œæœ›æ¢ä¸€ä¸ªéšæœºç§å­é‡æ–°ç”Ÿæˆ

**å‰ç«¯äº¤äº’**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [é¢„è§ˆå›¾]                               â”‚
â”‚                                         â”‚
â”‚  âœ“ ç¬¬ 3 æ¬¡ç”Ÿæˆ                          â”‚
â”‚                                         â”‚
â”‚  [ğŸ”„ é‡æ–°ç”Ÿæˆ]  [âœ¨ ç›¸ä¼¼ç”Ÿæˆ]  [âœ“ ç¡®è®¤]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**API è®¾è®¡**:
```typescript
interface GenerateParams {
  clipId: string;
  capabilityId: string;
  prompt: string;
  maskDataUrl?: string;
  keyframeUrl: string;
  
  // â˜… æ–°å¢
  seed?: number;           // éšæœºç§å­ï¼Œä¸ä¼ åˆ™è‡ªåŠ¨ç”Ÿæˆ
  baseTaskId?: string;     // åŸºäºå“ªä¸ªä»»åŠ¡çš„ç»“æœåšç›¸ä¼¼ç”Ÿæˆ
  regenerate?: boolean;    // æ˜¯å¦æ˜¯é‡æ–°ç”Ÿæˆï¼ˆåŒ prompt æ¢ seedï¼‰
}
```

**åç«¯å®ç°**:
- æ¯æ¬¡ç”Ÿæˆä¿å­˜ `seed` åˆ°ä»»åŠ¡è®°å½•
- é‡æ–°ç”Ÿæˆæ—¶ï¼šä½¿ç”¨æ–° seedï¼Œå…¶ä»–å‚æ•°ä¸å˜
- ç›¸ä¼¼ç”Ÿæˆæ—¶ï¼šåŸºäºä¸Šä¸€æ¬¡ç»“æœåš variationï¼ˆå¦‚æœ API æ”¯æŒï¼‰

---

### 2.2 åŠŸèƒ½äºŒï¼šç»†ç²’åº¦ä¼˜åŒ–æµç¨‹ (Multi-Step Refinement)

**ç”¨æˆ·åœºæ™¯**: ç”¨æˆ·è¦æ±‚ã€Œå…ˆç»†åŒ–èƒŒæ™¯ï¼Œæœ€åå†å’Œäººç‰© combine æˆæ–°å›¾ã€

**è®¾è®¡æ€è·¯**ï¼ˆåŸºäº Adobe Generative Fill çš„åˆ†å±‚æ¦‚å¿µï¼‰:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: åˆ†ç¦»äººç‰©ä¸èƒŒæ™¯                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ åŸå›¾    â”‚ -> â”‚ äººç‰©    â”‚ + â”‚ èƒŒæ™¯    â”‚                â”‚
â”‚  â”‚         â”‚    â”‚ (æŠ å›¾)  â”‚   â”‚ (å»äºº)  â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                                                          â”‚
â”‚  Step 2: å•ç‹¬ä¼˜åŒ–èƒŒæ™¯                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚  â”‚ èƒŒæ™¯    â”‚ -> â”‚ æ–°èƒŒæ™¯  â”‚ (prompt: æµ·è¾¹æ—¥è½...)        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                          â”‚
â”‚  Step 3: åˆæˆæœ€ç»ˆå›¾                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ äººç‰©    â”‚ +  â”‚ æ–°èƒŒæ™¯  â”‚ -> â”‚ æœ€ç»ˆå›¾  â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                          â”‚
â”‚  â˜… ç”¨æˆ·å¯ä»¥åœ¨ Step 2 å¤šæ¬¡ç”Ÿæˆï¼Œç›´åˆ°æ»¡æ„å†åˆæˆ             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**UI è®¾è®¡ - åˆ†æ­¥å‘å¯¼æ¨¡å¼**:

```tsx
// æ–°ç»„ä»¶ï¼šMultiStepRefineEditor
type RefineStep = 'extract' | 'refine-bg' | 'composite' | 'done';

interface RefineState {
  step: RefineStep;
  personLayer: string | null;     // æŠ å›¾åçš„äººç‰© URL
  originalBackground: string | null;
  refinedBackground: string | null; // ä¼˜åŒ–åçš„èƒŒæ™¯
  compositeResult: string | null;
  backgroundHistory: string[];    // èƒŒæ™¯ç”Ÿæˆå†å²
}
```

**æµç¨‹è¯¦è§£**:

| æ­¥éª¤ | åŠ¨ä½œ | API è°ƒç”¨ |
|------|------|---------|
| Step 1 | åˆ†ç¦»äººç‰© | ä½¿ç”¨ç°æœ‰ Kling æŠ å›¾èƒ½åŠ›æˆ– rembg |
| Step 2 | ä¼˜åŒ–èƒŒæ™¯ | omni-image inpainting (mask=äººç‰©åŒºåŸŸåå‘) |
| Step 3 | åˆæˆ | åç«¯å›¾åƒåˆæˆï¼ˆäººç‰© + æ–°èƒŒæ™¯ï¼‰ |

**æŠ€æœ¯æ–¹æ¡ˆï¼šå…¨ç¨‹ä½¿ç”¨ omni-image API**

æ ¸å¿ƒæ€è·¯ï¼šä¸éœ€è¦ä¸“é—¨çš„æŠ å›¾æœåŠ¡ï¼Œé€šè¿‡ prompt å·¥ç¨‹è®© AI å®Œæˆæ‰€æœ‰æ­¥éª¤ï¼š

| æ­¥éª¤ | Prompt ç¤ºä¾‹ |
|------|------------|
| åˆ†ç¦»äººç‰© | `æå– <<<image_1>>> ä¸­çš„ä¸»ä½“äººç‰©ï¼ŒèƒŒæ™¯è®¾ä¸ºçº¯ç™½` |
| å•ç‹¬ä¼˜åŒ–èƒŒæ™¯ | `ä¿æŒ <<<image_1>>> äººç‰©ä½ç½®å§¿æ€å®Œå…¨ä¸å˜ï¼Œåªå°†èƒŒæ™¯æ”¹ä¸º{ç”¨æˆ·æè¿°}` |
| åˆæˆ | `å°† <<<image_1>>> çš„äººç‰©è‡ªç„¶èåˆåˆ° <<<image_2>>> èƒŒæ™¯ä¸­` |

**åç«¯å®ç°**ï¼š
```python
# ç»Ÿä¸€ä½¿ç”¨ç°æœ‰çš„ omni-image APIï¼Œåªæ˜¯ prompt ä¸åŒ
class MultiStepRefineService:
    async def extract_person(self, image_url: str) -> str:
        """ç”¨ omni-image æå–äººç‰©"""
        result = await kling_client.generate_omni_image({
            "prompt": "æå– <<<image_1>>> ä¸­çš„ä¸»ä½“äººç‰©ï¼ŒèƒŒæ™¯è®¾ä¸ºçº¯ç™½è‰²",
            "image_list": [{"image": image_url}],
            "aspect_ratio": "auto"
        })
        return result["url"]
    
    async def refine_background(self, image_url: str, prompt: str) -> str:
        """ç”¨ omni-image ä¼˜åŒ–èƒŒæ™¯"""
        result = await kling_client.generate_omni_image({
            "prompt": f"ä¿æŒ <<<image_1>>> äººç‰©ä½ç½®å§¿æ€å®Œå…¨ä¸å˜ï¼Œåªå°†èƒŒæ™¯æ”¹ä¸ºï¼š{prompt}",
            "image_list": [{"image": image_url}],
            "aspect_ratio": "auto"
        })
        return result["url"]
    
    async def composite(self, person_url: str, bg_url: str) -> str:
        """ç”¨ omni-image åˆæˆ"""
        result = await kling_client.generate_omni_image({
            "prompt": "å°† <<<image_1>>> çš„äººç‰©è‡ªç„¶èåˆåˆ° <<<image_2>>> èƒŒæ™¯ä¸­ï¼Œä¿æŒäººç‰©åŸå§‹æ¯”ä¾‹å’Œä½ç½®",
            "image_list": [{"image": person_url}, {"image": bg_url}],
            "aspect_ratio": "auto"
        })
        return result["url"]
```

---

### 2.3 åŠŸèƒ½ä¸‰ï¼šé¢„è§ˆå†å² (Preview History)

**ç”¨æˆ·åœºæ™¯**: ç”Ÿæˆäº†å¤šä¸ªç‰ˆæœ¬ï¼Œæƒ³å›é¡¾å¯¹æ¯”ï¼Œé€‰æ‹©æœ€æ»¡æ„çš„

**UI è®¾è®¡**:
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  [ä¸»é¢„è§ˆåŒº - å½“å‰é€‰ä¸­çš„å¤§å›¾]                             â”‚
â”‚                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â”‚              (å¤§å›¾é¢„è§ˆ)                           â”‚  â”‚
â”‚  â”‚                                                   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                         â”‚
â”‚  å†å²ç‰ˆæœ¬ (ç‚¹å‡»åˆ‡æ¢):                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ v1 â”‚ â”‚ v2 â”‚ â”‚âœ“v3 â”‚ â”‚ v4 â”‚ â”‚ v5 â”‚                    â”‚
â”‚  â”‚    â”‚ â”‚    â”‚ â”‚é€‰ä¸­â”‚ â”‚    â”‚ â”‚    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜                    â”‚
â”‚                                                         â”‚
â”‚           [< ä¸Šä¸€ä¸ª]     [ä¸‹ä¸€ä¸ª >]                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ•°æ®ç»“æ„**:
```typescript
interface GenerationVersion {
  id: string;
  taskId: string;
  previewUrl: string;
  prompt: string;
  seed: number;
  createdAt: Date;
  selected: boolean;  // æ˜¯å¦æ˜¯å½“å‰é€‰ä¸­çš„ç‰ˆæœ¬
}

// KeyframeEditor çŠ¶æ€æ‰©å±•
interface EditorState {
  // ... existing
  previewHistory: GenerationVersion[];
  currentVersionIndex: number;
}
```

**å­˜å‚¨æ–¹æ¡ˆ**:
- å‰ç«¯ï¼šå†…å­˜å­˜å‚¨å½“å‰ä¼šè¯çš„å†å²
- åç«¯ï¼šSupabase è¡¨ `generation_history` æŒä¹…åŒ–ï¼ˆå¯é€‰ï¼‰

---

## 3. å®ç°ä¼˜å…ˆçº§

| ä¼˜å…ˆçº§ | åŠŸèƒ½ | å·¥ä½œé‡ | æ”¶ç›Š |
|--------|------|--------|------|
| **P0** | é‡æ–°ç”Ÿæˆ | 0.5 å¤© | æœ€åŸºæœ¬çš„è¿­ä»£èƒ½åŠ› |
| **P0** | é¢„è§ˆå†å² | 1 å¤© | è®©ç”¨æˆ·èƒ½å¯¹æ¯”é€‰æ‹© |
| **P1** | ç»†ç²’åº¦ä¼˜åŒ– | 3-5 å¤© | ä¸“ä¸šçº§æ§åˆ¶ï¼Œä½†éœ€è¦æ›´å¤š API è°ƒç”¨ |

---

## 4. æŠ€æœ¯å®ç°ç»†èŠ‚

### 4.1 Phase 1: é‡æ–°ç”Ÿæˆ + é¢„è§ˆå†å²

**å‰ç«¯æ”¹åŠ¨** - KeyframeEditor.tsx:
```tsx
// 1. æ·»åŠ å†å²çŠ¶æ€
const [previewHistory, setPreviewHistory] = useState<GenerationVersion[]>([]);
const [currentVersionIdx, setCurrentVersionIdx] = useState(-1);

// 2. ç”Ÿæˆåä¿å­˜åˆ°å†å²
const handleGenerate = async () => {
  const result = await onGenerate({...});
  
  const newVersion: GenerationVersion = {
    id: uuid(),
    taskId: result.taskId,
    previewUrl: result.previewUrl,
    prompt: prompt.trim(),
    seed: result.seed || Date.now(),
    createdAt: new Date(),
    selected: true,
  };
  
  setPreviewHistory(prev => [...prev, newVersion]);
  setCurrentVersionIdx(previewHistory.length);
};

// 3. å†å²ç¼©ç•¥å›¾ç»„ä»¶
<PreviewHistoryStrip 
  versions={previewHistory}
  currentIndex={currentVersionIdx}
  onSelect={(idx) => {
    setCurrentVersionIdx(idx);
    setPreviewUrl(previewHistory[idx].previewUrl);
  }}
/>
```

**åç«¯æ”¹åŠ¨** - ai_capability_service.py:
```python
# è¿”å›ç»“æœä¸­åŒ…å« seed
return {
    "preview_url": result_url,
    "task_id": task_id,
    "seed": task.metadata.get("seed"),  # â˜… æ–°å¢
}
```

### 4.2 Phase 2: ç»†ç²’åº¦ä¼˜åŒ–

**æ–°å»ºæœåŠ¡** - `layer_composite_service.py`:
```python
class LayerCompositeService:
    """åˆ†å±‚åˆæˆæœåŠ¡"""
    
    async def extract_person(self, image_url: str) -> dict:
        """æŠ å›¾ - åˆ†ç¦»äººç‰©"""
        # ä½¿ç”¨ rembg æˆ– Kling matting API
        pass
    
    async def inpaint_background(self, image_url: str, mask_url: str, prompt: str) -> dict:
        """èƒŒæ™¯ä¿®å¤/æ›¿æ¢"""
        # ä½¿ç”¨ omni-image inpainting
        pass
    
    async def composite(self, person_url: str, background_url: str) -> dict:
        """åˆæˆå›¾å±‚"""
        # PIL/OpenCV å›¾åƒåˆæˆ
        pass
```

---

## 5. ç”¨æˆ·æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»ã€Œæ¢èƒŒæ™¯ã€
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ KeyframeEditor  â”‚
â”‚ (æ ‡å‡†æ¨¡å¼)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ ç”Ÿæˆ    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ é¢„è§ˆç»“æœ    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                                  â”‚
    â–¼                                  â–¼
[æ»¡æ„] â”€â”€â”€> ç¡®è®¤åº”ç”¨          [ä¸æ»¡æ„]
                                   â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚              â”‚              â”‚
                    â–¼              â–¼              â–¼
              [é‡æ–°ç”Ÿæˆ]    [ç›¸ä¼¼ç”Ÿæˆ]     [ç»†ç²’åº¦ä¼˜åŒ–]
                    â”‚              â”‚              â”‚
                    â–¼              â–¼              â–¼
              æ¢ seed        è°ƒæ•´ prompt   è¿›å…¥åˆ†æ­¥ç¼–è¾‘
              é‡æ–°è°ƒç”¨        æˆ–å‚è€ƒå›¾     æŠ å›¾â†’ä¼˜åŒ–èƒŒæ™¯â†’åˆæˆ
```

---

## 6. API æ¥å£è§„èŒƒ

### 6.1 ç”Ÿæˆæ¥å£æ‰©å±•

```yaml
POST /api/ai-capability/generate
Request:
  clipId: string
  capabilityId: string
  prompt: string
  keyframeUrl: string
  maskDataUrl?: string
  # â˜… æ–°å¢å‚æ•°
  seed?: number           # æŒ‡å®šéšæœºç§å­
  regenerate?: boolean    # é‡æ–°ç”Ÿæˆæ ‡è®°
  referenceUrl?: string   # å‚è€ƒå›¾ URLï¼ˆç›¸ä¼¼ç”Ÿæˆç”¨ï¼‰
  
Response:
  taskId: string
  previewUrl: string
  seed: number            # â˜… è¿”å›ä½¿ç”¨çš„ seed
  generationCount: number # æœ¬ä¼šè¯ç¬¬å‡ æ¬¡ç”Ÿæˆ
```

### 6.2 åˆ†æ­¥ä¼˜åŒ–æ¥å£ï¼ˆPhase 2ï¼‰

```yaml
POST /api/ai-capability/layer/extract
Request:
  imageUrl: string
Response:
  personUrl: string       # æŠ å›¾åçš„äººç‰©
  maskUrl: string         # äººç‰©è’™ç‰ˆ

POST /api/ai-capability/layer/refine-background  
Request:
  imageUrl: string
  maskUrl: string         # äººç‰©åŒºåŸŸè’™ç‰ˆï¼ˆèƒŒæ™¯ä¿®å¤æ—¶åè½¬ï¼‰
  prompt: string
Response:
  backgroundUrl: string

POST /api/ai-capability/layer/composite
Request:
  personUrl: string
  backgroundUrl: string
Response:
  resultUrl: string
```

---

## 7. ä¸‹ä¸€æ­¥

1. **ç¡®è®¤ä¼˜å…ˆçº§**: P0 å…ˆåšï¼Œå¿«é€Ÿè¿­ä»£
2. **æŠ€æœ¯é€‰å‹**: 
   - æŠ å›¾ç”¨ rembgï¼ˆæœ¬åœ°ï¼‰è¿˜æ˜¯ Kling mattingï¼ˆäº‘ç«¯ï¼‰ï¼Ÿ
   - åˆæˆç”¨ PIL è¿˜æ˜¯æ›´ä¸“ä¸šçš„å›¾åƒå¤„ç†åº“ï¼Ÿ
3. **å¼€å§‹å®ç°**:
   - Phase 1: é‡æ–°ç”Ÿæˆ + é¢„è§ˆå†å²ï¼ˆ1.5 å¤©ï¼‰
   - Phase 2: ç»†ç²’åº¦ä¼˜åŒ–ï¼ˆ3-5 å¤©ï¼‰

---

## é™„å½•ï¼šå‚è€ƒä»£ç ä½ç½®

| æ¨¡å— | æ–‡ä»¶è·¯å¾„ |
|------|---------|
| KeyframeEditor | `frontend/src/components/visual-editor/workflow/KeyframeEditor.tsx` |
| AI èƒ½åŠ›æœåŠ¡ | `backend/app/services/ai_capability_service.py` |
| Kling API å®¢æˆ·ç«¯ | `backend/app/services/kling_ai_service.py` |
| Supabase å®¢æˆ·ç«¯ | `backend/app/services/supabase_client.py` |
