# 编辑器视频加载开发规范

> 本文档规范编辑器中视频加载、播放、缓冲相关的开发流程，确保每次代码修改不会影响核心播放体验。

## 一、架构概览

### 1.1 核心组件

```
┌─────────────────────────────────────────────────────────────┐
│                    VideoCanvasStore.tsx                      │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    预热池 (videoPreloadPool)             ││
│  │  - 提前加载视频资源                                       ││
│  │  - Safari 原生 HLS 时跳过预热（不支持隐藏元素加载）        ││
│  │  - 存储 HLS 实例和视频元素引用                            ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    挂载池 (mountedVideos)                ││
│  │  - 当前画布显示的视频                                     ││
│  │  - 处理 clip 切换时的视频复用                             ││
│  └─────────────────────────────────────────────────────────┘│
│  ┌─────────────────────────────────────────────────────────┐│
│  │                    HLS 实例缓存 (hlsInstanceCache)       ││
│  │  - 复用 HLS.js 实例，避免重复创建                         ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
          ↑                    ↑
          │ 主画布使用          │ 弹窗独立创建
          │                    │
    ┌─────┴─────┐        ┌─────┴──────────┐
    │VideoCanvas │        │VideoPreviewPanel│
    │ (主编辑器) │        │  (弹窗预览)      │
    └───────────┘        └────────────────┘
```

### 1.2 关键原则

| 原则 | 说明 |
|------|------|
| **独立实例** | 弹窗（如 SmartCleanupWizard）使用独立视频实例，不复用主画布资源 |
| **Safari 特殊处理** | Safari 原生 HLS 不支持隐藏元素加载，需跳过预热 |
| **资源隔离** | 预热池视频不能被多个组件同时使用，防止冲突 |
| **及时清理** | 组件卸载时必须清理 HLS 实例和视频元素 |

---

## 二、性能规范

### 2.1 HLS 加载配置

```typescript
// 推荐的 HLS.js 配置
const HLS_CONFIG: Partial<HlsConfig> = {
  enableWorker: true,           // 启用 Web Worker
  lowLatencyMode: false,        // 关闭低延迟模式（节省资源）
  backBufferLength: 30,         // 后向缓冲 30 秒
  maxBufferLength: 60,          // 最大缓冲 60 秒
  maxMaxBufferLength: 120,      // 绝对最大缓冲 120 秒
  startLevel: -1,               // 自动选择起始质量
};
```

### 2.2 缓冲策略

```typescript
// 缓冲进度检查阈值
const BUFFER_CHECK_INTERVAL = 500;   // 检查间隔（毫秒）
const MIN_BUFFER_AHEAD = 5;          // 最少前向缓冲（秒）
const SEEK_THRESHOLD = 0.1;          // Seek 阈值（秒）
```

### 2.3 预热策略

```typescript
// ★ Safari 检测 - 跳过预热
const testVideo = document.createElement('video');
const isSafariNativeHls = testVideo.canPlayType('application/vnd.apple.mpegurl') !== '';

if (isSafariNativeHls) {
  // Safari 原生 HLS：不预热，直接让主加载处理
  return false;
}
```

---

## 三、开发规范

### 3.1 新增视频相关功能时

**必须检查项：**

- [ ] 是否需要创建新的视频元素？
- [ ] 是否会与预热池冲突？
- [ ] 是否正确处理 HLS 实例生命周期？
- [ ] 是否支持 Safari 原生 HLS？
- [ ] 组件卸载时是否清理资源？

**禁止事项：**

- ❌ 从预热池"借用"视频元素到其他组件
- ❌ 多个组件共享同一个 HLS 实例
- ❌ 在隐藏元素上加载 Safari 原生 HLS
- ❌ 不清理 HLS 实例直接销毁视频元素

### 3.2 代码模板

#### 创建独立视频实例（推荐用于弹窗）

```typescript
// ✅ 正确：创建独立实例
useEffect(() => {
  const video = document.createElement('video');
  video.playsInline = true;
  video.preload = 'auto';
  
  let hls: Hls | null = null;
  
  if (isHlsUrl && Hls.isSupported()) {
    hls = new Hls(HLS_CONFIG);
    hls.loadSource(videoUrl);
    hls.attachMedia(video);
  } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
    // Safari 原生 HLS
    video.src = videoUrl;
  }
  
  container.appendChild(video);
  
  return () => {
    // ★ 必须清理
    if (hls) {
      hls.destroy();
    }
    if (video.parentNode) {
      video.parentNode.removeChild(video);
    }
  };
}, [videoUrl]);
```

### 3.3 调试日志规范

```typescript
// 调试开关统一管理
const DEBUG_VIDEO_BUFFER = process.env.NODE_ENV === 'development';
const bufferLog = (...args: unknown[]) => { 
  if (DEBUG_VIDEO_BUFFER) console.log('[VideoBuffer]', ...args); 
};

// 日志级别
// [VideoBuffer] - 核心缓冲日志（保留）
// [VideoCanvas] - 画布渲染日志（保留）
// [MediaCache]  - 缓存日志（按需开启）
// [MediaProxy]  - 代理日志（按需开启）
```

---

## 四、测试规范

### 4.1 每次修改必测项

| 测试项 | 测试方法 | 预期结果 |
|--------|----------|----------|
| **首次加载** | 刷新页面，观察视频加载 | 20秒内显示画面，无报错 |
| **Clip 切换** | 点击不同 clip | 无缝切换，无黑屏 |
| **Seek 操作** | 拖动时间线 | 快速响应，<500ms |
| **播放/暂停** | 点击播放按钮 | 即时响应 |
| **弹窗预览** | 打开 SmartCleanupWizard | 主画布不受影响 |
| **Safari 兼容** | 在 Safari 中测试 | 功能正常，无报错 |

### 4.2 自动化检查

```bash
# 构建前检查
pnpm run type-check

# 检查是否有未清理的 HLS 实例
grep -r "new Hls(" --include="*.tsx" | wc -l
# 对比
grep -r "hls.destroy()" --include="*.tsx" | wc -l
# 数量应该相等
```

### 4.3 控制台检查

```javascript
// 检查是否有资源泄露
// 打开 DevTools → Memory → Take heap snapshot
// 搜索 "Hls" 或 "HTMLVideoElement"
// 多次操作后数量不应持续增长
```

---

## 五、问题排查

### 5.1 常见问题

#### 问题 1：Resource load error（视频加载失败）

**可能原因：**
- 预热池视频被其他组件移走
- HLS 分片请求失败
- Safari 隐藏元素加载失败

**排查步骤：**
1. 检查 Network 面板，看哪个请求失败
2. 检查视频元素的 `src` 是否正确
3. 检查是否有组件"借用"了预热池视频

**解决方案：**
```typescript
// 弹窗使用独立视频实例，不复用预热池
const video = document.createElement('video');
// ...独立加载
```

#### 问题 2：视频黑屏但 readyState: 4

**可能原因：**
- 视频元素被隐藏（visibility: hidden）
- 视频尺寸为 0
- 样式未正确重置

**排查步骤：**
1. 检查视频元素的 `style` 属性
2. 检查 `videoWidth` 和 `videoHeight`
3. 检查父容器是否可见

#### 问题 3：Safari 预热失败

**原因：** Safari 不会为隐藏元素加载 HLS 资源

**解决方案：** Safari 跳过预热，直接在主加载时处理

```typescript
if (isSafariNativeHls) {
  bufferLog('⏭️ Safari 原生 HLS：跳过预热');
  return false;
}
```

### 5.2 调试命令

```javascript
// 查看预热池状态
console.log('[Debug] 预热池:', window.__videoPreloadPool);

// 查看挂载的视频
document.querySelectorAll('video').forEach((v, i) => {
  console.log(`[Debug] Video ${i}:`, {
    src: v.src?.slice(-30),
    readyState: v.readyState,
    paused: v.paused,
    visibility: v.style.visibility,
  });
});

// 强制清理缓存
import { clearHlsCache } from './VideoCanvasStore';
clearHlsCache();
```

---

## 六、代码审查清单

### PR 必须包含以下确认：

```markdown
## 视频加载影响检查

- [ ] 本次修改涉及视频加载/播放/缓冲吗？
  - 如果是，请完成以下测试：
    - [ ] 首次加载测试通过
    - [ ] Clip 切换测试通过
    - [ ] Safari 兼容性测试通过
    - [ ] 弹窗预览测试通过
    - [ ] 无控制台报错
- [ ] 新增的视频元素/HLS 实例有对应的清理逻辑吗？
- [ ] 是否遵循"独立实例"原则？
```

---

## 七、经验总结

### 7.1 2026-01-16 VideoPreviewPanel 冲突修复

**问题描述：**
VideoPreviewPanel 复用预热池视频时，会把主画布正在使用的视频元素移走，导致：
- 主画布视频消失
- Safari 检测到视频被移除后尝试重新加载
- 产生 `Resource load error`

**错误日志：**
```
[Global] Resource load error: <video ... class="w-full h-full object-cover" src="...playlist.m3u8">
```

**根本原因：**
- 预热池中的视频可能同时被主画布使用
- VideoPreviewPanel 直接从预热池"借用"视频会导致冲突

**解决方案：**
- VideoPreviewPanel 创建**独立的视频实例**
- 不再复用预热池，避免与主画布冲突
- 每个 clip 不大，独立加载开销可接受

**代码修改：**
```typescript
// ❌ 之前：复用预热池
const preheated = getPreheatedVideo(assetId);
if (preheated) {
  // 借用视频元素...
}

// ✅ 之后：创建独立实例
const video = document.createElement('video');
// 独立加载 HLS...
```

**教训：**
1. 视频资源不能被多个组件共享
2. 弹窗组件应使用独立资源
3. Safari 对视频元素的移动很敏感

---

## 八、版本历史

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-01-16 | 1.0.0 | 初版，包含 VideoPreviewPanel 冲突修复经验 |

---

**维护者**: HoppingRabbit AI Team  
**最后更新**: 2026年1月16日
