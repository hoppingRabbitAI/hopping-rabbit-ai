# HoppingRabbit AI å‰åç«¯äº¤äº’è§„èŒƒ

> ç‰ˆæœ¬: 1.0.0  
> æœ€åæ›´æ–°: 2026-01-16  
> ç»´æŠ¤è€…: @hexiangyang
> ä¸¥é‡ç¨‹åº¦: ğŸ”´ æœ¬æ–‡æ¡£æ‰€æœ‰è§„èŒƒå‡ä¸ºé«˜ä¼˜å…ˆçº§ï¼Œè¿åå°†å¯¼è‡´æ•°æ®é”™è¯¯æˆ–åŠŸèƒ½å¼‚å¸¸

---

## ğŸ“Œ æ ¸å¿ƒåŸåˆ™

**æœ¬è§„èŒƒè§£å†³çš„æ˜¯å‰åç«¯äº¤äº’ä¸­æœ€å®¹æ˜“å‡ºé”™çš„é—®é¢˜**ï¼ŒåŒ…æ‹¬ï¼š
- æ—¶é—´å•ä½ä¸ä¸€è‡´ï¼ˆæ¯«ç§’ vs ç§’ï¼‰
- å­—æ®µå‘½åä¸ä¸€è‡´ï¼ˆsnake_case vs camelCaseï¼‰
- å…³é”®å¸§æ•°æ®æ ¼å¼ä¸ä¸€è‡´
- è§†é¢‘åŠ è½½/ç¼“å†²é—®é¢˜
- æ•°æ®ç±»å‹ä¸åŒ¹é…

**æ¯æ¬¡æ–°å¢ API æˆ–ä¿®æ”¹æ•°æ®ç»“æ„ï¼Œå¿…é¡»å‚ç…§æœ¬è§„èŒƒè¿›è¡Œå®¡æŸ¥ï¼**

---

## ä¸€ã€æ—¶é—´å•ä½è§„èŒƒ â±ï¸

### 1.1 ç»Ÿä¸€æ ‡å‡†

| å±‚çº§ | æ—¶é—´å•ä½ | è¯´æ˜ |
|------|----------|------|
| **æ•°æ®åº“** | **æ¯«ç§’ (ms)** | `start_time`, `end_time`, `duration` å…¨éƒ¨ä¸ºæ¯«ç§’æ•´æ•° |
| **åç«¯ API è¿”å›** | **æ¯«ç§’ (ms)** | ä¿æŒä¸æ•°æ®åº“ä¸€è‡´ |
| **å‰ç«¯ Store** | **æ¯«ç§’ (ms)** | `clip.start`, `clip.duration` ç­‰å…¨éƒ¨ä¸ºæ¯«ç§’ |
| **å‰ç«¯æ˜¾ç¤º** | æ ¼å¼åŒ–å­—ç¬¦ä¸² | ä½¿ç”¨ `formatTime()` è½¬æ¢ä¸º `00:00.00` |
| **å…³é”®å¸§ offset** | **å½’ä¸€åŒ– 0-1** | ç›¸å¯¹äº clip æ—¶é•¿çš„æ¯”ä¾‹ |
| **è§†é¢‘ currentTime** | **ç§’ (s)** | HTML5 Video API ä½¿ç”¨ç§’ |

### 1.2 è½¬æ¢è§„èŒƒ

```typescript
// âœ… æ­£ç¡®ï¼šæ¯«ç§’è½¬ç§’ï¼ˆç”¨äºè§†é¢‘æ’­æ”¾ï¼‰
const videoTimeSec = timelineTimeMs / 1000;
video.currentTime = videoTimeSec;

// âœ… æ­£ç¡®ï¼šç§’è½¬æ¯«ç§’ï¼ˆç”¨äºå­˜å‚¨å’ŒçŠ¶æ€ï¼‰
const timelineTimeMs = video.currentTime * 1000;
setCurrentTime(timelineTimeMs);

// âœ… æ­£ç¡®ï¼šå…³é”®å¸§ offset è®¡ç®—
const offset = (currentTimeMs - clip.start) / clip.duration; // 0-1

// âŒ é”™è¯¯ï¼šæ··ç”¨å•ä½
video.currentTime = currentTimeMs; // æŠŠæ¯«ç§’å½“ç§’ç”¨ï¼
const offset = currentTimeMs / clip.duration; // å¿˜è®°å‡å» clip.startï¼
```

### 1.3 å¸¸è§é™·é˜±

| åœºæ™¯ | é”™è¯¯åšæ³• | æ­£ç¡®åšæ³• |
|------|----------|----------|
| ASR è½¬å†™ç»“æœ | ç›´æ¥å­˜å‚¨ï¼ˆå¯èƒ½æ˜¯ç§’ï¼‰ | ç¡®è®¤å•ä½åç»Ÿä¸€è½¬ä¸ºæ¯«ç§’ |
| LLM åˆ†æç»“æœ | å‡è®¾æ˜¯æ¯«ç§’ | LLM è¾“å‡ºæ˜¯ç§’ï¼Œéœ€è¦ `* 1000` |
| FFmpeg æ—¶é—´æˆ³ | ç›´æ¥ä½¿ç”¨ | FFmpeg ä½¿ç”¨ç§’ï¼Œéœ€è¦è½¬æ¢ |
| sourceStart | ä¸ start æ··æ·† | sourceStart æ˜¯åª’ä½“å†…æ—¶é—´ï¼Œstart æ˜¯æ—¶é—´çº¿ä½ç½® |

### 1.4 æ—¶é—´ç›¸å…³å­—æ®µå¯¹ç…§è¡¨

| å­—æ®µå | å«ä¹‰ | å•ä½ | ç¤ºä¾‹ |
|--------|------|------|------|
| `clip.start` | æ—¶é—´çº¿ä¸Šçš„èµ·å§‹ä½ç½® | æ¯«ç§’ | `0`, `5000` |
| `clip.duration` | clip åœ¨æ—¶é—´çº¿ä¸Šçš„æ—¶é•¿ | æ¯«ç§’ | `3000` |
| `clip.sourceStart` | åª’ä½“æºæ–‡ä»¶å†…çš„èµ·å§‹ä½ç½® | æ¯«ç§’ | `10000` (ä»ç¬¬10ç§’å¼€å§‹æˆªå–) |
| `clip.originDuration` | åª’ä½“æºæ–‡ä»¶çš„åŸå§‹æ€»æ—¶é•¿ | æ¯«ç§’ | `60000` (1åˆ†é’Ÿè§†é¢‘) |
| `keyframe.offset` | å…³é”®å¸§åœ¨ clip å†…çš„ç›¸å¯¹ä½ç½® | 0-1 | `0.5` (clip ä¸­é—´) |
| `keyframe.time` (åç«¯) | å…³é”®å¸§æ—¶é—´ï¼ˆåç«¯å­˜å‚¨ï¼‰ | æ¯«ç§’ | `1500` |
| `video.currentTime` | HTML5 Video API | ç§’ | `1.5` |

---

## äºŒã€å­—æ®µå‘½åè§„èŒƒ ğŸ“

### 2.1 å‘½åçº¦å®š

| å±‚çº§ | å‘½åé£æ ¼ | ç¤ºä¾‹ |
|------|----------|------|
| **æ•°æ®åº“** | snake_case | `start_time`, `source_start`, `is_muted` |
| **åç«¯ Python** | snake_case | `start_time`, `source_start`, `is_muted` |
| **åç«¯ API å“åº”** | snake_case | `{ "start_time": 0, "source_start": 0 }` |
| **å‰ç«¯ TypeScript** | camelCase | `startTime`, `sourceStart`, `isMuted` |

### 2.2 å­—æ®µæ˜ å°„è¡¨

```typescript
// editor-store.ts ä¸­çš„æ˜ å°„å…³ç³»
const FIELD_MAPPING = {
  // å‰ç«¯ camelCase -> åç«¯ snake_case
  startTime: 'start_time',
  endTime: 'end_time',
  sourceStart: 'source_start',
  sourceEnd: 'source_end',
  originDuration: 'origin_duration',
  clipType: 'clip_type',
  trackId: 'track_id',
  assetId: 'asset_id',
  isMuted: 'is_muted',
  isLocked: 'is_locked',
  isVisible: 'is_visible',
  mediaUrl: 'url',
  fadeIn: 'transition_in',
  fadeOut: 'transition_out',
};
```

### 2.3 æ•°æ®åŠ è½½æ—¶çš„è½¬æ¢

```typescript
// âœ… æ­£ç¡®ï¼šä»åç«¯åŠ è½½æ•°æ®æ—¶è½¬æ¢
const clips = rawClips.map((c: Record<string, unknown>) => ({
  id: c.id as string,
  start: (c.start_time ?? 0) as number,        // snake_case â†’ camelCase
  duration: (c.duration ?? 0) as number,
  sourceStart: (c.source_start ?? 0) as number,
  clipType: (c.clip_type ?? 'video') as ClipType,
  isMuted: (c.is_muted ?? false) as boolean,
}));

// âœ… æ­£ç¡®ï¼šä¿å­˜åˆ°åç«¯æ—¶è½¬æ¢
const saveData = {
  start_time: clip.start,        // camelCase â†’ snake_case
  source_start: clip.sourceStart,
  clip_type: clip.clipType,
  is_muted: clip.isMuted,
};
```

### 2.4 å¸¸è§å­—æ®µå¯¹ç…§

| å‰ç«¯ (camelCase) | åç«¯ (snake_case) | å«ä¹‰ |
|------------------|-------------------|------|
| `startTime` / `start` | `start_time` | æ—¶é—´çº¿èµ·å§‹ä½ç½® |
| `endTime` | `end_time` | æ—¶é—´çº¿ç»“æŸä½ç½® |
| `sourceStart` | `source_start` | åª’ä½“æºèµ·å§‹ä½ç½® |
| `sourceEnd` | `source_end` | åª’ä½“æºç»“æŸä½ç½® |
| `originDuration` | `origin_duration` | åŸå§‹åª’ä½“æ—¶é•¿ |
| `clipType` | `clip_type` | clip ç±»å‹ |
| `trackId` | `track_id` | è½¨é“ ID |
| `assetId` | `asset_id` | ç´ æ ID |
| `isMuted` | `is_muted` | æ˜¯å¦é™éŸ³ |
| `mediaUrl` | `url` / `cached_url` | åª’ä½“ URL |

---

## ä¸‰ã€å…³é”®å¸§è§„èŒƒ ğŸ¬

### 3.1 å…³é”®å¸§æ•°æ®æ ¼å¼

#### åç«¯å­˜å‚¨æ ¼å¼ï¼ˆæ•°æ®åº“ï¼‰

```python
# keyframes è¡¨
{
    "id": "uuid",
    "clip_id": "uuid",
    "property": "scale",          # å±æ€§å
    "time": 0,                    # æ¯«ç§’ï¼Œç›¸å¯¹äº clip èµ·ç‚¹
    "value": {"x": 1.2, "y": 1.2}, # å¤åˆå€¼æˆ–ç®€å•å€¼
    "easing": "ease_in_out"
}
```

#### åç«¯ API è¿”å›æ ¼å¼

```python
# GET /projects/{id} è¿”å›çš„ keyframes
{
    "id": "uuid",
    "clipId": "uuid",             # æ³¨æ„ï¼šcamelCase
    "property": "scale",
    "offset": 0.5,                # å½’ä¸€åŒ– 0-1ï¼ˆtime/1000 è½¬æ¢ï¼‰
    "value": {"x": 1.2, "y": 1.2},
    "easing": "ease_in_out"
}
```

#### å‰ç«¯å­˜å‚¨æ ¼å¼

```typescript
// Map<clipId, Map<property, Keyframe[]>>
interface Keyframe {
  id: string;
  clipId: string;
  property: KeyframeProperty;  // 'scale' | 'position' | 'rotation' | 'opacity'
  offset: number;              // å½’ä¸€åŒ– 0-1
  value: CompoundValue | number; // { x, y } æˆ–ç®€å•æ•°å€¼
  easing: EasingType;
}

// å¤åˆå±æ€§å€¼
type CompoundValue = { x: number; y: number };
```

### 3.2 å±æ€§ç±»å‹è§„èŒƒ

| å±æ€§ | ç±»å‹ | value æ ¼å¼ | ç¤ºä¾‹ |
|------|------|------------|------|
| `scale` | å¤åˆ | `{ x: number, y: number }` | `{ x: 1.2, y: 1.2 }` |
| `position` | å¤åˆ | `{ x: number, y: number }` | `{ x: 0.1, y: -0.05 }` |
| `rotation` | ç®€å• | `number` (è§’åº¦) | `15` |
| `opacity` | ç®€å• | `number` (0-1) | `0.8` |

### 3.3 åç«¯ç”Ÿæˆå…³é”®å¸§

```python
# âœ… æ­£ç¡®ï¼štransform_rules.py ç”Ÿæˆå…³é”®å¸§ï¼ˆç»Ÿä¸€ä½¿ç”¨å¤åˆæ ¼å¼ï¼‰

# scale å…³é”®å¸§ - å¿…é¡»ä½¿ç”¨ {x, y} æ ¼å¼
keyframes.append({
    "id": str(uuid4()),
    "clip_id": clip_id,
    "property": "scale",
    "offset": 0,                  # å½’ä¸€åŒ– 0-1
    "value": {"x": 1.0, "y": 1.0},  # å¤åˆå€¼
    "easing": "ease_in_out",
})

# position å…³é”®å¸§ - å¿…é¡»ä½¿ç”¨ {x, y} æ ¼å¼
keyframes.append({
    "id": str(uuid4()),
    "clip_id": clip_id,
    "property": "position",
    "offset": 1,
    "value": {"x": 0.1, "y": -0.05},  # å¤åˆå€¼
    "easing": "linear",
})

# rotation/opacity å…³é”®å¸§ - ä½¿ç”¨ç®€å•æ•°å€¼
keyframes.append({
    "id": str(uuid4()),
    "clip_id": clip_id,
    "property": "rotation",
    "offset": 0.5,
    "value": 15,                  # ç®€å•æ•°å€¼ï¼ˆè§’åº¦ï¼‰
    "easing": "linear",
})
```

### 3.4 å‰ç«¯åŠ è½½å…³é”®å¸§

```typescript
// âœ… æ­£ç¡®ï¼šä»åç«¯åŠ è½½å…³é”®å¸§
const rawKeyframes = project.keyframes || [];
const keyframesMap: Map<string, Map<string, Keyframe[]>> = new Map();

for (const kf of rawKeyframes) {
  // åç«¯è¿”å›çš„ offset å·²ç»æ˜¯å½’ä¸€åŒ–çš„ (time / 1000)
  // éœ€è¦å†æ¬¡è½¬æ¢ï¼štime(ms) -> offset(ç›¸å¯¹clipæ—¶é•¿)
  const clipDuration = clips.find(c => c.id === kf.clipId)?.duration || 1;
  const offset = (kf.time || 0) / clipDuration; // æˆ–ç›´æ¥ç”¨ kf.offset
  
  keyframesMap.get(kf.clipId)?.get(kf.property)?.push({
    id: kf.id,
    clipId: kf.clipId,
    property: kf.property,
    offset: offset,
    value: kf.value,
    easing: kf.easing || 'linear',
  });
}
```

### 3.5 å…³é”®å¸§ç±»å‹è§„èŒƒ

| å±æ€§ | value ç±»å‹ | æ ¼å¼ | è¯´æ˜ |
|------|-----------|------|------|
| `scale` | å¤åˆå¯¹è±¡ | `{ x: number, y: number }` | x/y ç¼©æ”¾æ¯”ä¾‹ï¼Œ1.0 = 100% |
| `position` | å¤åˆå¯¹è±¡ | `{ x: number, y: number }` | å½’ä¸€åŒ–åç§»é‡ï¼Œ0 = ä¸­å¿ƒ |
| `rotation` | ç®€å•æ•°å€¼ | `number` | æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰ |
| `opacity` | ç®€å•æ•°å€¼ | `number` | ä¸é€æ˜åº¦ 0-1 |
| `volume` | ç®€å•æ•°å€¼ | `number` | éŸ³é‡ 0-2 |
| `pan` | ç®€å•æ•°å€¼ | `number` | å£°é“å¹³è¡¡ -1 åˆ° 1 |

**âš ï¸ é‡è¦**ï¼š`scale` å’Œ `position` å¿…é¡»ä½¿ç”¨ `{x, y}` å¤åˆå¯¹è±¡æ ¼å¼ï¼Œä¸æ”¯æŒç®€å•æ•°å€¼ã€‚

### 3.5 æ•°å€¼ç²¾åº¦è§„èŒƒ

ä¸ºç¡®ä¿ç¼©æ”¾å’Œä½ç½®åŠ¨ç”»æµç•…ç»Ÿä¸€ï¼Œå‰åç«¯ä½¿ç”¨ç›¸åŒçš„ç²¾åº¦æ ‡å‡†ï¼š

| è§„èŒƒ | å€¼ | è¯´æ˜ |
|------|-----|------|
| **ç»Ÿä¸€ç²¾åº¦** | 4ä½å°æ•° | å¦‚ `1.0001`, `0.1234` |
| **UI æ­¥é•¿** | 0.1 | ç¼©æ”¾ 0.1%ï¼Œä½ç½® 0.1px |
| **UI æ˜¾ç¤º** | 1ä½å°æ•° | `125.5%`, `10.3px` |

```python
# âœ… åç«¯ï¼šä½¿ç”¨ round_precision() ç¡®ä¿ç²¾åº¦
PRECISION = 4
def round_precision(value: float) -> float:
    return round(value, PRECISION)

scale_value = round_precision(1.12345)  # â†’ 1.1235
```

```typescript
// âœ… å‰ç«¯ï¼šæ’å€¼æ—¶å››èˆäº”å…¥åˆ°ç»Ÿä¸€ç²¾åº¦
const PRECISION_FACTOR = 10000;  // 4ä½å°æ•°
function roundToPrecision(value: number): number {
  return Math.round(value * PRECISION_FACTOR) / PRECISION_FACTOR;
}
```

---

## å››ã€è§†é¢‘åŠ è½½ä¸ç¼“å†²è§„èŒƒ ğŸ“¹

### 4.1 åŠ è½½äº‹ä»¶é€‰æ‹©

| äº‹ä»¶ | readyState | å«ä¹‰ | ä½¿ç”¨åœºæ™¯ |
|------|------------|------|----------|
| `loadedmetadata` | 1 | å…ƒæ•°æ®å·²åŠ è½½ | è·å–æ—¶é•¿ã€åˆ†è¾¨ç‡ |
| `canplay` | 3 | å¯ä»¥å¼€å§‹æ’­æ”¾ | âœ… **é»˜è®¤ä½¿ç”¨** |
| `canplaythrough` | 4 | å¯ä»¥ä¸å¡é¡¿æ’­æ”¾å®Œ | âŒ **é¿å…ä½¿ç”¨** |

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ canplay
video.addEventListener('canplay', () => {
  setIsVideoReady(true);
  resolve(video);
});

// âŒ é”™è¯¯ï¼šä½¿ç”¨ canplaythroughï¼ˆ20ç§’è§†é¢‘å¯èƒ½ç­‰65ç§’ï¼‰
video.addEventListener('canplaythrough', () => {
  resolve(video);
});
```

### 4.2 HLS æµåŠ è½½

```typescript
// âœ… æ­£ç¡®ï¼šHLS åŠ è½½æµç¨‹
import Hls from 'hls.js';

if (Hls.isSupported()) {
  const hls = new Hls({
    maxBufferLength: 30,
    maxMaxBufferLength: 60,
  });
  hls.loadSource(hlsUrl);
  hls.attachMedia(video);
  
  hls.on(Hls.Events.MANIFEST_PARSED, () => {
    setIsVideoReady(true);
  });
  
  hls.on(Hls.Events.ERROR, (_, data) => {
    if (data.fatal) {
      handleFatalError(data);
    }
  });
}
```

### 4.3 è§†é¢‘é¢„çƒ­ï¼ˆPreheatï¼‰

```typescript
// âœ… æ­£ç¡®ï¼šé¢„çƒ­æ‰€æœ‰é¡¹ç›®è§†é¢‘
export async function preheatAllVideos(assetIds: string[]): Promise<void> {
  const uniqueIds = Array.from(new Set(assetIds))
    .filter(id => id && !videoPreloadPool.has(id));
  
  await Promise.all(uniqueIds.map(id => preheatVideo(id)));
}

// âœ… æ­£ç¡®ï¼šå•ä¸ªè§†é¢‘é¢„çƒ­
export async function preheatVideo(assetId: string): Promise<void> {
  if (videoPreloadPool.has(assetId) || preloadingAssets.has(assetId)) {
    return;
  }
  
  preloadingAssets.add(assetId);
  
  try {
    const video = document.createElement('video');
    video.preload = 'auto';
    video.muted = true;
    // éšè—åœ¨ body ä¸­é¢„åŠ è½½
    video.style.position = 'absolute';
    video.style.visibility = 'hidden';
    document.body.appendChild(video);
    
    // ç­‰å¾… canplay
    await new Promise((resolve, reject) => {
      video.oncanplay = resolve;
      video.onerror = reject;
      video.src = getAssetStreamUrl(assetId);
    });
    
    videoPreloadPool.set(assetId, { videoElement: video, hlsInstance: null, isReady: true });
  } finally {
    preloadingAssets.delete(assetId);
  }
}
```

### 4.4 ç¼“å†²é—®é¢˜æ’æŸ¥æ¸…å•

| ç—‡çŠ¶ | å¯èƒ½åŸå›  | æ’æŸ¥æ–¹æ³• |
|------|----------|----------|
| è§†é¢‘é»‘å± | visibility è®¾ç½®é—®é¢˜ | æ£€æŸ¥ video.style.visibility |
| åªæœ‰å£°éŸ³æ²¡ç”»é¢ | video å…ƒç´ æœªæŒ‚è½½ | æ£€æŸ¥ container.appendChild |
| åˆ‡æ¢ clip å¡é¡¿ | æœªé¢„çƒ­ | æ£€æŸ¥ preheatAllVideos è°ƒç”¨ |
| seek åä¸åŒæ­¥ | éŸ³è§†é¢‘æœªç»Ÿä¸€ seek | ä½¿ç”¨ syncAudioClips() |
| HLS åŠ è½½å¤±è´¥ | è·¨åŸŸæˆ– URL é”™è¯¯ | æ£€æŸ¥ CORS å’Œ URL æ ¼å¼ |

---

## äº”ã€API è¯·æ±‚è§„èŒƒ ğŸŒ

### 5.1 è¯·æ±‚æ ¼å¼

```typescript
// âœ… æ­£ç¡®ï¼šä½¿ç”¨ç»Ÿä¸€çš„ API å®¢æˆ·ç«¯
import { apiClient } from '@/lib/api/client';

const response = await apiClient.post('/projects/{id}/state', {
  body: JSON.stringify({
    operations: [...],
    version: currentVersion,
  }),
});
```

### 5.2 é”™è¯¯å¤„ç†

```typescript
// âœ… æ­£ç¡®ï¼šç»Ÿä¸€é”™è¯¯å¤„ç†
try {
  const response = await projectApi.updateProject(id, data);
  if (response.error) {
    throw new Error(response.error.message);
  }
  return response.data;
} catch (error) {
  // åŒºåˆ†ç½‘ç»œé”™è¯¯å’Œä¸šåŠ¡é”™è¯¯
  if (error instanceof NetworkError) {
    // ç¦»çº¿æ¨¡å¼
    saveToLocalStorage(data);
  } else {
    // æ˜¾ç¤ºé”™è¯¯æç¤º
    showToast.error(error.message);
  }
}
```

### 5.3 ç‰ˆæœ¬å†²çªå¤„ç†

```typescript
// âœ… æ­£ç¡®ï¼šå¤„ç†ç‰ˆæœ¬å†²çª
const response = await projectApi.saveState(projectId, {
  version: currentVersion,
  operations: [...],
});

if (response.data?.conflict) {
  // æœåŠ¡ç«¯ç‰ˆæœ¬æ›´æ–°ï¼Œéœ€è¦åˆå¹¶
  const merged = mergeChanges(localState, serverState);
  set({ ...merged, version: response.data.newVersion });
}
```

---

## å…­ã€æ•°æ®å®Œæ•´æ€§è§„èŒƒ ğŸ”’

### 6.1 å¿…å¡«å­—æ®µæ£€æŸ¥

```typescript
// âœ… æ­£ç¡®ï¼šåˆ›å»º clip æ—¶æ£€æŸ¥å¿…å¡«å­—æ®µ
function validateClip(clip: Partial<Clip>): clip is Clip {
  const required = ['id', 'trackId', 'start', 'duration', 'clipType'];
  return required.every(field => clip[field] !== undefined);
}
```

### 6.2 é»˜è®¤å€¼è§„èŒƒ

| å­—æ®µ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `clip.sourceStart` | `0` | ä»åª’ä½“å¼€å¤´å¼€å§‹ |
| `clip.volume` | `1.0` | æ­£å¸¸éŸ³é‡ |
| `clip.speed` | `1.0` | æ­£å¸¸é€Ÿåº¦ |
| `clip.isMuted` | `false` | ä¸é™éŸ³ |
| `keyframe.easing` | `'linear'` | çº¿æ€§æ’å€¼ |
| `track.isVisible` | `true` | å¯è§ |
| `track.isLocked` | `false` | æœªé”å®š |

### 6.3 æ•°æ®è¿ç§»

```typescript
// âœ… æ­£ç¡®ï¼šæ—§æ•°æ®è¿ç§»
function migrateLegacyKeyframes(
  keyframes: Map<string, Map<string, Keyframe[]>>
): Map<string, Map<string, Keyframe[]>> {
  const migrated = new Map();
  
  for (const [clipId, propMap] of keyframes) {
    const newPropMap = new Map();
    
    // åˆå¹¶ scaleX + scaleY -> scale
    const scaleX = propMap.get('scaleX');
    const scaleY = propMap.get('scaleY');
    if (scaleX && scaleY) {
      const merged = mergeXYToCompound(scaleX, scaleY, 'scale');
      newPropMap.set('scale', merged);
    }
    
    // å¤åˆ¶å…¶ä»–å±æ€§
    for (const [prop, kfs] of propMap) {
      if (!['scaleX', 'scaleY'].includes(prop)) {
        newPropMap.set(prop, kfs);
      }
    }
    
    migrated.set(clipId, newPropMap);
  }
  
  return migrated;
}
```

---

## ä¸ƒã€å®¡æŸ¥æ¸…å• âœ…

æ¯æ¬¡æäº¤æ¶‰åŠå‰åç«¯äº¤äº’çš„ä»£ç ï¼Œå¿…é¡»æ£€æŸ¥ï¼š

### 7.1 æ—¶é—´å•ä½æ£€æŸ¥

- [ ] æ•°æ®åº“å­˜å‚¨ä½¿ç”¨æ¯«ç§’
- [ ] API è¿”å›ä½¿ç”¨æ¯«ç§’
- [ ] å‰ç«¯ Store ä½¿ç”¨æ¯«ç§’
- [ ] è§†é¢‘æ’­æ”¾ä½¿ç”¨ç§’ï¼ˆæ­£ç¡®è½¬æ¢ï¼‰
- [ ] å…³é”®å¸§ offset ä½¿ç”¨å½’ä¸€åŒ– 0-1

### 7.2 å­—æ®µå‘½åæ£€æŸ¥

- [ ] åç«¯ä½¿ç”¨ snake_case
- [ ] å‰ç«¯ä½¿ç”¨ camelCase
- [ ] æ•°æ®åŠ è½½æ—¶æ­£ç¡®è½¬æ¢
- [ ] æ•°æ®ä¿å­˜æ—¶æ­£ç¡®è½¬æ¢

### 7.3 å…³é”®å¸§æ£€æŸ¥

- [ ] å¤åˆå±æ€§ä½¿ç”¨ `{ x, y }` æ ¼å¼
- [ ] offset æ­£ç¡®è®¡ç®—
- [ ] æ”¯æŒæ—§æ ¼å¼è¿ç§»

### 7.4 è§†é¢‘åŠ è½½æ£€æŸ¥

- [ ] ä½¿ç”¨ canplay è€Œé canplaythrough
- [ ] å®ç°é¢„çƒ­æœºåˆ¶
- [ ] HLS é”™è¯¯å¤„ç†å®Œå–„
- [ ] åˆ‡æ¢é¡¹ç›®æ—¶æ¸…ç†ç¼“å­˜

### 7.5 é”™è¯¯å¤„ç†æ£€æŸ¥

- [ ] ç½‘ç»œé”™è¯¯æœ‰ç¦»çº¿æ”¯æŒ
- [ ] ä¸šåŠ¡é”™è¯¯æœ‰ç”¨æˆ·æç¤º
- [ ] ç‰ˆæœ¬å†²çªæœ‰åˆå¹¶ç­–ç•¥

---

## å…«ã€é—®é¢˜å¤ç›˜è®°å½• ğŸ“‹

### 2026-01-16 è¿‘æœŸé—®é¢˜æ±‡æ€»

| é—®é¢˜ | æ ¹å›  | è§£å†³æ–¹æ¡ˆ | å½±å“èŒƒå›´ |
|------|------|----------|----------|
| ç¬¬ä¸€ä¸ª clip åªæœ‰å£°éŸ³æ²¡ç”»é¢ | è§†é¢‘å…ƒç´ æœªæ­£ç¡®æŒ‚è½½åˆ° DOM | æ£€æŸ¥ container.appendChild é€»è¾‘ | VideoCanvasStore.tsx |
| å…³é”®å¸§ä¸ç”Ÿæ•ˆ | offset è®¡ç®—æœªé™¤ä»¥ clip.duration | ä¿®æ­£å…³é”®å¸§åŠ è½½é€»è¾‘ | editor-store.ts |
| å¼¹çª—å¼•å¯¼çŠ¶æ€åˆ·æ–°ä¸¢å¤± | ä½¿ç”¨ localStorage è€Œéæ•°æ®åº“ | æ·»åŠ  wizard_completed åˆ° projects è¡¨ | projects.py, editor-store.ts |
| æ·¡å…¥æ·¡å‡ºæŒ‰é’®ä½ç½®é”™è¯¯ | æŒ‰é’®å±…ä¸­è€Œéé¡¶éƒ¨ | ä¿®æ”¹ CSS å®šä½ | Timeline.tsx |
| LLM åˆ†æç»“æœæ—¶é—´é”™è¯¯ | LLM è¾“å‡ºç§’è¢«å½“æ¯«ç§’å¤„ç† | æ·»åŠ  `* 1000` è½¬æ¢ | smart_analyzer.py |
| sourceStart ä¸º 0 å¯¼è‡´æ’­æ”¾é”™è¯¯ | æœªæ­£ç¡®è®¾ç½®åª’ä½“æºèµ·å§‹ä½ç½® | ç¡®ä¿ä» segment æ­£ç¡®è¯»å–æ—¶é—´ | smart.py |

### ç»éªŒæ•™è®­

1. **æ—¶é—´å•ä½å¿…é¡»åœ¨ä»£ç æ³¨é‡Šä¸­æ˜ç¡®æ ‡æ³¨**
2. **å­—æ®µæ˜ å°„å¿…é¡»æœ‰ç»Ÿä¸€çš„è½¬æ¢å±‚**
3. **å…³é”®å¸§ç³»ç»Ÿå¿…é¡»æ”¯æŒæ—§æ ¼å¼è¿ç§»**
4. **è§†é¢‘åŠ è½½å¿…é¡»æœ‰é¢„çƒ­å’Œç¼“å­˜æœºåˆ¶**
5. **ç”¨æˆ·çŠ¶æ€ä¼˜å…ˆå­˜å‚¨åœ¨æ•°æ®åº“è€Œé localStorage**

---

*æœ€åæ›´æ–°: 2026-01-16*
