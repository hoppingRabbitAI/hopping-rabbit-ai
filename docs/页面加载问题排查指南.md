# 页面加载问题排查指南

## 问题描述
页面卡在"验证登录状态..."或"加载资源中..."，无法正常加载。可能出现 `Uncaught SyntaxError: Invalid or unexpected token` 错误。

## 已实现的兜底机制

### 1. 全局错误捕获 (layout.tsx)
- **资源加载错误检测**：自动检测脚本、样式等资源加载失败
- **语法错误检测**：捕获 SyntaxError 并提供清除缓存选项
- **页面加载超时**：20秒超时检测，自动显示错误提示
- **友好的错误界面**：提供"刷新页面"和"清除缓存"按钮

### 2. 认证守卫超时机制 (AuthGuard.tsx)
- **Hydration 超时**：5秒后强制继续，避免永久卡住
- **Session 检查超时**：10秒后显示错误提示
- **网络错误处理**：捕获网络请求失败并显示友好提示
- **清除缓存选项**：提供一键清除本地存储和缓存

### 3. 加载组件兜底 (RabbitLoader.tsx)
- **图片加载失败兜底**：如果 gif 加载失败，使用 CSS 动画替代
- **防止白屏**：确保始终有视觉反馈

### 4. 开发环境错误追踪 (DevErrorTracker.tsx)
- **错误计数**：自动统计页面错误数量
- **慢请求监控**：检测超过 5 秒的网络请求
- **自动提示**：错误过多时提示用户清除缓存

### 5. Service Worker (可选，生产环境)
- **资源缓存**：缓存关键资源，提升加载速度
- **离线支持**：网络断开时仍能加载基本页面
- **错误恢复**：网络错误时返回友好的错误信息

## 用户操作指南

### 如果页面卡住不动：
1. **等待 10-20 秒**：系统会自动检测超时并显示错误提示
2. **点击"刷新页面"**：尝试重新加载
3. **点击"清除缓存并刷新"**：清除所有本地数据后重载

### 如果反复出现错误：
1. 打开浏览器开发者工具（F12）
2. 查看 Console 标签页的错误信息
3. 查看 Network 标签页，检查哪些资源加载失败
4. 截图错误信息，联系技术支持

## 开发者调试步骤

### 1. 检查浏览器控制台
```bash
# 打开浏览器开发者工具
按 F12 或 Cmd+Option+I (Mac)

# 查找以下错误类型：
- SyntaxError: Invalid or unexpected token
- Failed to load resource
- CORS errors
- Network errors
```

### 2. 检查 Network 面板
- 查看是否有请求失败（红色标记）
- 检查响应状态码（应该是 200）
- 查看响应内容是否正常

### 3. 清除缓存和存储
```javascript
// 在控制台执行
// 1. 清除所有缓存
caches.keys().then(names => names.forEach(name => caches.delete(name)));

// 2. 清除本地存储
localStorage.clear();
sessionStorage.clear();

// 3. 刷新页面
location.reload();
```

### 4. 检查 Service Worker
```javascript
// 在控制台执行
// 1. 检查 Service Worker 状态
navigator.serviceWorker.getRegistrations().then(registrations => {
  console.log('Registered SWs:', registrations);
});

// 2. 注销所有 Service Worker
navigator.serviceWorker.getRegistrations().then(registrations => {
  registrations.forEach(reg => reg.unregister());
});
```

### 5. 检查编译错误
```bash
# 在项目目录运行
cd frontend
pnpm run build

# 查看是否有编译错误
# 常见错误：
# - TypeScript 类型错误
# - 缺少依赖
# - 语法错误
```

### 6. 检查运行时日志
```bash
# 开发服务器日志
cd frontend
pnpm run dev

# 查看终端输出，关注：
# - 编译错误
# - 警告信息
# - 模块加载失败
```

## 常见问题和解决方案

### 问题 1: SyntaxError in dynamically imported module
**原因**：动态导入的模块包含语法错误或编译失败

**解决方案**：
1. 检查最近修改的文件
2. 确保所有文件语法正确
3. 删除 `.next` 目录并重新编译
```bash
rm -rf .next
pnpm run dev
```

### 问题 2: 页面一直显示"验证登录状态..."
**原因**：
- Zustand persist hydration 失败
- Session 检查请求超时
- 网络连接问题

**解决方案**：
1. 检查网络连接
2. 检查后端 API 是否正常运行
3. 清除 localStorage 中的认证数据
```javascript
localStorage.removeItem('auth-store');
```

### 问题 3: 资源 404 Not Found
**原因**：
- 文件路径错误
- 构建过程中文件丢失
- 静态资源未正确部署

**解决方案**：
1. 检查 `public` 目录中的文件
2. 确保文件路径使用 `/` 开头（相对于 public 目录）
3. 重新构建项目

### 问题 4: CORS 错误
**原因**：后端 API 跨域配置问题

**解决方案**：
1. 检查 `next.config.mjs` 中的代理配置
2. 确保后端允许前端域名的跨域请求
3. 检查环境变量配置

## 监控和日志

### 前端日志关键字
- `[Global]`: 全局错误处理器
- `[AuthGuard]`: 认证守卫
- `[DevTracker]`: 开发环境追踪器
- `[SW]`: Service Worker

### 查看日志
```javascript
// 启用详细日志（开发环境）
localStorage.setItem('debug', 'true');

// 过滤特定日志
// 在 Console 中使用 filter 功能，输入上述关键字
```

## 预防措施

### 1. 代码提交前检查
```bash
# 运行类型检查
pnpm run type-check  # 需要在 package.json 中配置

# 运行构建测试
pnpm run build

# 启动生产模式测试
pnpm run start
```

### 2. 定期清理
```bash
# 清理依赖
rm -rf node_modules
pnpm install

# 清理构建缓存
rm -rf .next
rm -rf out
```

### 3. 监控关键指标
- 页面加载时间
- 资源加载成功率
- 错误发生频率
- 用户留存率

## 技术债务和改进建议

### 短期改进
- [ ] 添加性能监控（如 Web Vitals）
- [ ] 实现更详细的错误上报系统
- [ ] 添加 Sentry 或类似的错误追踪服务

### 中期改进
- [ ] 实现增量加载和代码分割
- [ ] 优化首屏加载时间
- [ ] 添加 PWA 支持（完整的离线能力）

### 长期改进
- [ ] 实现预加载和预渲染
- [ ] 添加 CDN 加速
- [ ] 实现智能降级策略

## 联系支持

如果以上方法都无法解决问题：
1. 收集错误信息（控制台截图、Network 日志）
2. 记录复现步骤
3. 提供浏览器版本和操作系统信息
4. 联系技术团队
